(function(){gmath={version:"0.0.1"};gmath.expressions={};(function(){var b32=4294967296,f=15,b=[];str=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function uid(){var i=0;var r=Math.random()*b32;b[i++]=str[r&f];b[i++]=str[r>>>4&f];b[i++]=str[r>>>8&f];b[i++]=str[r>>>12&f];b[i++]=str[r>>>16&f];b[i++]=str[r>>>20&f];b[i++]=str[r>>>24&f];b[i++]=str[r>>>28&f];r=Math.random()*b32;b[i++]=str[r&f];b[i++]=str[r>>>4&f];b[i++]=str[r>>>8&f];b[i++]=str[r>>>12&f];b[i++]=str[r>>>16&f];b[i++]=str[r>>>20&f];b[i++]=str[r>>>24&f];b[i++]=str[r>>>28&f];return"_"+b.join("")}gmath.uid=uid})();gmath.inherit=function(base,sub){var origProto=sub.prototype;sub.prototype=Object.create(base.prototype);for(var key in origProto){sub.prototype[key]=origProto[key]}sub.prototype.constructor=sub;Object.defineProperty(sub.prototype,"constructor",{enumerable:false,value:sub})};gmath.extend=function(a,b){if(typeof b==="object")for(var key in b)a[key]=b[key];return a};gmath.array={};gmath.array.containsAll=function(a,b){if(b.length>a.length)return false;for(var i=0;i<b.length;i++)if(a.indexOf(b[i])===-1)return false;return true};gmath.array.isPermutation=function(a,b){if(b.length!==a.length)return false;for(var i=0;i<b.length;i++)if(a.indexOf(b[i])===-1)return false;return true};gmath.array.mergedNew=function(a,b){var c=a.slice();for(var i=0;i<b.length;i++)if(a.indexOf(b[i])===-1)c.push(b[i]);return c};gmath.array.xor=function(a,b){var c=[];for(var i=0;i<a.length;i++)if(b.indexOf(a[i])===-1)c.push(a[i]);for(var i=0;i<b.length;i++)if(a.indexOf(b[i])===-1)c.push(b[i]);return c};gmath.getURLParameter=function(name){var val=RegExp(name+"="+"(.+?)(&|$)").exec(location.search);return val?decodeURIComponent(val[1]):null};if(typeof Object.create!=="function"){Object.create=function(o){function F(){}F.prototype=o;return new F}}if(!Array.isArray){Array.isArray=function(vArg){return Object.prototype.toString.call(vArg)==="[object Array]"}}var Tree={version:"1.2.2x"};if(typeof exports!="undefined"){exports.Tree=Tree}Tree.parse=function(str){var top=new Tree.Node;var curr=top.append(new Tree.Node);var i;curr.value="";for(i=0;i<str.length;i++){var c=str[i];if(c=="["){curr=curr.append(new Tree.Node);curr.value=""}else if(c=="]"){curr=curr.parent;if(curr===top)throw"parse error"}else if(c==","){curr=curr.parent.append(new Tree.Node);curr.value=""}else{curr.value+=c}}for(i=0;i<top.children.length;i++)top.children[i].parent=null;if(top.children.length===1)return top.children[0];return top.children};Tree.stringify=function(nodes){var f=function(node){var str="";if("value"in node)str+=node.value;if(node.children&&node.children[0]){str+="["+node.children.map(f).join(",")+"]"}return str};if(!Array.isArray(nodes))nodes=[nodes];return nodes.map(f).join(",")};(function(){var b32=4294967296,f=15,b=[],str=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function uid(){var i=0;var r=Math.random()*b32;b[i++]=str[r&f];b[i++]=str[r>>>4&f];b[i++]=str[r>>>8&f];b[i++]=str[r>>>12&f];b[i++]=str[r>>>16&f];b[i++]=str[r>>>20&f];b[i++]=str[r>>>24&f];b[i++]=str[r>>>28&f];r=Math.random()*b32;b[i++]=str[r&f];b[i++]=str[r>>>4&f];b[i++]=str[r>>>8&f];b[i++]=str[r>>>12&f];b[i++]=str[r>>>16&f];b[i++]=str[r>>>20&f];b[i++]=str[r>>>24&f];b[i++]=str[r>>>28&f];return b.join("")}Tree.uid=uid})();Tree.clone=function(nodes,keep_ids){var f=function(node){var i;var cloned=new node.constructor;for(var key in node){if(key[0]!=="_")cloned[key]=node[key]}delete cloned.ls;delete cloned.rs;delete cloned.parent;if(node.id&&!keep_ids)cloned.id=Tree.uid();if(node.children){cloned.children=[];for(i=0;i<node.children.length;i++){cloned.children.push(f(node.children[i]));cloned.children[i].parent=cloned}for(i=0;i<node.children.length;i++){cloned.children[i].ls=cloned.children[i-1];cloned.children[i].rs=cloned.children[i+1]}}return cloned};if(!Array.isArray(nodes))return f(nodes);var cloned=nodes.map(f);if(nodes.length>1)for(var i=0;i<nodes.length;i++){if(i>0&&nodes[i].ls===nodes[i-1])cloned[i].ls=cloned[i-1];if(i<nodes.length-1&&nodes[i].rs===nodes[i+1])cloned[i].rs=cloned[i+1]}return cloned};Tree.get_mapping_between=function(source_tree,target_tree,options){options=gmath.extend({skip:[]},options);if(!Array.isArray(options.skip))options.skip=[options.skip];var map={};function no_skip(target_node){return options.skip.indexOf(target_node)===-1}function mapfn(source,target){if(!no_skip(target))throw"tree structures don't match";if(source.id in map)throw"duplicate id in source tree";map[source.id]=[target];var target_childs=target.children.filter(no_skip);if(source.children.length!==target_childs.length){if(!source.has_children())map[source.id]=target.filter(no_skip);else if(target_childs.length===0)source.for_each(function(s){map[s.id]=[target]});else throw"tree structures don't match"}else{for(var i=0;i<source.children.length;i++)mapfn(source.children[i],target_childs[i])}}if(Array.isArray(source_tree)){target_tree=target_tree.filter(no_skip);if(source_tree.length!==target_tree.length)throw"tree structures don't match";for(var i=0;i<source_tree.length;i++)mapfn(source_tree[i],target_tree[i])}else mapfn(source_tree,target_tree);return map};Tree.get_1to1_mapping_between=function(source_tree,target_tree){var map={};function mapfn(source,target){if(source.id in map)throw"duplicate id in source tree";map[source.id]=target;if(source.children.length!==target.children.length)throw"tree structures don't match";for(var i=0;i<source.children.length;i++)mapfn(source.children[i],target.children[i])}if(Array.isArray(source_tree)){if(source_tree.length!==target_tree.length)throw"tree structures don't match";for(var i=0;i<source_tree.length;i++)mapfn(source_tree[i],target_tree[i])}else mapfn(source_tree,target_tree);return map};Tree.nodes_to_range=function(nodes){var N=nodes.length;if(N===0)return[];if(N===1)return[nodes[0]];var tree=nodes[0];while(tree.parent)tree=tree.parent;var paths=nodes.map(function(node){return Tree.get_path(node)});var same=function(len){var val=paths[0][len];for(var i=0;i<paths.length;i++){if(paths[i].length<=len+1)return false;if(paths[i][len]!==val)return false}return true};var cpl=0;while(same(cpl))cpl++;var cca=Tree.get_child(paths[0].slice(0,cpl),tree);var rm=-1,lm=N,i;for(i=0;i<N;i++){var n=Tree.get_child(paths[i].slice(0,cpl+1),tree);var idx=cca.children.indexOf(n);if(idx>rm)rm=idx;if(idx<lm)lm=idx}var range=[];for(i=lm;i<=rm;i++)range.push(cca.children[i]);return range};Tree.insert=function(parent,idx,node){node.ls=parent.children[idx-1];if(parent.children[idx-1])parent.children[idx-1].rs=node;node.rs=parent.children[idx];if(parent.children[idx])parent.children[idx].ls=node;node.parent=parent;parent.children.splice(idx,0,node);return node};Tree.insert_range=function(parent,idx,nodes){var N=nodes.length;if(N===0)return;nodes[0].ls=parent.children[idx-1];if(parent.children[idx-1])parent.children[idx-1].rs=nodes[0];nodes[N-1].rs=parent.children[idx];if(parent.children[idx])parent.children[idx].ls=nodes[N-1];for(var i=0;i<N;i++)nodes[i].parent=parent;parent.children=parent.children.slice(0,idx).concat(nodes,parent.children.slice(idx));return nodes};Tree.append_range=function(parent,nodes){var N=nodes.length;if(N===0)return;var last=parent.children[parent.children.length-1];if(last)last.rs=nodes[0];nodes[0].ls=last;nodes[N-1].rs=null;for(var i=0;i<N;i++)nodes[i].parent=parent;parent.children=parent.children.concat(nodes);return nodes};Tree.append=function(parent,node){var last=parent.children[parent.children.length-1];if(last)last.rs=node;node.ls=last;node.rs=null;node.parent=parent;parent.children.push(node);return node};Tree.remove=function(node){var idx;var siblings=node.parent.children;idx=siblings.indexOf(node);if(siblings[idx-1])siblings[idx-1].rs=node.rs;if(siblings[idx+1])siblings[idx+1].ls=node.ls;siblings.splice(idx,1);return idx};Tree.remove_range=function(nodes){var N=nodes.length;if(N===0)return;var siblings=nodes[0].parent.children;var idx=siblings.indexOf(nodes[0]);if(siblings[idx-1])siblings[idx-1].rs=nodes[N-1].rs;if(siblings[idx+N])siblings[idx+N].ls=nodes[0].ls;siblings.splice(idx,N);return idx};Tree.replace=function(n1,n2){if(n2.parent)Tree.remove(n2);var idx=Tree.remove(n1);return Tree.insert(n1.parent,idx,n2)};Tree.switch_siblings=function(n1,n2){if(n1.parent!=n2.parent)throw"Called switch_siblings on nodes that are no siblings!";var p=n1.parent;var idx1=p.children.indexOf(n1);var idx2=p.children.indexOf(n2);p.children[idx1]=n2;p.children[idx2]=n1;var h;if(n1.rs==n2){if(n1.ls)n1.ls.rs=n2;if(n2.rs)n2.rs.ls=n1;n1.rs=n2.rs;n2.ls=n1.ls;n1.ls=n2;n2.rs=n1}else if(n1.ls==n2){if(n1.rs)n1.rs.ls=n2;if(n2.ls)n2.ls.rs=n1;n1.ls=n2.ls;n2.rs=n1.rs;n1.rs=n2;n2.ls=n1}else{if(n1.ls)n1.ls.rs=n2;if(n1.rs)n1.rs.ls=n2;if(n2.ls)n2.ls.rs=n1;if(n2.rs)n2.rs.ls=n1;h=n1.ls;n1.ls=n2.ls;n2.ls=h;h=n1.rs;n1.rs=n2.rs;n2.rs=h}};Tree.validate=function(nodes){var check=function(node,parent){if(node.parent!=parent)throw"wrong parent information";if(node.children){for(var i=0;i<node.children.length;i++){var child=node.children[i];if(child.ls!=node.children[i-1])throw"wrong ls information";if(child.rs!=node.children[i+1])throw"wrong rs information";check(child,node)}}};if(!Array.isArray(nodes))nodes=[nodes];for(var i=0;i<nodes.length;i++)check(nodes[i],null)};Tree.get_child=function(path,node){for(var i=0;i<path.length;i++){if(!node.children||node.children.length<=path[i])throw"invalid path";node=node.children[path[i]]}return node};Tree.get_path=function(node){var path=[];while(node.parent){path.unshift(node.parent.children.indexOf(node));node=node.parent}return path};Tree.for_each=function(f,node){var nodes=Array.isArray(node)?node:[node];var traverse=function(node){f(node);if(node.children)for(var i=0;i<node.children.length;i++)traverse(node.children[i])};for(var i=0;i<nodes.length;i++)traverse(nodes[i])};Tree.map=function(f,node){var nodes=Array.isArray(node)?node:[node];var res=[];var traverse=function(node){res.push(f(node));if(node.children)for(var i=0;i<node.children.length;i++)traverse(node.children[i])};for(var i=0;i<nodes.length;i++)traverse(nodes[i]);return res};Tree.filter=function(selector,node){var result=[];var nodes=Array.isArray(node)?node:[node];var f=function(node){if(selector(node))result.push(node);if(node.children)for(var i=0;i<node.children.length;i++)f(node.children[i])};for(var i=0;i<nodes.length;i++)f(nodes[i]);return result};Tree.filterRange=function(selector,node){var result=[];var nodes=Array.isArray(node)?node:[node];var f=function(nodes,idx){var range=[];for(var i=idx;i<nodes.length;i++){range.push(nodes[i]);if(selector(range))result.push(range.slice())}if(nodes[idx].children)for(var i=0;i<nodes[idx].children.length;i++)f(nodes[idx].children,i)};for(var i=0;i<nodes.length;i++)f(nodes,i);return result};Tree.select_all=function(node){return Tree.filter(function(){return true},node)};Tree.select_first=function(selector,node){var f=function(node){var curr=node;for(;;){if(selector(curr))return curr;if(curr.children&&curr.children[0]){curr=curr.children[0];continue}if(curr===node)return null;while(!curr.rs){curr=curr.parent;if(curr===node)return null}curr=curr.rs}};var nodes=Array.isArray(node)?node:[node];for(var i=0;i<nodes.length;i++){var n=f(nodes[i]);if(n)return n}return null};Tree.get_cca=function(nodes){var paths=nodes.map(function(node){return Tree.get_path(node)});var same=function(len){var val=paths[0][len];for(var i=0;i<paths.length;i++){if(paths[i].length<=len+1)return false;if(paths[i][len]!==val)return false}return true};var cpl=0;while(same(cpl))cpl++;var d=paths[0].length-cpl,n=nodes[0];for(var i=0;i<d;i++)n=n.parent;return n};Tree.get_leaf_nodes=function(node){return Tree.filter(function(n){return!(n.children&&n.children.length)},node)};Tree.is_range=function(nodes){for(var i=1;i<nodes.length;i++){if(nodes[i-1].rs!==nodes[i])return false}return true};Tree.is_root=function(node){return!node.parent};Tree.get_root=function(node){while(node.parent)node=node.parent;return node};Tree.get_by_value=function(value,node){return Tree.filter(function(n){return n.value===value},node)};Tree.get_by_id=function(id,node){return Tree.select_first(function(n){return n.id===id},node)};Tree.Node=function(){this.children=[];this.parent=null;this.ls=null;this.rs=null;this.id=Tree.uid()};Tree.Node.prototype.stringify=function(){return Tree.stringify(this)};Tree.Node.prototype.clone=function(keep_ids){return Tree.clone(this,keep_ids)};Tree.Node.prototype.get_mapping_to=function(target,options){return Tree.get_mapping_between(this,target,options)};Tree.Node.prototype.get_1to1_mapping_to=function(target){return Tree.get_1to1_mapping_between(this,target)};Tree.Node.prototype.insert=function(idx,node){return Tree.insert(this,idx,node)};Tree.Node.prototype.insert_range=function(idx,nodes){return Tree.insert_range(this,idx,nodes)};Tree.Node.prototype.append_range=function(nodes){return Tree.append_range(this,nodes)};Tree.Node.prototype.append=function(node){return Tree.append(this,node)};Tree.Node.prototype.remove=function(){return Tree.remove(this)};Tree.Node.prototype.remove_range=function(nodes){return Tree.remove_range(nodes)};Tree.Node.prototype.replace_with=function(other){return Tree.replace(this,other)};Tree.Node.prototype.switch_with_sibling=function(other){return Tree.switch_siblings(this,other)};Tree.Node.prototype.validate=function(){return Tree.validate(this)};Tree.Node.prototype.get_child=function(path){return Tree.get_child(path,this)};Tree.Node.prototype.get_path=function(){return Tree.get_path(this)};Tree.Node.prototype.for_each=function(f){return Tree.for_each(f,this)};Tree.Node.prototype.map=function(f){return Tree.map(f,this)};Tree.Node.prototype.filter=function(f){return Tree.filter(f,this)};Tree.Node.prototype.filterRange=function(f){return Tree.filterRange(f,this)};Tree.Node.prototype.select_all=function(){return Tree.select_all(this)};Tree.Node.prototype.select_first=function(f){return Tree.select_first(f,this)};Tree.Node.prototype.get_leaf_nodes=function(){return Tree.get_leaf_nodes(this)};Tree.Node.prototype.is_root=function(){return Tree.is_root(this)};Tree.Node.prototype.get_root=function(){return Tree.get_root(this)};Tree.Node.prototype.get_by_value=function(value){return Tree.get_by_value(value,this)};Tree.Node.prototype.get_by_id=function(id){return Tree.get_by_id(id,this)};Tree.Node.prototype.has_children=function(){return this.children&&this.children.length>0};var asEventListener=function(){this.addEventListener=function(type,listener){var key="__on"+type;if(!this[key])this[key]=[];if(this[key].indexOf(listener)!=-1)return;this[key].push(listener)};this.removeEventListener=function(type,listener){var key="__on"+type;if(!this[key])return;var idx=this[key].indexOf(listener);if(idx!==-1)this[key].splice(idx,1)};this.dispatchEvent=function(event,sender_id){var key="__on"+event.type;if(!this[key])return;event.target=this;event.sender_id=sender_id;for(var i=0;i<this[key].length;i++)this[key][i](event)};return this};gmath.ChangeEvent=function(action,preview,intervention){this.type="change";this.term=action&&action.newTree&&action.newTree.to_ascii();this.action=action;this.preview=preview;this.intervention=intervention};gmath.MistakeEvent=function(){this.type="mistake"};gmath.InterventionEvent=function(observedVariable,newValue,intervention){this.type="intervention";this.observedVariable=observedVariable;this.newValue=newValue;this.intervention=intervention;return this};gmath.WatchEvent=function(observedVariable,watchedValue,intervention){this.type="watchEvent";this.observedVariable=observedVariable;this.watchedValue=watchedValue;this.intervention=intervention;return this};var tokenize=function(str){var r_number=new RegExp("^\\s*([0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?)");var r_name=new RegExp("^\\s*([a-zA-Z])");var r_operator=new RegExp("^\\s*(\\*\\*|[-+*/=();,^{}])");var r_latex_command=new RegExp("^\\s*(\\\\[^A-Za-z0-9\\s]|\\\\[A-Za-z]+)");var tokens=[];var l=0;if(str){l=str.length}for(var i=0;i<l;){var s=str.substr(i);var m;if(m=r_number.exec(s)){tokens.push({type:"number",value:parseFloat(m[1]),from:i+(m[0].length-m[1].length),to:i+m[0].length});i+=m[0].length}else if(m=r_name.exec(s)){tokens.push({type:"name",value:m[1],from:i+(m[0].length-m[1].length),to:i+m[0].length});i+=m[0].length}else if(m=r_operator.exec(s)){tokens.push({type:"operator",value:m[1],from:i+(m[0].length-m[1].length),to:i+m[0].length});i+=m[0].length}else if(m=r_latex_command.exec(s)){tokens.push({type:"latex",value:m[1],from:i+(m[0].length-m[1].length),to:i+m[0].length});i+=m[0].length}else{throw"can't tokenize '"+s+"'"}}return tokens};var TimeTree=function(mathObject){Tree.Node.call(this);this.append(new TimeState(mathObject,this));this.scale=1;this.watchedAspectInfos=[]};gmath.TimeTree=TimeTree;gmath.inherit(Tree.Node,TimeTree);TimeTree.prototype.root=function(){return this.children[0]};TimeTree.prototype.init=function(){var eq=this.root().mathObject;eq.addEventListener("change",this.catch_changed_event.bind(this));eq.addEventListener("end-of-interaction",this.finishPreviewActionSequence.bind(this));return this};TimeTree.prototype.catch_changed_event=function(event){this.update(event.sender_id,event.action,event.preview)};TimeTree.prototype.update=function(sender_id,action,preview){if(!action)return;if(preview){if(!action.tree)throw"must set action.tree for preview actions";var tstate=action.tree.timeState;if(!tstate._prePreviewMathObject)console.warn("should set prePreviewMathObject before any in-place preview actions");tstate.previewActionQueue.push(action);this.changed(sender_id,action,true);return}var oldTree=action.oldTree,newTree=action.newTree;if(!oldTree||!newTree)throw"action must link to oldTree and newTree if its not a preview action";if(action.oldTree===action.newTree){this.changed(sender_id,action,false);return}if(oldTree.timeState){oldTree.removeEventListener("change",this.catch_changed_event);newTree.addEventListener("change",this.catch_changed_event.bind(this));oldTree.removeEventListener("end-of-interaction",this.finishPreviewActionSequence);newTree.addEventListener("end-of-interaction",this.finishPreviewActionSequence.bind(this));var newState=new TimeState(newTree,this),oldState=oldTree.timeState;Tree.append(oldState,newState);newState.generatingAction=action;action.updateNodesFromFutureAndPast();this.changed(sender_id,action,false)}else{var newState=newTree.timeState,oldState=new TimeState(oldTree,this);newState.replace_with(oldState);oldState.append(newState);oldState.generatingAction=newState.generatingAction;newState.generatingAction=action;if(oldState.generatingAction)oldState.generatingAction.updateNodesFromFutureAndPast();newState.generatingAction.updateNodesFromFutureAndPast();this.changed(sender_id,action,false)}};TimeTree.getComposedActionName=function(actions){if(actions.length==1)return actions[0].name;if(actions.filter(function(i){return i.name=="invert terms across equation"}).length%2==1){return"invert terms across equation"}else if(actions.filter(function(i){return i.name=="commute terms"}).length==actions.length){return"commute terms"}else{return"multiple operations"}};TimeTree.prototype.finishPreviewActionSequence=function(event){var presentTree=event.mathObject,tstate=presentTree.timeState;if(tstate.previewActionQueue.length>0){var name=TimeTree.getComposedActionName(tstate.previewActionQueue);var action=Action.createComposedAction(tstate.previewActionQueue,name);action.oldTree=tstate._prePreviewMathObject;action.newTree=presentTree;this.update(event.sender_id,action,false)}tstate._prePreviewMathObject=null;tstate.previewActionQueue=[]};TimeTree.prototype.changed=function(sender_id,action,preview){this.dispatchEvent(new gmath.ChangeEvent(action,preview),sender_id)};TimeTree.prototype.catch_intervention_event=function(event){var intervene_rec=function(state){if(state.children.length>0){state.children.map(function(childState){intervene_rec(childState)})}return state.mathObject.updateFromFuture(event)};if(event.type=="changeNumber")intervene_rec(this.root());this.reportWatchedAspects();this.dispatchEvent(event)};TimeTree.prototype.catchPastEvent=function(event){var observe_rec=function(state){var retVal=state.mathObject.updateFromPast(event);if(state.children.length>0){state.children.map(function(childState){observe_rec(childState)})}return retVal};observe_rec(this.root());this.dispatchEvent(gmath.InterventionEvent(event))};TimeTree.prototype.watch=function(aspect,name,timestate){var mathObject=timestate.mathObject;if(aspect&&mathObject.get_child(aspect)){this.watchedAspectInfos.push({name:name,aspect:aspect,timestate:timestate});return true}else{console.log("An EqTree was asked to watch this ",aspect,"but it only watches values of nodes at legal paths");return false}};TimeTree.prototype.present=function(){var tstate=this.root();while(tstate.children&&tstate.children.length>0)tstate=tstate.children[0];return tstate};TimeTree.prototype.reportWatchedAspects=function(){for(i=0;i<this.watchedAspectInfos.length;i++){var info=this.watchedAspectInfos[i];var mathObject=info.timestate.mathObject;var newAspect=mathObject.reportAspect(info.aspect);var event=gmath.WatchEvent(info.name,newAspect);this.dispatchEvent(event)}};TimeTree.prototype.immediatePast=function(state){var presentState=state?state:this.present();return presentState.prePreviewMathObject?presentState.prePreviewMathObject:presentState.parent};asEventListener.call(TimeTree.prototype);var TimeState=function(mathObject,timeTree){Tree.Node.call(this);this.mathObject=mathObject;this.timeTree=timeTree;this.mathObject.timeState=this;this.generatingAction=null;this.previewActionQueue=[];this._prePreviewMathObject=null};gmath.inherit(Tree.Node,TimeState);TimeState.prototype.prePreviewMathObject=function(val){if(arguments.length==0)return this._prePreviewMathObject;this._prePreviewMathObject=val;return this};if(typeof exports!="undefined"){exports.Tree=Tree}var EqTree=function(eq,options){Tree.Node.call(this);this.options=gmath.extend({hide_mult_op:true,hide_leading_op:true,capabilities:["num","var","sym","brackets","sign","add-sub","mul-div","exponent","equals"]},options);this.hide_rules=[];this.init_hide_rules();this.watchedAspects=[];this.parser=options&&options.parser||AlgebraParser.apply(this,this.options.capabilities);this.parseAndSet(eq)};gmath.inherit(Tree.Node,EqTree);gmath.EqTree=EqTree;EqTree.prototype.move_actions=[];if(typeof exports!=="undefined")exports.EqTree=EqTree;asEventListener.call(EqTree.prototype);EqTree.is_top_most=function(node){return!node.parent||node.parent instanceof EqTree};EqTree.prototype.init_hide_rules=function(){for(var i=0;i<this.options.capabilities.length;i++){var e=gmath.expressions[this.options.capabilities[i]];if(e.hide_rule)this.hide_rules.push(e.hide_rule)}};EqTree.prototype.parseAndSet=function(eq,keep_brackets){this.children=[];var expr=this.parser.parse(eq);if(!expr)return false;Tree.append(this,expr);if(!keep_brackets)this.remove_brackets();this.hide_nodes();this.changed(null,{newTree:this},false);return true};EqTree.prototype.parse=function(eq,keep_brackets){var expr=this.parser.parse(eq);if(!expr)return null;if(!keep_brackets)this.remove_brackets([expr]);return expr};EqTree.prototype.to_ascii=function(){return this.children.map(function(n){return n.to_ascii()}).join("")};EqTree.prototype.to_latex=function(){return this.children.map(function(n){return n.to_latex()}).join("")};EqTree.prototype.changed=function(sender_id,action,preview){this.dispatchEvent(new gmath.ChangeEvent(action,preview),sender_id)};EqTree.prototype.finishPreviewActionSequence=function(){this.dispatchEvent({type:"end-of-interaction",mathObject:this})};EqTree.prototype.watch=function(watchedAspect,name){this.timeState.timeTree.watch(watchedAspect,name,this.timeState)};EqTree.prototype.reportIntervention=function(intervention){if(!this.timeState)return;this.timeState.timeTree.catch_intervention_event(intervention)};EqTree.prototype.reportAspect=function(aspect){return Tree.get_child(aspect,this)};EqTree.prototype.updateFromFuture=function(intervention){Tree.select_all(this.root()).map(function(node){return node.nodeFromFuture?node.nodeFromFuture(intervention):node})};EqTree.prototype.updateFromPast=function(event){Tree.select_all(this.root()).map(function(node){return node.nodeFromPast?node.nodeFromPast(event):node})};EqTree.prototype.observeEvent=function(event){var nodes=Tree.select_all(this);nodes.map(function(node){if(node.nodeFromPast){node.value=node.nodeFromPast(event).value}return node});return this};EqTree.prototype.mistake=function(){this.dispatchEvent(new gmath.MistakeEvent)};EqTree.prototype.root=function(){return this.children[0]};EqTree.prototype.is_group=function(){return false};EqTree.prototype.clean_up=function(){};EqTree.prototype.numeric_value=function(n,val,sender_id){var p=n.parent,v;if(n instanceof Num&&p&&(p.is_group("sign")||p.is_group("add")||p.is_group("sub")))n=p;var v=Num.get_value(n);if(isNaN(v))return NaN;if(arguments.length<2)return v;var was_positive=v>0||v==0&&(n instanceof Num||n.is_group("add"));var becomes_positive=val>0||val==0&&(n instanceof Num||n.is_group("add"));if(was_positive&&!becomes_positive){if(n.is_group("add")){n.invert()}else{var idx=Tree.remove(n);var sign=new Sign(n);sign.children[0].no_anim=true;Tree.insert(p,idx,sign);sign.selected=n.selected;n=sign}}else if(!was_positive&&becomes_positive){if(n.is_group("sign")){var num=n.children[1];Tree.replace(n,num);n.children[0].no_anim=true;num.selected=n.selected;n=num}else if(n.is_group("sub")){n.invert();this.hide_nodes()}}if(n.is_group())n.children[1].value=Math.abs(val);else n.value=Math.abs(val);this.changed(sender_id);return n};EqTree.prototype.remove_brackets=function(nodes){Tree.for_each(function(n){if(n.parent.is_group("brackets")&&n.is_group("fraction"))Tree.replace(n.parent,n)},nodes||this.children)};EqTree.prototype.clone=function(){var eq=new EqTree(null,this.options);Tree.append(eq,Tree.clone(this.children[0],true));return eq};EqTree.prototype.process_operator=function(op,callback){if(!op.getBestMatchingAction&&op.parent)op=op.parent;if(!op.getBestMatchingAction){if(callback)callback(false);return false}var action=op.getBestMatchingAction();this.performAction(action,{actor:op},callback,"process operator")};EqTree.prototype.performAction=function(action,settings,callback,change_event_type){var self=this;settings=settings||{};var internal_callback=function(action){if(!action){self.mistake();if(callback)callback(false);return}var newTree=action.newTree||self;newTree.hide_nodes();self.changed(null,action,false);self.reportIntervention({type:change_event_type});if(callback)callback(true)};if(!action)internal_callback(false);else if(this.timeState&&!settings.do_in_place){action.createAndRun(this,settings,internal_callback)}else action.createAndDoInPlace(this,settings,internal_callback)};EqTree.prototype.hide_nodes=function(){return this.hideNodesAction.doInPlace(this)};EqTree.prototype.performSplitAction=function(nodes){var splitter=new SplitHandler;splitter.split(this,nodes||this.children)};EqTree.prototype.performPreviewAction=function(action){if(this.timeState&&!this.timeState.prePreviewMathObject()){this.timeState.prePreviewMathObject(this.clone())}action.doInPlace();action.tree=this;this.hide_nodes();this.changed(null,action,true);this.reportIntervention({type:action.name})};EqTree.prototype.getMoveActions=function(ns){if(ns.length===0)return[];var actions=[];for(var i=0;i<this.move_actions.length;i++){actions=actions.concat(this.move_actions[i].getAllAvailableActions(ns))}return actions};EqTree.prototype.make_flat=function(){var ns=Tree.get_leaf_nodes(this);var g=new Group("flat",0);g.commutative=true;ns.forEach(function(n){if(n.hidden)return;n.commutative=true;n.associative=true;Tree.append(g,n)});this.children=[];Tree.append(this,g);this.changed()};var AlgebraParser=function(){var symbol_table={};var token;var tokens;var token_nr;var scope;var itself=function(){return this};var error=function(message,obj){obj=obj||this;obj.name="SyntaxError";obj.message=message;throw obj};var Scope=function(){this.def={}};Scope.prototype.find_or_define=function(tok){var o=this.def[tok.value];if(!o||typeof o=="function")o=symbol_table[tok.value];if(o&&typeof o!=="function")return o;o=Object.create(symbol_table["(name)"]);o.lpb=0;this.def[tok.value]=o;return o};var advance=function(id,optional){var a,o,t,v;if(id&&token.id!==id){if(optional)return;else error("Expected '"+id+"'.",token)}if(token_nr>=tokens.length){token=symbol_table["(end)"];return}t=tokens[token_nr];token_nr+=1;v=t.value;a=t.type;if(a==="name"){o=scope.find_or_define(t)}else if(a==="operator"){o=symbol_table[v];if(!o){error("Unknown operator.",t)}}else if(a==="latex"){o=symbol_table[v];if(!o){error("Unknown latex command.",t)}}else if(a==="string"||a==="number"){o=symbol_table["(number)"];a="number"}else{error("Unexpected token.",t)}token=Object.create(o);token.from=t.from;token.to=t.to;token.value=v;token.type=a;return token};var regress=function(t){token_nr--;token=t};var expression=function(rbp,_token){var left;var t=_token||token;if(!_token)advance();left=t.nud();while(rbp<token.lbp){t=token;advance();left=t.led(left)}return left};var original_symbol={nud:function(){error("Undefined.",this)},led:function(left){error("Missing operator.",this)}};var symbol=function(id,bp){var s=symbol_table[id];bp=bp||0;if(s){if(bp>s.lbp){s.lbp=bp}}else{s=Object.create(original_symbol);s.id=s.value=id;s.lbp=bp;symbol_table[id]=s}return s};symbol("(end)");var parse=function(source){tokens=tokenize(source);if(tokens.length==0)return null;scope=new Scope;token_nr=0;advance();var e=expression(0);advance("(end)");return e};var core={};core.parse=parse;core.parseExpression=expression;core.advance=advance;core.regress=regress;core.registerSymbol=symbol;for(var i=0;i<arguments.length;i++){var e=gmath.expressions[arguments[i]];if(e&&e.registerAtParser)e.registerAtParser(core)}return core};gmath.AlgebraParser=AlgebraParser;var Num=function(value){Tree.Node.call(this);if(typeof value!=="number")value=0;if(value>=0)this.value=value;else return new Sign(new Num(-value))};gmath.inherit(Tree.Node,Num);Num.prototype.nodeFromPast=function(event){return this};Num.prototype.nodeFromFuture=function(intervention){var currTimeState=Tree.get_root(this).timeState;if(currTimeState.children.length==0){return this}else{if(currTimeState.children[0].generatingAction.length){console.log("Because action composition is not working, previewed actions that compose naturally cannot be tracked through interventions.")}else{var futureNodes=currTimeState.children[0].generatingAction.mapNodes([this]);if(futureNodes.length==1){this.matchFutureNode(futureNodes[0]);return this}else{console.warn("not implemented yet");return this}}}};Num.prototype.matchFutureNode=function(futureNode){var tree=Tree.get_root(this);var futureTree=Tree.get_root(futureNode);tree.numeric_value(this,futureTree.numeric_value(futureNode))};Num.is_num=function(term){return term instanceof Num||term.is_group("sign")&&term.children[1]instanceof Num};Num.get_value=function(term){if(!term)return NaN;if(term instanceof Num)return term.value;if(term.is_group("sign")&&term.children[1]instanceof Num)return-term.children[1].value;if(term.is_group("add")&&term.children[1]instanceof Num)return term.children[1].value;if(term.is_group("sub")&&term.children[1]instanceof Num)return-term.children[1].value;return NaN};Num.prototype.to_string=function(){var s=this.value.toFixed(2);var zeros=0;for(var i=s.length-1;i>0;i--){if(s[i]=="0")zeros++;else if(s[i]=="."){zeros++;break}else break}return s.substring(0,s.length-zeros)};Num.prototype.to_ascii=Num.prototype.to_string;Num.prototype.to_latex=Num.prototype.to_string;Num.prototype.is_group=function(){return false};Num.registerAtParser=function(parser){var num=parser.registerSymbol("(number)");num.nud=function(){return new Num(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.num=Num;var Sym=function(value){Tree.Node.call(this);this.value=value
};gmath.inherit(Tree.Node,Sym);Sym.mappings={"-":"−","*":"·","/":"·","//":""};Sym.prototype.to_string=function(){if(this.parent&&this.parent.is_group("sign"))return"-";if(this.value in Sym.mappings)return Sym.mappings[this.value];return this.value};Sym.prototype.to_ascii=function(){return this.value};Sym.prototype.to_latex=function(){if(this.value==="/")return"\\cdot ";if(this.value==="*")return"\\cdot ";if(this.value==="(")return"\\left(";if(this.value===")")return"\\right)";return this.value};Sym.prototype.is_group=function(){return false};gmath.expressions=gmath.expressions||{};gmath.expressions.sym=Sym;var Var=function(value){Tree.Node.call(this);this.value=value};gmath.inherit(Tree.Node,Var);Var.prototype.to_string=function(){return this.value};Var.prototype.to_ascii=Var.prototype.to_string;Var.prototype.to_latex=Var.prototype.to_string;Var.prototype.is_group=function(){return false};Var.registerAtParser=function(parser){var symbols={"(name)":"","\\alpha":"α","\\Alpha":"Α","\\beta":"β","\\Beta":"Β","\\gamma":"γ","\\Gamma":"Γ","\\delta":"δ","\\Delta":"Δ","\\epsilon":"ε","\\Epsilon":"Ε","\\zeta":"ζ","\\Zeta":"Ζ","\\eta":"η","\\Eta":"Η","\\theta":"θ","\\Theta":"Θ","\\iota":"ι","\\Iota":"Ι","\\kappa":"κ","\\Kappa":"Κ","\\lambda":"λ","\\Lambda":"Λ","\\mu":"μ","\\Mu":"Μ","\\nu":"ν","\\Nu":"Ν","\\xi":"ξ","\\Xi":"Ξ","\\omicron":"ο","\\Omicron":"Ο","\\pi":"π","\\Pi":"Π","\\rho":"ρ","\\Rho":"Ρ","\\sigma":"σ","\\Sigma":"Σ","\\tau":"τ","\\Tau":"Τ","\\upsilon":"υ","\\Upsilon":"Υ","\\phi":"φ","\\Phi":"Φ","\\chi":"χ","\\Chi":"Χ","\\psi":"ψ","\\Psi":"Ψ","\\omega":"ω","\\Omega":"Ω"};var nud=function(){if(this.type==="name")return new Var(this.value);else return new Var(symbols[this.value])};var led=function(left){var right=parser.parseExpression(MulDiv.prototype.bp,this);return MulDiv.createProduct(left,right)};for(var str in symbols){var variable=parser.registerSymbol(str,30);variable.nud=nud;variable.led=led}};gmath.expressions=gmath.expressions||{};gmath.expressions.var=Var;var Group=function(name,bp){Tree.Node.call(this);if(arguments.length>1)this.bp=bp;if(arguments.length>0)this.value=name};gmath.inherit(Tree.Node,Group);Group.prototype.to_ascii=function(){return this.children.map(function(c){if(c.is_group()&&c.commutative&&!c.ls&&c.associative)return c.children[1].to_ascii();return c.to_ascii()}).join("")};Group.prototype.to_latex=function(){return this.children.map(function(c){if(c.is_group()&&c.commutative&&!c.ls&&c.associative)return c.children[1].to_latex();return c.to_latex()}).join("")};Group.prototype.is_group=function(name){return name?this.value===name:true};Group.prototype.clean_up=function(){if(this.children.length==0){Tree.remove(this);return true}else{var changed=false;Tree.for_each(function(c){if(c.clean_up)changed=c.clean_up()||changed},this.children);return changed}};var asOperator=function(name,options){gmath.inherit(Group,this);this.prototype.bp=options.bp||0;this.prototype.associative=options.associative||false;this.prototype.commutative=options.commutative||false;this.prototype.has_inverse=options.has_inverse||false;this.prototype.inverse_group_name=options.inverse_group_name;this.prototype.group_name=options.group_name;this.prototype.group_class=options.group_class||null;this.prototype.value=name;this.prototype.action_handlers=[];this.prototype.vertical_notation=options.vertical_notation||false;this.prototype.add_action_handler=function(handler){if(this.action_handlers.indexOf(handler)==-1)this.action_handlers.push(handler)};this.prototype.getBestMatchingAction=function(){var best_action=null;for(var i=0;i<this.action_handlers.length;i++){var action=this.action_handlers[i];if(action instanceof Action){if(action.match(this)&&(best_action==null||action.priority>best_action.priority)){best_action=action}}else{console.warn("old action style not supported anymore",action)}}return best_action};this.prototype.createGroup=function(){if(this.group_class)return new this.group_class;else return new Group(this.group_name,this.bp)};this.createGroup=this.prototype.createGroup;this.prototype.getInverse=function(){return this.inverse&&gmath.expressions[this.inverse]};this.prototype.clean_up_commutative=function(){if(!this.ls&&!this.rs){var val=this.children[1];Tree.replace(this.parent,val);Brackets.handle(val);return true}if(this.merge_nested_group())return true};this.prototype.merge_nested_group=function(){if(this.associative&&this.children[1].is_group(this.group_name)){var top_g=this.parent;var bot_g=this.children[1];if(Tree.get_child([1,0,0],this).value===Tree.get_child([0],this).value){Tree.replace(Tree.get_child([1,0,0],this),Tree.get_child([0],this))}var idx=Tree.remove(this);for(var i=0;i<bot_g.children.length;i++){Tree.insert(top_g,idx+i,bot_g.children[i])}return true}};gmath.expressions[name]=this};var Brackets=function(term){Group.call(this);if(term){Tree.append(this,new Sym("("));Tree.append(this,term);Tree.append(this,new Sym(")"))}};asOperator.call(Brackets,"brackets",{bp:0});Brackets.registerAtParser=function(parser){var lb=parser.registerSymbol("(",30);lb.nud=function(){var e=parser.parseExpression(0);parser.advance("\\right",true);parser.advance(")");return new Brackets(e)};parser.registerSymbol("\\left").nud=function(){parser.advance("(");return lb.nud()};parser.registerSymbol("\\right");parser.registerSymbol(")");parser.registerSymbol("{").nud=function(){var e=parser.parseExpression(0);parser.advance("}");return e};lb.led=function(left){var right=parser.parseExpression(MulDiv.prototype.bp,this);return MulDiv.createProduct(left,right)};parser.registerSymbol("\\left").led=function(left){parser.advance("(");return lb.led(left)};parser.registerSymbol("{");parser.registerSymbol("}")};Brackets.handle=function(term,allow_remove){if(term.is_group("brackets")){if(allow_remove&&Brackets.is_optional(term))Tree.replace(term,term.children[1]);return}if(!Brackets.is_optional(term)){var idx=Tree.remove(term);Tree.insert(term.parent,idx,new Brackets(term))}};Brackets.is_optional=function(term,outer){if(term.is_group("brackets")&&term.children[1].is_group("brackets"))return true;var inner=term instanceof Brackets?term.children[1]:term;var outer=outer||term.parent;if(!inner.has_children())return true;if(outer instanceof EqTree)return true;if(outer.bp>inner.bp)return false;if(outer.bp<inner.bp)return true;if(outer instanceof Sign&&inner instanceof Sign)return true;if(outer.associative&&inner.is_group(outer.group_name))return true;if(inner.commutative&&outer.is_group(inner.group_name))return true;if(inner.is_group("product")&&outer.is_group("div")&&outer.parent&&outer.parent.is_group("fraction"))return true;if(inner.is_group("fraction")&&outer.is_group("mul"))return true;return false};var Sign=function(term){Group.call(this);if(term){Tree.append(this,new Sym("-"));Tree.append(this,term);Brackets.handle(term)}};asOperator.call(Sign,"sign",{bp:40,associative:true,commutative:false,inverse:"sign"});Sign.registerAtParser=function(parser){parser.registerSymbol("+").nud=function(){return parser.parseExpression(Sign.prototype.bp)};parser.registerSymbol("-").nud=function(){var e=parser.parseExpression(Sign.prototype.bp);return new Sign(e)}};Sign.prototype.deconstruct=function(){var factors=[];factors.push(this);return factors};var AddSub=function(term,mode){Group.call(this);if(term){if(mode=="add")this.value="add";else if(mode=="sub")this.value="sub";else{if(term.is_group("sign")){this.value="sub";term=term.children[1]}else this.value="add"}this.value=this.value;Tree.append(this,new Sym(this.value=="add"?"+":"-"));Tree.append(this,term);Brackets.handle(term)}else{this.value=mode=="sub"?"sub":"add"}this.associative=this.value=="add";this.nodeFromPast=function(event){return this};this.nodeFromFuture=function(intervention){return this}};asOperator.call(AddSub,"add-sub",{group_name:"sum",bp:20,associative:true,commutative:true,has_inverse:true});AddSub.prototype.invert=function(){if(this.value=="add"){this.value="sub";if(this.children[0])this.children[0].value="-";this.associative=false}else{this.value="add";if(this.children[0])this.children[0].value="+";this.associative=true}};AddSub.registerAtParser=function(parser){var plus=parser.registerSymbol("+",AddSub.prototype.bp);plus.led=function(left){var right=parser.parseExpression(AddSub.prototype.bp);if(left.is_group("sum")){left.append(new AddSub(right,"add"));return left}else{var sum=AddSub.prototype.createGroup();sum.append(new AddSub(left));sum.append(new AddSub(right,"add"));return sum}};var minus=parser.registerSymbol("-",AddSub.prototype.bp);minus.led=function(left){var right=parser.parseExpression(AddSub.prototype.bp);if(left.is_group("sum")){left.append(new AddSub(right,"sub"));return left}else{var sum=AddSub.prototype.createGroup();sum.append(new AddSub(left));sum.append(new AddSub(right,"sub"));return sum}}};AddSub.split=function(n,noMultiplier){var num=1,variables;if(n.is_group("product")&&n.children.length>1){if((n.children[0].children[1]instanceof Num||n.children[0].children[1]instanceof Sign)&&!noMultiplier){num=Num.get_value(n.children[0].children[1]);variables=n.children.slice(1)}else{variables=n.children.slice()}}else variables=[new MulDiv(Tree.clone(n))];return{num:num,variables:variables}};var ProductFraction=function(){Group.call(this)};asOperator.call(ProductFraction,"product",{bp:30,vertical_notation:false});ProductFraction.prototype.invert=function(){var N=this.children.length;if(this.value=="product"){this.value="fraction";this.vertical_notation=true;var node=this.children[N-1],i=N-1;while(node&&node.value=="div"){node=node.ls;i--}if(!node||node.value!=="//")Tree.insert(this,i+1,new Sym("//"))}else{this.value="product";this.vertical_notation=false;if(N>0){var n=this.children[0];while(n){if(n.value=="//")Tree.remove(n);n=n.rs}}}};ProductFraction.prototype.append=function(term){if(this.value=="product"&&term.value=="div"){this.invert();Tree.append(this,term)}else if(this.value=="fraction"&&term.value=="mul"){var pos=0;while(pos<this.children.length&&this.children[pos].value!=="//")pos++;Tree.insert(this,pos,term)}else{Tree.append(this,term)}return this};ProductFraction.prototype.clean_up=function(){var N1=this.get_top().length,N2=this.get_bottom().length;var changed=false;if(N1==0&&N2==0){Tree.replace(this,new Num(1));return true}if(this.value=="product"&&N2>0){this.invert();changed=true}if(this.value=="fraction"&&N2==0){this.invert();changed=true}if(this.value=="fraction"&&N1==0){Tree.insert(this,0,new MulDiv(new Num(1)));changed=true}if(N1==1&&N2==0){var val=this.get_top()[0].children[1];Tree.replace(this,val);Brackets.handle(val,true);changed=true}return changed};ProductFraction.prototype.get_top=function(){var n=this.children[0],ns=[];while(n){if(n.value=="mul")ns.push(n);n=n.rs}return ns};ProductFraction.prototype.get_bottom=function(){var n=this.children[0],ns=[];while(n){if(n.value=="div")ns.push(n);n=n.rs}return ns};ProductFraction.prototype.get_fraction_bar=function(){var n=this.children[0];while(n){if(n.value=="//")return n;n=n.rs}return null};ProductFraction.prototype.group_nodes=function(){var n=this.children[0],top=[],bottom=[],bar;while(n){if(n.value=="div")bottom.push(n);else if(n.value=="mul")top.push(n);else bar=n;n=n.rs}return{top:top,bottom:bottom,bar:bar}};ProductFraction.prototype.to_latex=function(){var top=this.get_top(),bottom=this.get_bottom();var res=bottom.length>0?"\\frac{":"";for(var i=0;i<top.length;i++){res+=i==0?top[i].children[1].to_latex():top[i].to_latex()}if(bottom.length>0){res+="}{";for(var i=0;i<bottom.length;i++){res+=i==0?bottom[i].children[1].to_latex():bottom[i].to_latex()}res+="}"}return res};ProductFraction.prototype.to_ascii=function(){var top=this.get_top(),bottom=this.get_bottom();var top_str="",bottom_str="";for(var i=0;i<top.length;i++){top_str+=i==0?top[i].children[1].to_ascii():top[i].to_ascii()}if(bottom.length==0)return top_str;for(var i=0;i<bottom.length;i++){bottom_str+=(i==0?"":"*")+bottom[i].children[1].to_ascii()}if(top.length>1)top_str="("+top_str+")";if(bottom.length>1)bottom_str="("+bottom_str+")";var str=top_str+"/"+bottom_str;if(!Brackets.is_optional(this)||this.parent.commutative)return"("+str+")";else return str};var MulDiv=function(term,mode){Group.call(this);this.value=mode=="div"?"div":"mul";if(term){Tree.append(this,new Sym(this.value=="mul"?"*":"/"));Tree.append(this,term);Brackets.handle(term)}this.associative=this.value=="mul";this.bp=this.value=="mul"?30:30};asOperator.call(MulDiv,"mul-div",{group_class:ProductFraction,group_name:"product",inverse_group_name:"fraction",bp:30,associative:true,commutative:true,has_inverse:true});MulDiv.createProduct=function(left,right){if(left.is_group("product")){left.append(new MulDiv(right));return left}else{var prod=MulDiv.prototype.createGroup();prod.append(new MulDiv(left));prod.append(new MulDiv(right));return prod}};MulDiv.registerAtParser=function(parser){var times=parser.registerSymbol("*",MulDiv.prototype.bp);times.led=function(left){var right=parser.parseExpression(MulDiv.prototype.bp);return MulDiv.createProduct(left,right)};var cdot=parser.registerSymbol("\\cdot",MulDiv.prototype.bp);cdot.led=times.led;var div=parser.registerSymbol("/",MulDiv.prototype.bp+1);div.led=function(left){var right=parser.parseExpression(MulDiv.prototype.bp+1);if(left.is_group("fraction")){left.append(new MulDiv(right,"div"));return left}else{var frac;if(left.is_group("brackets")&&left.children[1].is_group("product")){left=left.children[1]}if(left.is_group("product")){frac=left}else{frac=MulDiv.prototype.createGroup();frac.append(new MulDiv(left))}if(right.is_group("brackets")&&right.children[1].is_group("product")){right=right.children[1]}if(right.is_group("product")){var divs=right.children;for(var i=0;i<divs.length;i++){divs[i].invert();frac.append(divs[i])}}else{frac.append(new MulDiv(right,"div"))}return frac}};var frac_nud=function(){var left=parser.parseExpression(MulDiv.prototype.bp+1);var right=parser.parseExpression(MulDiv.prototype.bp+1);if(left.is_group("product")){left.append(new MulDiv(right,"div"));return left}else{var frac=MulDiv.prototype.createGroup();frac.append(new MulDiv(left));frac.append(new MulDiv(right,"div"));return frac}};parser.registerSymbol("\\frac").nud=frac_nud;parser.registerSymbol("\\dfrac").nud=frac_nud};MulDiv.hide_rule={name:"hide multiplication sign between variables",disabled:false,apply:function(n){if(!(n instanceof Sym)||n.value!=="*"&&n.value!=="/")return false;var p=n.parent;if(!p||!(p.is_group("mul")||p.is_group("div")))return false;if(!p.ls||p.ls.value!==p.value||!n.rs)return false;var ls=p.ls.children[1];if(n.rs instanceof Var||n.rs.is_group("power")&&n.rs.children[0]instanceof Var){if(Num.is_num(ls)||ls instanceof Var||ls.is_group("sign")&&ls.children[1]instanceof Var){if(p.dragging)n.hide_after_drop=true;else n.hidden=true}}}};MulDiv.prototype.invert=function(){if(this.value=="mul"){this.value="div";if(this.children[0])this.children[0].value="/";this.associative=false;this.bp=30}else{this.value="mul";if(this.children[0])this.children[0].value="*";this.associative=true;this.bp=30}};MulDiv.prototype.clean_up=function(){if(this.children[1].is_group("product")){var parent=this.parent;var nested=this.children[1];var n0=nested.children[0];if(n0.value=="mul"&&n0.children[0].hidden)Tree.replace(n0.children[0],this.children[0]);var idx=Tree.remove(this);for(var i=0;i<nested.children.length;i++){if(this.value=="div")nested.children[i].invert();Tree.insert(parent,idx+i,nested.children[i])}return true}this.parent.clean_up()};var Power=function(){Group.call(this)};asOperator.call(Power,"power",{bp:50,vertical_notation:false});var Exponent=function(term){Group.call(this);if(term){Tree.append(this,term);Brackets.handle(term)}};asOperator.call(Exponent,"exponent",{group_class:Power,group_name:"power",bp:50,vertical_notation:true});Exponent.prototype.to_ascii=function(){if(this.children.length==0)return"";return"^"+this.children[0].to_ascii()};Exponent.registerAtParser=function(parser){parser.registerSymbol("^",Exponent.prototype.bp).led=function(left){var right=parser.parseExpression(Exponent.prototype.bp-1);var power=Exponent.prototype.createGroup();power.append(left);power.append(new Exponent(right));return power}};var Bool=function(value){Tree.Node.call(this);if(value===1||value==="T"||value==="t"||value===true)this.value="T";else this.value="F";this.id=gmath.uid()};gmath.inherit(Tree.Node,Bool);Bool.prototype.to_string=function(){return this.value};Bool.prototype.to_ascii=Bool.prototype.to_string;Bool.prototype.is_group=function(){return false};Bool.registerAtParser=function(parser){var num=parser.registerSymbol("(number)");num.nud=function(){return new Bool(this.value)}};gmath.expressions=gmath.expressions||{};gmath.expressions.bool=Bool;var And=function(term){Group.call(this);if(term){Tree.append(this,new Sym("∧"));Tree.append(this,term);Brackets.handle(term)}};asOperator.call(And,"and",{group_name:"disjunction",bp:30,associative:true,commutative:true});And.registerAtParser=function(parser){var disj=parser.registerSymbol("*",And.prototype.bp);disj.led=function(left){var right=parser.parseExpression(And.prototype.bp);if(left.is_group("disjunction")){left.append(new And(right));return left}else{var c=And.prototype.createGroup();c.append(new And(left));c.append(new And(right));return c}}};var Or=function(term){Group.call(this);if(term){Tree.append(this,new Sym("∨"));Tree.append(this,term);Brackets.handle(term)}};asOperator.call(Or,"or",{group_name:"conjunction",bp:20,associative:true,commutative:true});Or.registerAtParser=function(parser){var disj=parser.registerSymbol("+",Or.prototype.bp);disj.led=function(left){var right=parser.parseExpression(Or.prototype.bp);if(left.is_group("conjunction")){left.append(new Or(right));return left}else{var c=Or.prototype.createGroup();c.append(new Or(left));c.append(new Or(right));return c}}};var Equals=function(left,right){Group.call(this);if(left&&right){Tree.append(this,left);Tree.append(this,new Sym("="));Tree.append(this,right)}};asOperator.call(Equals,"equals",{bp:10,commutative:true});Equals.registerAtParser=function(parser){var eqls=parser.registerSymbol("=",Equals.prototype.bp);eqls.led=function(left){var right=parser.parseExpression(Equals.prototype.bp);return new Equals(left,right)}};gmath.actions={};Action=function(name){this.name=name;this.priority=0;this.node_map={};this.touched_nodes={}};Action.prototype.createBoundAction=function(tree,settings){var a=new this.constructor(settings);a.oldTree=tree;a.newTree=tree;return a};Action.prototype.createAndRun=function(tree,settings,callback){var a=new this.constructor(settings);a.oldTree=tree;a.run(callback);return a};Action.prototype.createAndDoInPlace=function(tree,settings,callback){var a=new this.constructor(settings);a.oldTree=tree;a.newTree=tree;a.doInPlace(callback);return a};Action.prototype.initNodeMap=function(){this.node_map=this.oldTree.children[0].get_mapping_to(this.newTree.children[0])};Action.prototype.removeDeletedNodesFromNodeMap=function(){var target_nodes=this.newTree.select_all();var in_target_nodes=function(node){return target_nodes.indexOf(node)!==-1};for(var id in this.node_map){this.node_map[id]=this.node_map[id].filter(in_target_nodes)}};Action.prototype.updateNodeMap=function(map_or_n1,n2){if(arguments.length===1)gmath.extend(this.node_map,map_or_n1);else this.node_map[map_or_n1.id]=Array.isArray(n2)?n2:[n2]};Action.pushNew=function(arr1,arr2){for(var i=0;i<arr2.length;i++){if(arr1.indexOf(arr2[i])===-1)arr1.push(arr2[i]);else{arr1.splice(arr1.indexOf(arr2[i]),1);arr1.push(arr2[i])}}};Action.prototype.extendNodeMap=function(map_or_n1,n2){if(arguments.length===2){var n1=map_or_n1;var n2s=Array.isArray(n2)?n2:[n2];if(n1.id in this.node_map)Action.pushNew(this.node_map[n1.id],n2s);else this.node_map[n1.id]=n2s;return}else{var map=map_or_n1;for(var key in map){if(!map.hasOwnProperty(key))continue;if(key in this.node_map)Action.pushNew(this.node_map[key],map[key]);else this.node_map[key]=map[key]}}};Action.prototype.getNewTreeNode=function(node){return this.getCorrespondingNodeFromTree(node,this.newTree)};Action.prototype.getOldTreeNode=function(node){return this.getCorrespondingNodeFromTree(node,this.oldTree)};Action.prototype.getCorrespondingNodeFromTree=function(node,tree){var fn=function(node){return tree.get_child(node.get_path())};if(Array.isArray(node))return node.map(fn);else return fn(node)};Action.prototype.addTouchedNodes=function(node){var self=this;node.for_each(function(n){self.touched_nodes[n.id]=true})};Action.prototype.cleanup=function(node){if(!node.cleanupAction)return false;if(!node.cleanupAction.match(node))return false;var action=node.cleanupAction.createAndDoInPlace(this.newTree,{actor:node});this.compose(action);return true};Action.prototype.compose=function(action){for(var id in this.node_map){this.node_map[id]=action.mapNodes(this.node_map[id]);if(action.touched_nodes[id])this.touched_nodes[id]=true}};Action.prototype.run=function(callback){this.newTree=Tree.clone(this.oldTree);return this.doInPlace(callback)};Action.prototype.match=function(){throw"called abstract method Action.match()"};Action.prototype.doInPlace=function(callback){throw"called abstract method Action.doInPlace()"};Action.prototype.updateNodesFromFutureAndPast=function(){console.warn("called abstract method Action.updateNodesFromFutureAndPast()")};Action.prototype.wasNodeTouched=function(node){return this.touched_nodes[node.id]};Action.prototype.mapNodes=function(source_nodes){var all_target_nodes=[],self=this;if(!Array.isArray(source_nodes))source_nodes=[source_nodes];source_nodes.forEach(function(source_node){var target_nodes=self.node_map[source_node.id]||[];target_nodes.forEach(function(target_node){if(all_target_nodes.indexOf(target_node)===-1)all_target_nodes.push(target_node)})});return all_target_nodes};Action.createComposedAction=function(actions,name){var res=new Action(name);function buildNodeMap(){function rec_mapping(nodes,id,idx){if(idx>=actions.length)return nodes;if(!res.touched_nodes[id]){res.touched_nodes[id]=nodes.some(actions[idx].wasNodeTouched.bind(actions[idx]))}return rec_mapping(actions[idx].mapNodes(nodes),id,idx+1)}res.node_map={};res.touched_nodes={};for(var id in actions[0].node_map){res.touched_nodes[id]=actions[0].touched_nodes[id];res.node_map[id]=rec_mapping(actions[0].node_map[id],id,1)}}buildNodeMap();res.updateNodesFromFutureAndPast=function(){actions.forEach(function(action){action.updateNodesFromFutureAndPast()})};return res};(function(){var AddSubNumbersAction=function(settings){Action.call(this,"add or subtract numbers");this.priority=1;if(settings)this.actor=settings.actor};gmath.inherit(Action,AddSubNumbersAction);AddSubNumbersAction.prototype.match=function(node){if(!node.parent.is_group("sum"))return false;if(!node.ls)return false;var t1=node.ls.children[1],t2=node.children[1];return Num.is_num(t1)&&!(t1.is_group("sign")&&t1.parent.is_group("sub"))&&Num.is_num(t2)&&!(t2.is_group("sign")&&t2.parent.is_group("sub"))};AddSubNumbersAction.prototype.doInPlace=function(callback){this.initNodeMap();var rightAddend=this.getNewTreeNode(this.actor),leftAddend=rightAddend.ls,parentSum=rightAddend.parent;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var term1=leftAddend.children[1],term2=rightAddend.children[1];var resSum=(leftAddend.is_group("sub")?-1:1)*Num.get_value(term1)+(rightAddend.is_group("sub")?-1:1)*Num.get_value(term2);var pm_notation=leftAddend.is_group("add")&&leftAddend.children[1].is_group("sign");var add=new AddSub(new Num(resSum),pm_notation?"add":"auto");this.updateNodeMap(this.actor.get_mapping_to(add));this.updateNodeMap(this.actor.ls.get_mapping_to(add));var idx=Tree.remove(leftAddend);Tree.remove(rightAddend);Tree.insert(parentSum,idx,add);this.cleanup(add);if(typeof callback==="function")callback(this);return this};AddSubNumbersAction.prototype.updateNodesFromFutureAndPast=function(){var t1=this.actor.ls;var t2=this.actor;var tree=Tree.get_root(t1);var t1Val=tree.numeric_value(t1);var t2Val=tree.numeric_value(t2);var action=this;function get_sum_node(addend){return action.mapNodes([addend])[0]}function attribute_changes(l,r,sum){return[sum-r,r]}t1.nodeFromFuture=function(intervention){var sum_node=get_sum_node(this);var sum_val=tree.numeric_value(sum_node);if(intervention.type=="changeNumber"){tree.numeric_value(this,attribute_changes(t1Val,t2Val,sum_val)[0])}return this};t1.children[0].nodeFromFuture=function(){return this};t1.children[1].nodeFromFuture=function(){return this};t2.nodeFromFuture=function(intervention){var sum_node=get_sum_node(this);var sum_val=tree.numeric_value(sum_node);if(intervention.type=="changeNumber"){tree.numeric_value(this,attribute_changes(t1Val,t2Val,sum_val)[1])}return this};t2.children[0].nodeFromFuture=function(){return this};t2.children[1].nodeFromFuture=function(){return this};if(Tree.get_root(t1).timeState.children[0]){var node=action.mapNodes(t1)[0];var future_tree=tree.timeState.children[0].mathObject;node.nodeFromPast=function(event){console.log("Tell me what you want");future_tree.numeric_value(this,tree.numeric_value(t1)+tree.numeric_value(t2))};if(node.children&&node.children.length==2){node.children[0].nodeFromPast=function(event){return this};node.children[1].nodeFromPast=function(event){return this}}}return true};AddSub.prototype.add_action_handler(new AddSubNumbersAction)})();gmath.actions.AssociateIntoFractionAction=function(){var AssociateIntoFractionAction=function(settings){Action.call(this,"associative property of multiplication--move into fraction");this.priority=0;if(settings){if(settings.actor)settings=this.getSettingsFromActor(settings.actor);this.nodes=settings.nodes;this.target=settings.target;this.side=settings.side}};gmath.inherit(Action,AssociateIntoFractionAction);AssociateIntoFractionAction.prototype.getAllAvailableActions=function(nodes){if(nodes.length===0)return[];var res=[],n0=nodes[0],n1=nodes[nodes.length-1],parent=nodes[0].parent,self=this,root=n0.get_root(),self=this;function check(frac){if(frac.is_group("mul"))frac=frac.children[1];if(!frac.is_group("fraction"))return;for(var i=0;i<frac.children.length;i++){var n=frac.children[i];if(!n.is_group("mul"))return;if(self.match(nodes,n,"left"))res.push(self.createBoundAction(root,{nodes:nodes,target:n,side:"left-of"}));if(self.match(nodes,n,"right"))res.push(self.createBoundAction(root,{nodes:nodes,target:n,side:"right-of"}))}}if(n0.parent!==n1.parent)return[];var n=parent.children[0];while(n!==n0){check(n);n=n.rs}n=parent.children[parent.children.length-1];while(n!==n1&&n){check(n);n=n.ls}return res};AssociateIntoFractionAction.prototype.getSettingsFromActor=function(actor){var target,nodes,side;if(actor&&actor.children[1]&&actor.children[1].is_group("fraction")){target=actor.children[1].children[0];nodes=[actor.ls];side="left-of"}else if(actor&&actor.ls&&actor.ls.children[1]&&actor.ls.children[1].is_group("fraction")){var frac=actor.ls.children[1];var numerator=frac.get_top();target=numerator[numerator.length-1];nodes=[actor];side="right-of"}return{target:target,nodes:nodes,side:side}};AssociateIntoFractionAction.prototype.match=function(nodes,target,side){if(arguments.length==1){var settings=this.getSettingsFromActor(nodes);nodes=settings.nodes;target=settings.target;side=settings.side}if(!nodes||nodes.length==0)return false;if(!side)return false;if(!target||!target.is_group("mul")||!target.parent.is_group("fraction"))return false;if(!target.parent.parent||target.parent.parent.parent!==nodes[0].parent)return false;if(!nodes.every(function(n){return n.is_group("mul")&&n.children[1]!==target.parent}))return false;return true};AssociateIntoFractionAction.prototype.doInPlace=function(callback){this.initNodeMap();var is_same_tree=this.oldTree===this.newTree;var nodes=is_same_tree?this.nodes:this.getNewTreeNode(this.nodes);var target=is_same_tree?this.target:this.getNewTreeNode(this.target);var fraction=target.parent;var idx=fraction.children.indexOf(target);if(this.side==="right-of")idx++;Tree.remove_range(nodes);fraction.insert_range(idx,nodes);this.cleanup(fraction);this.cleanup(fraction.parent);if(typeof callback==="function")callback(this);else return true};MulDiv.prototype.add_action_handler(new AssociateIntoFractionAction);return new AssociateIntoFractionAction}();EqTree.prototype.move_actions.push(gmath.actions.AssociateIntoFractionAction);gmath.actions.AssociateOutOfFractionAction=function(){var AssociateOutOfFractionAction=function(settings){Action.call(this,"associative property of multiplication--move out of fraction");if(settings){this.nodes=settings.nodes;this.target=settings.target;this.side=settings.side;this.priority=settings.priority||0}};gmath.inherit(Action,AssociateOutOfFractionAction);AssociateOutOfFractionAction.prototype.getAllAvailableActions=function(nodes){if(nodes.length===0)return res;var n0=nodes[0],root=n0.get_root();if(!n0.is_group("mul")||!n0.parent.is_group("fraction"))return[];if(this.match(nodes,n0.parent)){return[this.createBoundAction(root,{nodes:nodes,target:n0.parent,side:"left-of"}),this.createBoundAction(root,{nodes:nodes,target:n0.parent,side:"right-of"})]}return[]};AssociateOutOfFractionAction.prototype.match=function(nodes,target){if(nodes.length===0)return false;return nodes[0]&&nodes[0].is_group("mul")&&nodes[0].parent===target&&target.is_group("fraction")};AssociateOutOfFractionAction.prototype.doInPlace=function(callback){this.initNodeMap();var is_same_tree=this.oldTree===this.newTree;if(!is_same_tree){var get_by_path=function(node){return tree.get_child(node.get_path())}}var nodes=is_same_tree?this.nodes:this.nodes.map(get_by_path);var target=is_same_tree?this.target:get_by_path(this.target);Tree.remove_range(nodes);var tparent=target.parent;if(tparent.is_group("mul")){var product=tparent.parent,mul=tparent;var idx=product.children.indexOf(mul);if(this.side==="right-of")idx++;product.insert_range(idx,nodes)}else{var product=new ProductFraction;target.replace_with(product);var mul=new MulDiv;mul.append(new Sym("*"));mul.append(target);product.append(mul);product.insert_range(this.side==="right-of"?1:0,nodes)}target.clean_up();if(typeof callback==="function")callback(this);else return true};return new AssociateOutOfFractionAction}();EqTree.prototype.move_actions.push(gmath.actions.AssociateOutOfFractionAction);(function(){var AddSubBracketsAction=function(settings){Action.call(this,"add or subtract a bracketed sum");if(settings)this.actor=settings.actor};gmath.inherit(Action,AddSubBracketsAction);AddSubBracketsAction.prototype.match=function(node){if(!node.is_group("add")&&!node.is_group("sub"))return false;if(!node.children[1].is_group("brackets")||!node.children[1].children[1].is_group(node.group_name))return false;return true};AddSubBracketsAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var old_sign=this.actor.children[0];this.addTouchedNodes(this.actor);var br=node.children[1];var sum=node.children[1].children[1];Tree.replace(br,sum);if(node.is_group("sub")){node.invert();var signs=[];for(var i=0;i<sum.children.length;i++){sum.children[i].invert();signs.push(sum.children[i].children[0])}this.updateNodeMap(old_sign,signs)}this.cleanup(node);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return this};AddSub.prototype.add_action_handler(new AddSubBracketsAction)})();(function(){var AddSubCleanUp=function(settings){Action.call(this,"addsub cleanup action");if(settings)this.addsub=settings.actor};gmath.inherit(Action,AddSubCleanUp);AddSubCleanUp.prototype.match=function(node){if(node.parent.is_group("sum")&&!node.ls&&!node.rs)return true;if(node.is_group("add")&&node.children[1]&&node.children[1].is_group("sum"))return true;return false};AddSubCleanUp.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.addsub);if(!node.ls&&!node.rs){var val;if(node.is_group("add")){val=node.children[1];this.updateNodeMap(this.addsub.children[0],val)
}else if(node.is_group("sub")){if(node.children[1].is_group("product")){var firstFactor=node.children[1].children[0].children[1],parent=firstFactor.parent;firstFactor.remove();var sign=new Sign(firstFactor);parent.append(sign);val=node.children[1]}else{val=new Sign(node.children[1])}this.updateNodeMap(this.addsub.children[0],val.children[0])}this.updateNodeMap(this.addsub,val);Tree.replace(node.parent,val);if(val.parent&&val.parent.is_group("brackets"))Brackets.handle(val.parent,true);else Brackets.handle(val)}else if(node.is_group("add")&&node.children[1].is_group("sum")){var parent=node.parent;var nested=node.children[1];var idx=Tree.remove(node);parent.insert_range(idx,nested.children)}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return this};AddSub.prototype.cleanupAction=new AddSubCleanUp})();(function(){var AddVariablesAction=function(settings){Action.call(this,"add variables");this.priority=0;if(settings)this.actor=settings.actor};gmath.inherit(Action,AddVariablesAction);var ascii=function(a){return a.to_ascii()};AddVariablesAction.prototype.match=function(node){if(!node.ls)return false;var t1=node.ls.children[1],t2=node.children[1];var s1,s2;if(t1.is_group("product")&&t2.is_group("product")){if(t1.children.length===t2.children.length+1)s1=AddSub.split(t1),s2=AddSub.split(t2,true);else if(t1.children.length+1===t2.children.length)s1=AddSub.split(t1,true),s2=AddSub.split(t2);else s1=AddSub.split(t1),s2=AddSub.split(t2)}else{var s1=AddSub.split(t1),s2=AddSub.split(t2)}if(!(s1&&s2&&s1.variables.map(ascii).join("")===s2.variables.map(ascii).join("")))return false;return true};AddVariablesAction.prototype.doInPlace=function(callback){this.initNodeMap();this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var node=this.getNewTreeNode(this.actor);var l_prod=node.ls.children[1],r_prod=node.children[1];var s1,s2;if(l_prod.is_group("product")&&r_prod.is_group("product")){if(l_prod.children.length===r_prod.children.length+1)s1=AddSub.split(l_prod),s2=AddSub.split(r_prod,true);else if(l_prod.children.length+1===r_prod.children.length)s1=AddSub.split(l_prod,true),s2=AddSub.split(r_prod);else s1=AddSub.split(l_prod),s2=AddSub.split(r_prod)}else{var s1=AddSub.split(l_prod),s2=AddSub.split(r_prod)}var sum=s1.num*(node.ls.is_group("sub")?-1:1)+s2.num*(node.is_group("sub")?-1:1);var prod=MulDiv.prototype.createGroup();prod.append(new MulDiv(new Num(Math.abs(sum))));prod.append_range(s1.variables);var n=sum<0?new AddSub(prod,"sub"):new AddSub(prod,"add");var l_no_num=l_prod.children.length===s1.variables.length,r_no_num=r_prod.children.length===s2.variables.length,skip={skip:prod.children[0]};this.updateNodeMap(this.actor.ls.get_mapping_to(n,l_no_num?skip:{}));this.updateNodeMap(this.actor.get_mapping_to(n,r_no_num?skip:{}));Tree.remove(node.ls);var idx=Tree.remove(node);Tree.insert(node.parent,idx,n);if(Math.abs(sum)===1){prod.children[0].remove();this.cleanup(prod)}else if(Math.abs(sum)===0){Tree.replace(prod,prod.children[0].children[1])}this.cleanup(n);if(!(Math.abs(sum)===1||Math.abs(sum)===0)&&prod&&prod.parent)this.cleanup(prod.parent);if(typeof callback==="function")callback(this);return true};AddSub.prototype.add_action_handler(new AddVariablesAction)})();(function(){var AddNegativeAction=function(settings){Action.call(this,"rearrange signs");if(settings)this.actor=settings.actor};gmath.inherit(Action,AddNegativeAction);AddNegativeAction.prototype.match=function(node){var c=node.children[1];if(c.is_group("sign"))return true;return false};AddNegativeAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var old_sign=this.actor.children[1].children[0];this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(old_sign);var sign_group=node.children[1];node.invert();this.updateNodeMap(old_sign,node.children[0]);Tree.replace(sign_group,sign_group.children[1]);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};AddSub.prototype.add_action_handler(new AddNegativeAction)})();(function(){var PlusMinusProductToMinusProductAction=function(settings){Action.call(this,"x+-y*z=x-y*z");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,PlusMinusProductToMinusProductAction);PlusMinusProductToMinusProductAction.prototype.match=function(node){if(!node.children[1].is_group("product"))return false;var first_factor=node.children[1].children[0].children[1];if(!first_factor.is_group("sign"))return false;return true};PlusMinusProductToMinusProductAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var first_factor=node.children[1].children[0].children[1];var old_sign=this.getOldTreeNode(first_factor.children[0]);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(old_sign);this.updateNodeMap(old_sign,node.children[0]);Tree.replace(first_factor,first_factor.children[1]);node.invert();this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};AddSub.prototype.add_action_handler(new PlusMinusProductToMinusProductAction)})();RemoveBracketsAction=function(){var RemoveBracketsAction=function(settings){Action.call(this,"remove optional brackets");this.priority=4;if(settings){this.actor=settings.actor}};gmath.inherit(Action,RemoveBracketsAction);RemoveBracketsAction.prototype.match=function(node){return node.is_group("brackets")&&Brackets.is_optional(node)};RemoveBracketsAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[2]);var n=Tree.replace(node,node.children[1]);this.cleanup(n.parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};var rba=new RemoveBracketsAction;Brackets.prototype.add_action_handler(rba);return rba}();gmath.actions.editLineAction=function(){var editLineAction=function(settings){Action.call(this,"rewrite dl line");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,editLineAction);editLineAction.prototype.match=function(){return typeof Keyboard!=="undefined"&&Keyboard!==null};editLineAction.prototype.removeAllNodesFromNodeMap=function(){var target_nodes=this.newTree.select_all();for(var id in this.node_map){this.node_map[id]=[]}};editLineAction.prototype.doInPlace=function(callback){this.initNodeMap();var op_str;var keyboard=Keyboard();keyboard.on("done",enteredExpression).on("cancel",kbCancelled)();var self=this;function enteredExpression(latex){var model=self.newTree;var expression=model.parse(latex,true);if(!expression)return;model.children[0].remove();model.append(expression);keyboard.visible(false);keyboard.on("done",null).on("cancel",null);self.removeAllNodesFromNodeMap();callback(self)}function kbCancelled(){console.log("cancelled");keyboard.visible(false);keyboard.on("done",null).on("cancel",null);callback(false)}keyboard.latex(self.newTree.to_latex()).visible(true)};return new editLineAction}();gmath.actions.CommuteAction=function(){var CommuteAction=function(settings){Action.call(this,"commute terms");if(settings){this.nodes=settings.nodes;this.target=settings.target;this.side=settings.side}};gmath.inherit(Action,CommuteAction);CommuteAction.prototype.getAllAvailableActions=function(ns){if(ns.length===0)return[];var root=ns[0].get_root();var actions=[];var is_flat=ns[0].parent.is_group("flat"),n;if(is_flat)return[];if(!ns[0].commutative||!Tree.is_range(ns))return[];for(n=ns[0].ls;n&&n.value!=="//";n=n.ls){if(this.match(ns,n,"left-of"))actions.push(this.createBoundAction(root,{nodes:ns,target:n,side:"left-of"}))}for(n=ns[ns.length-1].rs;n&&n.value!=="//";n=n.rs){if(this.match(ns,n,"right-of"))actions.push(this.createBoundAction(root,{nodes:ns,target:n,side:"right-of"}))}return actions};CommuteAction.prototype.match=function(nodes,target,side){if(target.parent!==nodes[0].parent)return false;if(!nodes[0].commutative)return false;if(side==="left-of"&&target.ls===nodes[nodes.length-1])return false;if(side==="right-of"&&target.rs===nodes[0])return false;return true};CommuteAction.prototype.doInPlace=function(callback){this.initNodeMap();var nodes=this.getNewTreeNode(this.nodes);var target=this.getNewTreeNode(this.target);var parent=target.parent,idx=parent.children.indexOf(target);if(nodes.length===1){nodes[0].remove();parent.insert(idx,nodes[0])}else{if(this.side==="right-of")idx++;var idx0=Tree.remove_range(nodes);parent.insert_range(idx0<idx?idx-nodes.length:idx,nodes)}if(typeof callback==="function")callback(this);else return true};return new CommuteAction}();EqTree.prototype.move_actions.push(gmath.actions.CommuteAction);gmath.actions.EqInvertAction=function(){var EqInvertAction=function(settings){Action.call(this,"invert terms across equation");if(settings){this.nodes=settings.nodes;this.target=this.find_target();this.side=settings.side;this.priority=settings.priority||0}};gmath.inherit(Action,EqInvertAction);EqInvertAction.prototype.getAllAvailableActions=function(nodes){var res=[];if(nodes.length===0)return res;if(this.match(nodes))res.push(this.createBoundAction(nodes[0].get_root(),{nodes:nodes,side:"around"}));return res};EqInvertAction.prototype.match=function(nodes){var n0=nodes[0];var tree=n0.get_root();var path_n0=n0.get_path();if(path_n0[1]!==0&&path_n0[1]!==2)return false;return tree.children[0].is_group("equals")&&(n0.has_inverse&&n0.parent&&n0.parent.parent&&n0.parent.parent.is_group("equals")||n0.parent.is_group("equals"))};EqInvertAction.prototype.find_target=function(){var p=this.nodes[0].get_path();return this.nodes[0].get_root().children[0].children[p[1]===0?2:0]};EqInvertAction.prototype.doInPlace=function(callback){this.initNodeMap();var nodes=this.nodes.map(this.getNewTreeNode.bind(this));this.nodes.forEach(this.addTouchedNodes.bind(this));var target=this.getNewTreeNode(this.target);var n0=nodes[0];var p;if(n0.has_inverse){p=n0.parent;Tree.remove_range(nodes)}else{n0.replace_with(new Num(0));n0=new AddSub(n0);this.updateNodeMap(this.nodes[0],n0);nodes=[n0]}for(var i=0;i<nodes.length;i++)nodes[i].invert();if(target.is_group(n0.group_name)||n0.inverse_group_name&&target.is_group(n0.inverse_group_name)){for(var i=0;i<nodes.length;i++)target.append(nodes[i]);if(target.clean_up)target.clean_up()}else{var g=n0.createGroup();var target_parent=target.parent;var idx=Tree.remove(target);Tree.insert(target_parent,idx,g);if(!n0.is_group("add")&&!n0.is_group("sub")||Num.get_value(target)!==0)g.append(new n0.constructor(target));g.append_range(nodes);this.cleanup(g)}if(p)this.cleanup(p);if(typeof callback==="function")callback(this);else return true};return new EqInvertAction}();EqTree.prototype.move_actions.push(gmath.actions.EqInvertAction);EqTree.prototype.hideNodesAction=function(){var HideNodesAction=function(settings){Action.call(this,"apply hide rules")};gmath.inherit(Action,HideNodesAction);HideNodesAction.prototype.doInPlace=function(tree,callback){var changed=false;if(tree.children.length>0){tree.children[0].for_each(function(n){var old1=n.hidden,old2=n.hide_afer_drop;n.hidden=false;n.hide_after_drop=false;if(tree.options.hide_leading_op&&n instanceof Sym&&n.parent&&n.parent.commutative){if(n.parent.associative&&!n.parent.ls||n.parent.value=="div"&&n.parent.ls&&n.parent.ls.value=="//"){if(n.parent.dragging)n.hide_after_drop=true;else n.hidden=true}}if((n.value=="("||n.value==")")&&n.parent&&n.parent.is_group("brackets")){var p=n.parent,c=n.parent.children[1];while(p&&p.is_group("brackets"))p=p.parent;if(p&&p.parent&&(p.vertical_notation||p.parent.vertical_notation)&&(!p.ls||p.ls.value!=p.value)&&(!p.rs||p.rs.value!=p.value)&&!c.is_group("brackets")&&c.is_group()&&c.bp<p.parent.bp){if(n.parent.dragging)n.hide_after_drop=true;else n.hidden=true}}for(var i=0;i<tree.hide_rules.length&&!n.hidden;i++){var hr=tree.hide_rules[i];if(!hr.disabled)hr.apply(n)}changed=changed||n.hidden!=old1||n.hide_after_drop!=old2})}if(typeof callback==="function")callback(this);else return changed};return new HideNodesAction}();gmath.actions.SwitchAction=function(){var SwitchAction=function(settings){Action.call(this,"switch terms in a flat representation");if(settings){this.node=settings.node;this.target=settings.target;this.side=settings.side;this.priority=settings.priority||0}};gmath.inherit(Action,SwitchAction);SwitchAction.prototype.getAllAvailableActions=function(ns){if(ns.length===0)return[];var root=ns[0].get_root();var actions=[];var is_flat=ns[0].parent.is_group("flat"),n;if(!is_flat)return[];if(!ns[0].commutative||!Tree.is_range(ns))return[];for(n=ns[0].ls;n&&n.value!=="//";n=n.ls){if(this.match(ns[0],n))actions.push(this.createBoundAction(root,{node:ns[0],side:"around",target:n}))}for(n=ns[ns.length-1].rs;n&&n.value!=="//";n=n.rs){if(this.match(ns[0],n))actions.push(this.createBoundAction(root,{node:ns[0],side:"around",target:n}))}};SwitchAction.prototype.match=function(node,target){return node.parent===target.parent&&node!==target&&!(target instanceof Sym)&&!(node instanceof Sym)};SwitchAction.prototype.doInPlace=function(callback){this.initNodeMap();var is_same_tree=tree===this.target.get_root();var node=is_same_tree?this.node:tree.get_child(this.node.get_path());var target=is_same_tree?this.target:tree.get_child(this.target.get_path());Tree.switch_siblings(node,target);if(typeof callback==="function")callback(this);else return true};return new SwitchAction}();EqTree.prototype.move_actions.push(gmath.actions.SwitchAction);(function(){var flipEquationAction=function(settings){Action.call(this,"flip equation");if(settings)this.actor=settings.actor;this.priority=1};gmath.inherit(Action,flipEquationAction);flipEquationAction.prototype.match=function(node){return node.is_group("equals")};flipEquationAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(getLeftSideOfEquation(this.actor));this.addTouchedNodes(getRightSideOfEquation(this.actor));var leftSideOfEquation=getLeftSideOfEquation(node),rightSideOfEquation=getRightSideOfEquation(node);leftSideOfEquation.remove();rightSideOfEquation.remove();var leftSideLocation=0,rightSideLocation=2;node.insert(leftSideLocation,rightSideOfEquation);node.insert(rightSideLocation,leftSideOfEquation);if(typeof callback==="function")callback(this);return this};Equals.prototype.add_action_handler(new flipEquationAction);var getLeftSideOfEquation=function(equalsGroup){return equalsGroup.children[0]};var getRightSideOfEquation=function(equalsGroup){return equalsGroup.children[2]}})();(function(){var equationFountain=function(settings){Action.call(this,"rewrite equation");if(settings)this.actor=settings.actor;this.priority=0};gmath.inherit(Action,equationFountain);equationFountain.prototype.match=function(node){return node.is_group("equals")};equationFountain.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var actor=node;var op_str;var keyboard=Keyboard();keyboard.on("done",enteredOperator).on("cancel",kbCancelled)();function enteredOperator(latex){op_str="";if(latex=="+")op_str="add";else if(latex=="-")op_str="sub";else if(latex=="\\cdot")op_str="mul";else if(latex=="\\frac{ }{ }")op_str="div";else return;console.log(op_str);keyboard.on("done",enteredTerm);keyboard.latex("")}function enteredTerm(latex){var term=Tree.get_root(actor).parse(latex);if(!term)return;apply_change(actor.children[0],op_str,term);apply_change(actor.children[2],op_str,Tree.clone(term));keyboard.visible(false);keyboard.on("done",null).on("cancel",null);callback(this)}function kbCancelled(){console.log("cancelled");keyboard.visible(false);keyboard.on("done",null).on("cancel",null);callback(false)}keyboard.latex("").visible(true);function apply_change(target,op_str,term){var op=op_str=="add"||op_str=="sub"?AddSub:MulDiv;if(op==AddSub&&target.is_group("sum")||op==MulDiv&&target instanceof ProductFraction){target.append(new op(term,op_str))}else{var parent=target.parent,idx=Tree.remove(target);var group=op.prototype.createGroup();group.append(new op(target));group.append(new op(term,op_str));Tree.insert(parent,idx,group)}}};Equals.prototype.add_action_handler(new equationFountain)})();(function(){var GroupCleanup=function(settings){Action.call(this,"group cleanup action");if(settings)this.group=settings.actor};gmath.inherit(Action,GroupCleanup);GroupCleanup.prototype.match=function(node){return node.is_group("product")||node.is_group("sum")};GroupCleanup.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.group);if(node.children.length===0){Tree.remove(node)}else{node.children.forEach(this.cleanup.bind(this))}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return this};Group.prototype.cleanupAction=new GroupCleanup})();(function(){var SignDoubleNegAction=function(settings){Action.call(this,"--x=x");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,SignDoubleNegAction);SignDoubleNegAction.prototype.match=function(node){return node.children.length==2&&(node.children[1].is_group("sign")||node.parent.is_group("sign"))};SignDoubleNegAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);if(node.children[1].is_group("sign")){this.addTouchedNodes(this.actor.children[0]);this.addTouchedNodes(this.actor.children[1].children[0]);Tree.replace(node,node.children[1].children[1])}else if(node.parent.is_group("sign")){this.addTouchedNodes(this.actor.parent.children[0]);this.addTouchedNodes(this.actor.children[0]);Tree.replace(node.parent,node.children[1])}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};SignDoubleNegAction.prototype.updateNodesFromFutureAndPast=function(){};Sign.prototype.add_action_handler(new SignDoubleNegAction)})();(function(){var SignZeroAction=function(settings){Action.call(this,"-0=0");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,SignZeroAction);SignZeroAction.prototype.match=function(node){return node.children[1]instanceof Num&&node.children[1].value===0};SignZeroAction.prototype.doInPlace=function(callback){this.initNodeMap();var sign=this.getNewTreeNode(this.actor),zero=sign.children[1];this.addTouchedNodes(this.actor);this.updateNodeMap(this.actor.get_mapping_to(zero));Tree.replace(sign,zero);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};Sign.prototype.add_action_handler(new SignZeroAction)})();(function(){var IntegerExponentsAction=function(settings){Action.call(this,"integer exponents");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,IntegerExponentsAction);IntegerExponentsAction.prototype.match=function(node){var pow=node.parent;if(!pow.is_group("power"))return false;var base=pow.children[0],exp=node.children[0];if(base.is_group("brackets"))base=base.children[1];if(!Num.is_num(base))return false;return Num.is_num(base)&&exp instanceof Num&&Math.round(exp.value)==exp.value&&exp.value!==0};IntegerExponentsAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var pow=node.parent,base=pow.children[0],exp=node.children[0];if(base.is_group("brackets"))base=base.children[1];var res_term=new Num(Math.pow(Num.get_value(base),exp.value));this.updateNodeMap(this.actor.parent.get_mapping_to(res_term));Tree.replace(pow,res_term);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};Exponent.prototype.add_action_handler(new IntegerExponentsAction)})();(function(){function mapRelativePaths(oldPath,relPath,root,map){var curr=root;map[oldPath]=[relPath];if(curr.has_children()){for(var i=0;i<curr.children.length;i++){mapRelativePaths(oldPath.concat(i),relPath.concat(i),root.children[i],map)}}}var xToOneAction=function(settings){Action.call(this,"x^1=x");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,xToOneAction);xToOneAction.prototype.match=function(node){return node.children[0]instanceof Num&&node.children[0].value===1};xToOneAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var base=node.ls;Tree.remove(base);node.parent.replace_with(base);Brackets.handle(base);this.updateNodeMap(this.actor.parent,base);this.updateNodeMap(this.actor,base);this.updateNodeMap(this.actor.children[0],base);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};Exponent.prototype.add_action_handler(new xToOneAction)})();(function(){var xToZeroAction=function(settings){Action.call(this,"x^0=1");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,xToZeroAction);xToZeroAction.prototype.match=function(node){return node.children[0]instanceof Num&&node.children[0].value===0&&node.ls.to_ascii()!=="0"};xToZeroAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor.parent);var one=new Num(1);this.updateNodeMap(this.actor.parent.get_mapping_to(one));Tree.replace(node.parent,one);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};Exponent.prototype.add_action_handler(new xToZeroAction)})();(function(){var MulDivCleanup=function(settings){Action.call(this,"muldiv cleanup action");if(settings)this.muldiv=settings.actor};gmath.inherit(Action,MulDivCleanup);MulDivCleanup.prototype.match=function(node){if(MulDivCleanup.hasProductChild(node))return true;if(node.parent.cleanupAction&&node.parent.cleanupAction.match(node.parent))return true;return false};MulDivCleanup.hasProductChild=function(node){return(node.is_group("mul")||node.is_group("div"))&&node.children[1]&&node.children[1].is_group("product")};MulDivCleanup.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.muldiv);var parent=node.parent;if(MulDivCleanup.hasProductChild(node)){var nested=node.children[1];var idx=Tree.remove(node);if(this.muldiv.is_group("div"))nested.children.forEach(function(n){n.invert()});parent.insert_range(idx,nested.children);this.removeDeletedNodesFromNodeMap()}this.cleanup(parent);if(typeof callback==="function")callback(this);else return this};MulDiv.prototype.cleanupAction=new MulDivCleanup})();(function(){var MultiplyNumbersAction=function(settings){Action.call(this,"Multiply numbers");if(settings)this.actor=settings.actor};gmath.inherit(Action,MultiplyNumbersAction);MultiplyNumbersAction.prototype.match=function(node){if(!node.ls)return false;if(node.ls.value!=node.value)return false;var t1=node.ls.children[1],t2=node.children[1];if(!(Num.is_num(t1)&&Num.is_num(t2)))return false;return true};MultiplyNumbersAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var multiplicand=node.ls,multiplier=node;var term1=multiplicand.children[1],term2=multiplier.children[1];var res_prod_term=Num.get_value(term1)*Num.get_value(term2);var n=new MulDiv(new Num(res_prod_term),multiplier.value);this.updateNodeMap(this.actor.ls.get_mapping_to(n));this.updateNodeMap(this.actor.get_mapping_to(n));Tree.remove(multiplicand);var idx=Tree.remove(multiplier);Tree.insert(node.parent,idx,n);this.cleanup(n);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return this};MulDiv.prototype.add_action_handler(new MultiplyNumbersAction)})();(function(){var MultiplyPowersAction=function(settings){Action.call(this,"Multiply powers");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,MultiplyPowersAction);MultiplyPowersAction.prototype.split=function(n){if(n.is_group("power"))return{base:n.children[0],exp:n.children[1]};else return{base:n,exp:new Exponent(new Num(1))}};MultiplyPowersAction.prototype.match=function(node){if(node.is_group("power"))node=node.parent;if(!node.ls||!node.is_group("mul"))return false;var s1=this.split(node.ls.children[1]),s2=this.split(node.children[1]);if(!s1||!s2||s1.base.to_ascii()!=s2.base.to_ascii())return false;return true};MultiplyPowersAction.prototype.doInPlace=function(callback){this.initNodeMap();if(this.actor.is_group("power"))this.actor=this.actor.parent;var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var ls=node.ls.children[1],rs=node.children[1];var old_times_sign=this.actor.children[0];this.updateNodeMap(this.actor,ls.parent);this.updateNodeMap(this.actor.children[0],ls.parent.children[0]);if(ls.is_group("power")&&rs.is_group("power")){this.updateNodeMap(this.actor.children[1].children[0].get_mapping_to(ls.parent.children[1].children[0]))}else{this.updateNodeMap(this.actor.children[1].get_mapping_to(ls))}if(!ls.is_group("power")){var power=Exponent.prototype.createGroup();var p=ls.parent;var idx=Tree.remove(ls);power.append(ls);power.append(new Exponent(new Num(1)));Tree.insert(p,idx,power);ls=power}var s1=this.split(ls),s2=this.split(rs);Tree.remove(rs.parent);var exp_val=s1.exp.children[0],sum;if(!exp_val.is_group("sum")){var p=exp_val.parent;Tree.remove(exp_val);sum=AddSub.prototype.createGroup();sum.append(new AddSub(exp_val));p.append(sum)}else sum=exp;var addend_count=1;if(s2.exp.children[0].is_group("sum")){sum.append_range(s2.exp.children[0].children);addend_count=s2.exp.children[0].children.length}else sum.append(new AddSub(s2.exp.children[0]));Brackets.handle(sum);this.updateNodeMap(old_times_sign,sum.children[sum.children.length-addend_count].children[0]);this.cleanup(node.parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};var mpa=new MultiplyPowersAction;MulDiv.prototype.add_action_handler(mpa);Power.prototype.add_action_handler(mpa)})();(function(){var NegationAction=function(settings){Action.call(this,"negation");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,NegationAction);NegationAction.prototype.match=function(node){if(Num.get_value(node.children[1])===-1&&node.ls)return true;if(node.ls&&node.ls.children&&Num.get_value(node.ls.children[1])===-1)return true;return false};NegationAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var self=this;this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var neg=function(mul_minus1,other_mul){var child=other_mul.children[1],old_mul_minus1=self.getOldTreeNode(mul_minus1),old_minus1=old_mul_minus1.children[1],old_other_mul=self.getOldTreeNode(other_mul);Tree.remove(mul_minus1);if(child.is_group("sign")&&child.children[1]&&!child.children[1].is_group("sign")){var x=child.children[1];self.updateNodeMap(old_other_mul.children[1].children[0],x);self.updateNodeMap(old_minus1,x);self.updateNodeMap(old_minus1.children[0],x);self.updateNodeMap(old_minus1.children[1],x);child.replace_with(x)}else{var s=new Sign;s.append(new Sym("-"));self.updateNodeMap(old_minus1,s);self.updateNodeMap(old_minus1.children[0],s.children[0]);self.updateNodeMap(old_minus1.children[1],child);child.remove();s.append(child);other_mul.append(s)}self.updateNodeMap(old_mul_minus1,other_mul);self.updateNodeMap(old_mul_minus1.children[0],other_mul.children[0])};if(Num.get_value(node.children[1])===-1&&node.ls){neg(node,node.ls);this.cleanup(node.ls)}else{neg(node.ls,node);this.cleanup(node)}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return this};MulDiv.prototype.add_action_handler(new NegationAction)})();(function(){var MultiplyFractionsAction=function(settings){Action.call(this,"multiply fractions");this.priority=1;if(settings)this.actor=settings.actor};gmath.inherit(Action,MultiplyFractionsAction);MultiplyFractionsAction.prototype.match=function(node){if(!node.is_group("mul")||!node.ls)return false;var l=node.ls,r=node,p=node.parent;var frac1=l.children[1],frac2=r.children[1];if(!(frac1.is_group("fraction")&&frac2.is_group("fraction")))return false;return true};MultiplyFractionsAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var l=node.ls,r=node,p=node.parent;var frac1=l.children[1],frac2=r.children[1];var old_frac2=this.actor.children[1];this.updateNodeMap(old_frac2.get_fraction_bar(),frac1.get_fraction_bar());this.updateNodeMap(this.actor,l);this.updateNodeMap(this.actor.children[0],l.children[0]);Tree.remove(r);var top=frac2.get_top(),bottom=frac2.get_bottom();for(var i=0;i<top.length;i++)frac1.append(top[i]);for(var i=0;i<bottom.length;i++)frac1.append(bottom[i]);for(var i=0;i<frac1.children.length;i++){var c=frac1.children[i];if(c.has_children())Brackets.handle(c.children[1])}this.cleanup(p);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return this};MulDiv.prototype.add_action_handler(new MultiplyFractionsAction)})();(function(){function mapRelativePaths(oldPath,relPath,root,map){var curr=root;map[oldPath]=[relPath];if(curr.has_children()){for(var i=0;i<curr.children.length;i++){mapRelativePaths(oldPath.concat(i),relPath.concat(i),root.children[i],map)}}}var AddFractionsAction=function(settings){Action.call(this,"add fractions");this.priority=1;if(settings){this.actor=settings.actor}};gmath.inherit(Action,AddFractionsAction);AddFractionsAction.prototype.match=function(node){if(!node.ls)return false;var l=node.ls,r=node;var frac1=l.children[1],frac2=r.children[1];if(!(frac1.is_group("fraction")&&frac2.is_group("fraction")))return false;var to_ascii=function(n){return n.to_ascii()};var den1=frac1.get_bottom(),den2=frac2.get_bottom();if(den1.map(to_ascii).join("")!==den2.map(to_ascii).join(""))return false;return true};AddFractionsAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var old_frac2=this.actor.children[1];var frac2Bottom=this.actor.children[1].get_bottom();this.addTouchedNodes(this.actor);this.addTouchedNodes(this.actor.ls);var l=node.ls,r=node,p=node.parent;var frac1=l.children[1],frac2=r.children[1];var idx=Tree.remove(l);Tree.remove(r);Tree.remove(frac1);Tree.remove(frac2);var frac1Bottom=frac1.get_bottom();this.updateNodeMap(old_frac2.get_fraction_bar(),frac1.get_fraction_bar());for(var i=0;i<frac2Bottom.length;i++){this.updateNodeMap(frac2Bottom[i].get_mapping_to(frac1Bottom[i]))}var numerator_into_addsub=function(num,addsub){Tree.remove_range(num);if(num.length==1){Tree.append(addsub,num[0].children[1]);Brackets.handle(addsub.children[1],true)}else{var p=new ProductFraction;Tree.insert_range(p,0,num);Tree.append(addsub,p);Brackets.handle(addsub.children[1],true)}};numerator_into_addsub(frac1.get_top(),l);numerator_into_addsub(frac2.get_top(),r);var sum=l.createGroup();sum.append(l);sum.append(r);var num=new MulDiv(num);var newSym=new Sym("*");Tree.append(num,newSym);Tree.append(num,sum);frac1.append(num);var newAddend=new AddSub(frac1,"add");
Tree.insert(p,idx,newAddend);Brackets.handle(sum);this.cleanup(sum);this.cleanup(p);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else{console.warn("no callback function was passed to this async method.");return true}};AddSub.prototype.add_action_handler(new AddFractionsAction)})();EqTree.prototype.NumDenomCancelAction=function(){var NumDenomCancelAction=function(settings){Action.call(this,"cancel numerator and denominator");if(settings){this.actors=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,NumDenomCancelAction);NumDenomCancelAction.prototype.match=function(eqtree,n1,n2){var frac=n1.parent;while(frac&&!frac.is_group("fraction"))frac=frac.parent;if(!frac){eqtree.mistake();return false}if(this.isCancellable(n1,n2)){return true}else{eqtree.mistake();return false}};NumDenomCancelAction.prototype.to_ascii=function(productFraction){var top=productFraction.get_top(),bottom=productFraction.get_bottom();var top_str="",bottom_str="";for(var i=0;i<top.length;i++){top_str+=i==0?top[i].children[1].to_ascii():top[i].to_ascii()}if(bottom.length==0)return top_str;for(var i=0;i<bottom.length;i++){bottom_str+=(i==0?"":"*")+bottom[i].children[1].to_ascii()}if(top.length>1)top_str="("+top_str+")";if(bottom.length>1)bottom_str="("+bottom_str+")";var str=top_str+"/"+bottom_str;if(!Brackets.is_optional(productFraction)||productFraction.parent.commutative)return"("+str+")";else return str};NumDenomCancelAction.prototype.isCancellable=function(n1,n2){var p=n1.parent;if(!p.is_group("fraction")||n2.parent!==p)return false;if(!(n1.is_group("mul")&&n2.is_group("div")||n1.is_group("div")&&n2.is_group("mul")))return false;var c1=n1.children[1],c2=n2.children[1];if(c1.to_ascii()==c2.to_ascii())return true;if(c1.is_group("sign")&&c1.children[1].to_ascii()===c2.to_ascii())return true;if(c2.is_group("sign")&&c2.children[1].to_ascii()===c1.to_ascii())return true;if(c2 instanceof Num&&Num.get_value(c2)===1)return true;if(Num.is_num(c2)&&Num.get_value(c2)===-1)return true;var tree=n1;while(tree.parent)tree=tree.parent;var val1=tree.numeric_value(n1.children[1]);var val2=tree.numeric_value(n2.children[1]);if(val1!==null&&val2!==null&&!isNaN(val1)&&!isNaN(val2)){var gcd=this.getGCD(val1,val2);if(Math.abs(val1)>=Math.abs(val2)&&Math.abs(val2)!==1&&val1%val2===0)return true;if(Math.abs(val2)>=Math.abs(val1)&&Math.abs(val1)!==1&&val2%val1===0)return true;if(gcd!==1)return true}return false};NumDenomCancelAction.prototype.factorize=function(node,f1,f2){var t1=new MulDiv(new Num(f1),node.value),t2=new MulDiv(new Num(f2),node.value);this.updateNodeMap(this.getOldTreeNode(node).get_mapping_to(t1));this.extendNodeMap(this.getOldTreeNode(node).get_mapping_to(t2));var idx=Tree.remove(node);Tree.insert(node.parent,idx,t1);Tree.insert(node.parent,idx,t2)};NumDenomCancelAction.prototype.getGCD=function(a,b){if(a<0)a=-a;if(b<0)b=-b;if(b>a){var temp=a;a=b;b=temp}while(true){a%=b;if(a==0)return b;b%=a;if(b==0)return a}};NumDenomCancelAction.prototype.doInPlace=function(callback){this.initNodeMap();var node,n1,n2,p;node=this.actors[0];while(!node.is_group("fraction"))node=node.parent;node=this.getNewTreeNode(node);this.addTouchedNodes(this.actors[0]);this.addTouchedNodes(this.actors[1]);n1=this.getNewTreeNode(this.actors[0]);n2=this.getNewTreeNode(this.actors[1]);p=n1.parent;var c1=n1.children[1],c2=n2.children[1];if(c1.to_ascii()==c2.to_ascii()){Tree.remove(n1);Tree.remove(n2)}else if(c2 instanceof Num&&c2.value==1){Tree.remove(n2)}else if(c2 instanceof Sign&&c2.children[1]instanceof Num&&c2.children[1].value==1){if(c1.is_group("sign")){this.updateNodeMap(this.getOldTreeNode(c1),c1.children[1]);c1.replace_with(c1.children[1])}else{var idx=c1.remove();var s=new Sign(c1);n1.insert(idx,s);this.updateNodeMap(this.getOldTreeNode(c1),s)}Tree.remove(n2)}else if(c1.is_group("sign")&&c1.children[1].to_ascii()===c2.to_ascii()){var minus1=new Num(-1);this.updateNodeMap(this.getOldTreeNode(c1),minus1);Tree.replace(c1,minus1);Tree.remove(n2)}else if(c2.is_group("sign")&&c2.children[1].to_ascii()===c1.to_ascii()){if(node.get_bottom().length==1){var minus1=new Num(-1);this.updateNodeMap(this.getOldTreeNode(c1),minus1);Tree.replace(c1,new Num(-1));Tree.remove(n2)}else{this.updateNodeMap(this.getOldTreeNode(c2),minus1);Tree.remove(n1);var minus1=new Num(-1);Tree.replace(c2,minus1)}}else{var tree=n1;while(tree.parent)tree=tree.parent;var val1=tree.numeric_value(n1.children[1]);var val2=tree.numeric_value(n2.children[1]);if(val1!==null&&val2!==null&&!isNaN(val1)&&!isNaN(val2)){var gcd=this.getGCD(val1,val2);if(Math.abs(val1)>=Math.abs(val2)&&Math.abs(val2)!==1&&val1%val2===0){this.factorize(n1,val2,Math.floor(val1/val2))}else if(Math.abs(val2)>=Math.abs(val1)&&Math.abs(val1)!==1&&val2%val1===0){this.factorize(n2,val1,Math.floor(val2/val1))}else if(gcd!==1){this.factorize(n1,Math.floor(val1/gcd),gcd);this.factorize(n2,Math.floor(val2/gcd),gcd)}}}while(node&&this.cleanup(node))node=node.parent;this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};return new NumDenomCancelAction}();(function(){var FractionMagSimplificationAction=function(settings){Action.call(this,"cancel numerator and denominator");if(settings){this.actor=settings.actor;this.priority=settings.priority||0}};gmath.inherit(Action,FractionMagSimplificationAction);FractionMagSimplificationAction.prototype.match=function(node){if(!node.is_group("fraction"))return false;var numerator=node.get_top();var denominator=node.get_bottom();if(numerator.length!==1||denominator.length!==1)return false;numerator=numerator[0],denominator=denominator[0];return Num.is_num(numerator.children[1])&&Num.is_num(denominator.children[1])};FractionMagSimplificationAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);var eqtree=node.parent;this.addTouchedNodes(this.actor);var numerator=node.get_top();var denominator=node.get_bottom();numerator=numerator[0],denominator=denominator[0];var resultNum=Num.get_value(numerator.children[1])/Num.get_value(denominator.children[1]);resultNum=Math.round(100*resultNum)/100;var result=new Num(resultNum);if(numerator.children[1]instanceof Sign||denominator.children[1]instanceof Sign){this.updateNodeMap(this.actor.children[0].children[1].get_mapping_to(result));this.updateNodeMap(this.actor.children[2].children[1].get_mapping_to(result))}else{this.updateNodeMap(this.actor.get_mapping_to(result))}var idx=node.remove();eqtree.insert(idx,result);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};ProductFraction.prototype.add_action_handler(new FractionMagSimplificationAction);return new FractionMagSimplificationAction})();(function(){var ProductFractionCleanup=function(settings){Action.call(this,"product-fraction cleanup action");if(settings)this.productFraction=settings.actor};gmath.inherit(Action,ProductFractionCleanup);ProductFractionCleanup.prototype.match=function(node){var numeratorLength=node.get_top().length,denominatorLength=node.get_bottom().length;if(numeratorLength===0&&denominatorLength===0)return true;if(node.value==="product"&&denominatorLength>0)return true;if(node.value==="fraction"&&denominatorLength===0)return true;if(node.value==="fraction"&&numeratorLength===0)return true;if(numeratorLength===1&&denominatorLength===0)return true;return false};ProductFractionCleanup.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.productFraction);var numeratorLength=node.get_top().length,denominatorLength=node.get_bottom().length,map;if(numeratorLength===0&&denominatorLength===0){var identity=new Num(1);map=Tree.get_mapping_between(this.productFraction,identity);this.updateNodeMap(map);Tree.replace(node,identity)}if(this.productFraction.value==="product"&&denominatorLength>0){node.invert()}if(this.productFraction.value==="fraction"&&denominatorLength===0){node.invert()}if(this.productFraction.value==="fraction"&&numeratorLength===0){Tree.insert(node,0,new MulDiv(new Num(1)))}if(numeratorLength===1&&denominatorLength===0){var val=node.get_top()[0].children[1];this.updateNodeMap(this.productFraction,val);this.updateNodeMap(this.productFraction.children[0],val);this.updateNodeMap(this.productFraction.children[0].children[0],val);Tree.replace(node,val);Brackets.handle(val,true)}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return this};ProductFraction.prototype.cleanupAction=new ProductFractionCleanup})();SplitNumberAction=function(){var SplitNumberAction=function(settings){Action.call(this,"n => (n-1) + 1");this.priority=0;if(settings)this.actor=settings.actor};gmath.inherit(Action,SplitNumberAction);SplitNumberAction.prototype.match=function(node){return node instanceof Num&&node.value>1};SplitNumberAction.prototype.doInPlace=function(callback){this.initNodeMap();var num=this.getNewTreeNode(this.actor);this.addTouchedNodes(this.actor);var parent=num.parent;var idx=num.remove();num.value--;var newSum=AddSub.prototype.createGroup();newSum.append(new AddSub(num));newSum.append(new AddSub(new Num(1)));this.resultNodes=newSum.children.slice();this.updateNodeMap(this.actor.get_mapping_to(newSum));parent.insert(idx,newSum);Brackets.handle(newSum);this.cleanup(parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return true};return new SplitNumberAction}();SplitProductAction=function(){var SplitProductAction=function(settings){Action.call(this,"n*x => (n-1)*x + x");this.priority=1;if(settings){this.actor=settings.actor;if("priority"in settings)this.priority=settings.priority}};gmath.inherit(Action,SplitProductAction);SplitProductAction.prototype.match=function(node){return node.is_group("mul")&&node.children[1]instanceof Num&&node.children[1].value>1&&node.rs};SplitProductAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor),parentProd=node.parent,factor=node.children[1];this.addTouchedNodes(this.actor);factor.value--;var muls=parentProd.children.slice(parentProd.children.indexOf(node));var old_muls=this.getOldTreeNode(muls);var idx=Tree.remove_range(muls);var newSum=AddSub.prototype.createGroup();var prod1=MulDiv.prototype.createGroup();var prod2=MulDiv.prototype.createGroup();var cloned_muls;if(factor.value===1){node.remove();muls=muls.slice(1);prod1.insert_range(0,muls);cloned_muls=Tree.clone(muls);prod2.insert_range(0,cloned_muls);this.extendNodeMap(Tree.get_mapping_between(old_muls.slice(1),cloned_muls))}else{prod1.insert_range(0,muls);cloned_muls=Tree.clone(muls);prod2.insert_range(0,cloned_muls);prod2.children[0].remove();this.extendNodeMap(Tree.get_mapping_between(old_muls,cloned_muls))}newSum.append(new AddSub(prod1));newSum.append(new AddSub(prod2));var newMul=new MulDiv(newSum);parentProd.insert(idx,newMul);this.cleanup(prod1);this.cleanup(prod2);var parentSum=parentProd.parent;if(this.cleanup(parentProd))this.cleanup(parentSum);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return true};SplitProductAction.prototype.mapIndex=function(){map={};return function(node){return map[node]}};return new SplitProductAction}();SplitPowerAction=function(){var SplitPowerAction=function(settings){Action.call(this,"x^n => x^(n-1) * x");this.priority=2;if(settings){this.actor=settings.actor;if("priority"in settings)this.priority=settings.priority}};gmath.inherit(Action,SplitPowerAction);SplitPowerAction.prototype.match=function(node){return node.is_group("exponent")&&node.children[0]instanceof Num&&node.children[0].value>=1};SplitPowerAction.prototype.doInPlace=function(callback){this.initNodeMap();var exp=this.getNewTreeNode(this.actor),pow=exp.parent,parent=pow.parent;this.addTouchedNodes(this.actor);var idx=pow.remove();var newProd=MulDiv.prototype.createGroup();newProd.append(new MulDiv(pow));var newItem=Tree.clone(pow.children[0]);this.extendNodeMap(this.actor.parent.children[0].get_mapping_to(newItem));newProd.append(new MulDiv(newItem));var expVal=exp.children[0];expVal.value--;this.extendNodeMap(this.actor.children[0],newItem.parent);if(expVal.value===1){var base=pow.children[0];pow.remove();newProd.children[0].append(base);this.extendNodeMap(this.actor.children[0],base.parent)}else if(expVal.value===0){newProd.children[0].remove()}this.resultNodes=newProd.children.slice();parent.insert(idx,newProd);this.cleanup(parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return true};return new SplitPowerAction}();SplitPowerSumAction=function(){var SplitPowerSumAction=function(settings){Action.call(this,"x^(n1+n2+...+nm) => x^(n1+n2+...) * x^(nm)");this.priority=3;if(settings)this.actor=settings.actor};gmath.inherit(Action,SplitPowerSumAction);SplitPowerSumAction.prototype.match=function(node){return node.is_group("exponent")&&(node.children[0].is_group("brackets")&&node.children[0].children[1].is_group("sum")||node.children[0].is_group("sum"))};SplitPowerSumAction.prototype.doInPlace=function(callback){this.initNodeMap();var exp=this.getNewTreeNode(this.actor),pow=exp.parent,parent=pow.parent,sum=exp.children[0];if(sum.is_group("brackets"))sum=sum.children[1];var last_addend=sum.children[sum.children.length-1],old_plus=this.getOldTreeNode(last_addend.children[0]);this.addTouchedNodes(this.actor.parent);var idx=pow.remove();var newProd=MulDiv.prototype.createGroup();newProd.append(new MulDiv(pow));var newPow=Tree.clone(pow);newProd.append(new MulDiv(newPow));newPow.children[1].children[0].remove();last_addend.remove();var sum2=last_addend.createGroup();sum2.append(last_addend);newPow.children[1].append(sum2);parent.insert(idx,newProd);if(old_plus.parent.is_group("add"))this.updateNodeMap(old_plus,newProd.children[1].children[0]);else this.extendNodeMap(old_plus,newProd.children[1].children[0]);this.cleanup(last_addend);this.cleanup(sum.children[0]);this.cleanup(parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return true};return new SplitPowerSumAction}();gmath.actions.DistributeIntoBracketsAction=function(){var DistributeIntoBracketsAction=function(settings){Action.call(this,"distribute");if(settings){this.nodes=settings.nodes;this.target=settings.target;this.side=settings.side}};gmath.inherit(Action,DistributeIntoBracketsAction);DistributeIntoBracketsAction.prototype.getAllAvailableActions=function(nodes){var res=[];if(nodes.length===0)return res;var root=nodes[0].get_root();if(!nodes[0].is_group("mul")&&!nodes[0].is_group("div"))return[];var self=this;function check(target){if(target.children[1]&&target.children[1].is_group("brackets")){n=target.children[1].children[1];if(self.match(nodes,n,"around"))res.push(self.createBoundAction(root,{nodes:nodes,target:n,side:"around"}))}}var n=nodes[0];while(n=n.ls)check(n);n=nodes[nodes.length-1];while(n=n.rs)check(n);return res};DistributeIntoBracketsAction.prototype.match=function(nodes,target,side){if(nodes.length===0)return false;if(target.value==="("||target.value===")")return false;var brackets=target.parent;if(!brackets.parent)return false;var val=brackets.parent.value;if(val!=="mul"&&val!=="div")return false;for(var i=0;i<nodes.length;i++)if(nodes[i].value!==val)return false;if(brackets.parent.parent!==nodes[0].parent)return false;if(!brackets.is_group("brackets"))return false;if(!brackets.children[1].is_group("sum"))return false;if(!nodes[0].commutative)return false;if(side==="left-of"&&brackets.ls===nodes[nodes.length-1])return false;if(side==="right-of"&&brackets.rs===nodes[0])return false;return true};DistributeIntoBracketsAction.prototype.doInPlace=function(callback){this.initNodeMap();var nodes=this.getNewTreeNode(this.nodes);var target=this.getNewTreeNode(this.target);var old_brackets_l=this.target.parent.children[0],old_brackets_r=this.target.parent.children[2];var bracketGroup=target.parent;var varsOnLeftOrRight;if(nodes[nodes.length-1].rs&&nodes[nodes.length-1].rs.children[1]&&nodes[nodes.length-1].rs.children[1]===bracketGroup){varsOnLeftOrRight="left"}if(nodes[0].ls&&nodes[0].ls.children[1]===bracketGroup){varsOnLeftOrRight="right"}var parentProd=bracketGroup.parent.parent,sum=bracketGroup.children[1];Tree.remove_range(nodes);this.distributeIntoSum(sum,nodes,varsOnLeftOrRight);if(parentProd.cleanupAction)this.cleanup(parentProd);var sum_parent=sum.parent;if(!sum_parent.is_group("brackets")){var idx=sum.remove();var newBrackets=new Brackets(sum);Tree.insert(sum_parent,idx,newBrackets);this.updateNodeMap(old_brackets_l.parent,newBrackets);this.updateNodeMap(old_brackets_l,newBrackets.children[0]);this.updateNodeMap(old_brackets_r,newBrackets.children[2])}if(typeof callback==="function")callback(this);else return true};DistributeIntoBracketsAction.prototype.distributeIntoSum=function(sum,nodes,varSide){var N=sum.children.length;var turn_into_muls=function(n){if(n.is_group("div"))n.invert()};for(var i=0;i<N;i++){var target=sum.children[i].children[1],newProd,cloned;target.remove();if(target.is_group("product"))newProd=target;else{newProd=new ProductFraction;newProd.append(new MulDiv(target))}if(varSide==="left"&&i===0||varSide==="right"&&i===N-1){cloned=nodes}else cloned=Tree.clone(nodes);cloned.forEach(turn_into_muls);this.extendNodeMap(Tree.get_mapping_between(this.nodes,cloned));var idx=varSide==="left"?0:newProd.children.length;newProd.insert_range(idx,cloned);sum.children[i].append(newProd)}};return new DistributeIntoBracketsAction}();EqTree.prototype.move_actions.push(gmath.actions.DistributeIntoBracketsAction);gmath.actions.FactorOutOfBracketsAction=function(){var FactorOutOfBracketsAction=function(settings){Action.call(this,"factor out");if(settings){this.nodes=settings.nodes;this.target=settings.target;this.side=settings.target.ls?"right-of":"left-of";this.priority=settings.priority||0}};gmath.inherit(Action,FactorOutOfBracketsAction);FactorOutOfBracketsAction.prototype.getAllAvailableActions=function(nodes){if(nodes.length===0)return[];var res=[],n0=nodes[0],self=this,root=nodes[0].get_root();while(n0.parent&&!n0.is_group("brackets"))n0=n0.parent;if(!n0.is_group("brackets"))return[];if(this.match(nodes,n0.children[0]))res.push(n0.children[0]);if(this.match(nodes,n0.children[2]))res.push(n0.children[2]);return res.map(function(target){return self.createBoundAction(root,{nodes:nodes,target:target})})};FactorOutOfBracketsAction.prototype.match=function(nodes,target){if(nodes.length<2)return false;if(target.value!=="("&&target.value!==")")return false;var nodeRanges=FactorOutOfBracketsAction.prototype.groupNodeRanges(nodes);var rangeSize=nodeRanges[0].length;nodeRanges.forEach(function(range){if(range.length!==rangeSize)return false});for(var i=0;i<rangeSize;i++){var asciiA;if(nodeRanges[0][i].value==="mul")asciiA=nodeRanges[0][i].children[1].to_ascii();else asciiA=nodeRanges[0][i].to_ascii();for(var j=0;j<nodeRanges.length;j++){var asciiB;if(nodeRanges[j][i].value==="mul")asciiB=nodeRanges[j][i].children[1].to_ascii();else asciiB=nodeRanges[j][i].to_ascii();if(asciiB!==asciiA)return false}}var cca=Tree.get_cca(nodes);return cca.is_group("sum")&&cca.parent===target.parent};FactorOutOfBracketsAction.prototype.groupNodeRanges=function(nodes){var groupedNodes=[];var group=[nodes[0]];groupedNodes.push(group);for(var i=1;i<nodes.length;i++){if(nodes[i-1].rs===nodes[i]){group.push(nodes[i])}else{group=[nodes[i]];groupedNodes.push(group)}}return groupedNodes};FactorOutOfBracketsAction.prototype.doInPlace=function(callback){this.initNodeMap();var nodes=this.getNewTreeNode(this.nodes);var bracketGroup=this.findBracketGroup(nodes);var nodeRanges=this.groupNodeRanges(nodes);var oldRanges=nodeRanges.map(this.getOldTreeNode.bind(this));this.removeRangesFromSum(nodeRanges);var parent=this.replaceBracketGroupWithFactoredProduct(bracketGroup,nodeRanges,oldRanges);if(parent.cleanupAction)this.cleanup(parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};FactorOutOfBracketsAction.prototype.findBracketGroup=function(nodes){var node=nodes[0];if(node&&node.parent&&node.parent.parent&&node.parent.parent.is_group("sum")&&node.parent.parent.parent&&node.parent.parent.parent.is_group("brackets"))return node.parent.parent.parent;if(node&&node.parent&&node.parent.is_group("product")&&node.parent.parent&&node.parent.parent.parent&&node.parent.parent.parent.is_group("sum")&&node.parent.parent.parent.parent&&node.parent.parent.parent.parent.is_group("brackets"))return node.parent.parent.parent.parent;throw"Attempting to factor from invalid structure."};FactorOutOfBracketsAction.prototype.removeRangesFromSum=function(nodeRanges){for(var i=0;i<nodeRanges.length;i++){var range=nodeRanges[i];var rangeParent=nodeRanges[i][0].parent;if(range.length===rangeParent.children.length){var tree=rangeParent.parent;rangeParent.remove();Tree.remove_range(range);tree.append(new Num(1));this.cleanup(tree)}else if(rangeParent.value==="add"||rangeParent.value==="sub"&&range.length===1){range[0].remove();rangeParent.append(new Num(1))}else{Tree.remove_range(nodeRanges[i]);this.cleanup(rangeParent)}}};FactorOutOfBracketsAction.prototype.replaceBracketGroupWithFactoredProduct=function(bracketGroup,nodeRanges,oldRanges){var factoredProd=MulDiv.prototype.createGroup();var parent=bracketGroup.parent;var idx=bracketGroup.remove();if(this.side==="left-of"){var range=nodeRanges[0];if(range.length===1&&range[0].value!=="mul"){range=[new MulDiv(range[0])]}factoredProd.append_range(range);factoredProd.append(new MulDiv(bracketGroup));for(var i=0;i<oldRanges.length;i++){if(oldRanges[i].length===1&&!oldRanges[i][0].is_group("mul")){this.updateNodeMap(oldRanges[i][0],range[0])}else{this.updateNodeMap(Tree.get_mapping_between(oldRanges[i],range))}}}else{var range=nodeRanges[nodeRanges.length-1];if(range.length===1&&range[0].value!=="mul"){range=[new MulDiv(range[0])]}factoredProd.append(new MulDiv(bracketGroup));factoredProd.append_range(range);for(var i=0;i<oldRanges.length;i++){if(oldRanges[i].length===1&&!oldRanges[i][0].is_group("mul")){this.updateNodeMap(oldRanges[i][0],range[0])}else{this.updateNodeMap(Tree.get_mapping_between(oldRanges[i],range))}}}Tree.insert(parent,idx,factoredProd);return parent};FactorOutOfBracketsAction.prototype.mapIndex=function(){return function(){}};return new FactorOutOfBracketsAction}();EqTree.prototype.move_actions.push(gmath.actions.FactorOutOfBracketsAction);EqTree.prototype.SubstitutionAction=function(){var SubstitutionAction=function(settings){Action.call(this,"substitution");if(settings){this.sourceEq=settings.source;this.target_ranges=settings.target}};gmath.inherit(Action,SubstitutionAction);SubstitutionAction.prototype.match=function(source,ns){if(!source.parent)source=source.children[0];if(!source.is_group("equals"))return false;var src_str=source.children[0].to_ascii();var check_fn=has_same_val_fn(src_str);return check_fn(ns)};function toAscii(ns){if(ns.length===1&&ns[0].hidden)return"";return ns.map(function(n){return n.to_ascii()}).join("")}function isLeadingCommutativeOp(node){return node.is_group()&&node.commutative&&node.associative}function toAsciiNoLeadingOp(ns){if(ns.length===0)return"";if(ns.length===1&&ns[0].hidden)return"";var str=ns.map(function(n){return n.to_ascii()}).join("");if(ns.length===1)return str;if(isLeadingCommutativeOp(ns[0]))return str.substring(ns[0].children[0].to_ascii().length);return str}SubstitutionAction.prototype.findAllMatches=function(source,targetTree){if(!source.parent)source=source.children[0];if(!source.is_group("equals"))return false;if(!targetTree.parent)targetTree=targetTree.children[0];var src_str=source.children[0].to_ascii();var res=targetTree.filterRange(has_same_val_fn(src_str));return res};SubstitutionAction.prototype.doInPlace=function(callback){this.initNodeMap();var old_target_ranges=this.target_ranges,new_target_ranges=old_target_ranges.map(this.getNewTreeNode.bind(this));for(var i=0;i<new_target_ranges.length;i++){var targets=new_target_ranges[i];var p=targets[0].parent;var idx=Tree.remove_range(targets);var substitution=Tree.clone(this.sourceEq.children[0].children[2]);if(targets.length>1){substitution=new targets[0].constructor(substitution)}p.insert(idx,substitution);Brackets.handle(substitution);this.cleanup(p)}this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);return true};function range_contains_all_siblings(ns){return ns.length===ns[0].parent.children.length}function is_not_root(n){return n.parent}function has_same_val_fn(val){return function(ns){if(ns.length===0)return false;if(!ns[0].parent)return false;if(is_not_root(ns[0].parent)&&range_contains_all_siblings(ns))return false;return toAscii(ns)===val||toAsciiNoLeadingOp(ns)===val}}return new SubstitutionAction}();TriggerFactoringAction=function(){var TriggerFactoringAction=function(settings){Action.call(this,"general factoring");this.priority=0;this.side="around";if(settings){this.DLOfSum=settings.dl;this.viewOfSum=settings.view;this.target=settings.sum;this.callback=settings.callback}};gmath.inherit(Action,TriggerFactoringAction);TriggerFactoringAction.prototype.match=function(sum,factor){return selectFactorsInSum(sum,factor)};TriggerFactoringAction.prototype.doInPlace=function(){this.callback(this.viewOfSum,this.target,this.DLOfSum)};var selectFactorsInSum=function(sum,factors){var matchingNodes;matchingNodes=collectMatchingNodesInSum(sum,factors);matchingNodes=filterByStructure(matchingNodes,sum);var selectedNodes=[];for(var i=0;i<matchingNodes.length;i++){if(matchingNodes[i].length===0)return false}for(var i=0;i<matchingNodes.length;i++){if(matchingNodes[i])selectedNodes.push(matchingNodes[i][matchingNodes[i].length-1])}for(var i=0;i<selectedNodes.length;i++){if(!Array.isArray(selectedNodes[i])&&selectedNodes[i].parent.value!=="add"&&selectedNodes[i].parent.value!=="sub")selectedNodes[i]=selectedNodes[i].parent}return selectedNodes.length===sum.children.length?selectedNodes:false};var selectAllRangesWithMatchingValue=function(term,val){var res=[];term.for_each(function(n){var nval=n.to_ascii();if(nval.slice(0,1)==="*")nval=nval.substr(1);if(!n.hidden&&nval===val)res.push(n);else{var ns=[n];while(nval.length<val.length&&n.commutative&&n.rs){n=n.rs;nval+=n.to_ascii();ns.push(n)}if(nval===val)res.push(ns)}});return res};var collectMatchingNodesInSum=function(sum,factors){var sumFactors=[];for(var i=0;i<sum.children.length;i++){var addend=sum.children[i],term=addend.children[1];sumFactors.push(selectAllRangesWithMatchingValue(term,factors.to_ascii()))}return sumFactors};function select_by_value(val){return function(n){return!n.hidden&&n.to_ascii()===val}}var filterByStructure=function(factorCollection,sum){var isSingleTermInAddend=function(node){return node.parent&&(node.parent.value==="add"||node.parent.value==="sub")&&node.parent.parent&&node.parent.parent==sum};var isSingleTermFromProduct=function(node){return node.parent&&node.parent.value==="mul"&&node.parent.parent&&node.parent.parent.is_group("product")&&node.parent.parent.parent&&node.parent.parent.parent.parent&&node.parent.parent.parent.parent==sum};var isOneTermOfManyFromProduct=function(node){return node.value==="mul"&&node.parent&&node.parent.is_group("product")&&node.parent.parent&&node.parent.parent.parent&&node.parent.parent.parent==sum};var isChildOfAddendOrProduct=function(node){var boolForLs=true;if(Array.isArray(node)){for(var i=0;i<node.length;i++)if(!isOneTermOfManyFromProduct(node[i]))boolForLs=false}else{return isSingleTermInAddend(node)||isSingleTermFromProduct(node)}return boolForLs};for(var i=0;i<factorCollection.length;i++){factorCollection[i]=factorCollection[i].filter(isChildOfAddendOrProduct)}return factorCollection};var containsFactor=function(sum,factor){var deconstructedSum=deconstruct(sum),commonFactorsInSum=searchForCommonFactors(deepCopyOfArray(deconstructedSum));var deconstructedFactor=factor.deconstruct();return sumContainsFactors(commonFactorsInSum,deconstructedFactor)};var deepCopyOfArray=function(array){var newArr=[];for(var i=0;i<array.length;i++){newArr.push(array[i].slice())}return newArr};var deconstruct=function(sum){var deconstructedTerms=[];for(var i=0;i<sum.children.length;i++){deconstructedTerms.push(deconstructTerm(sum.children[i]))}return deconstructedTerms};var deconstructTerm=function(addsub){var term=addsub.children[1];if(addsub.value==="add")return term.deconstruct();else return appendNegativeIdentity(term.deconstruct())};var appendIdentity=function(factors){factors.push(new Num(1));return factors};var appendNegativeIdentity=function(factors){factors.push(new Num(-1));return factors};var searchForCommonFactors=function(elements){var commonFactors=elements[0].slice();for(var i=0;i<elements.length;i++){removeUncommonFactors(commonFactors,elements[i])}return commonFactors};var removeUncommonFactors=function(commonFactors,someFactors){for(var i=0;i<commonFactors.length;){if(nodeIsUncommon(commonFactors[i],someFactors))commonFactors.splice(i,1);else i++}};var nodeIsUncommon=function(factor,factors){var ascii=factor.to_ascii();var isUncommon=true;for(var i=0;i<factors.length;){if(ascii===factors[i].to_ascii()){isUncommon=false;factors.splice(i,1);return isUncommon}else{i++}}return isUncommon};var sumContainsFactors=function(commonFactorsInSum,deconstructedFactors){var contains=true;for(var i=0;i<deconstructedFactors.length;i++){if(nodeIsUncommon(deconstructedFactors[i],commonFactorsInSum)){contains=false}}return contains};return new TriggerFactoringAction}();gmath.rules=gmath.rules||{};gmath.rules.distributes=function(mul_op,add_op,dir){dir=dir||"both";var name=mul_op.prototype.value+" "+(dir=="both"?"":dir+"-")+"distributes over "+add_op.prototype.value;var run=function(dir){var fact2,fact1;if(dir=="both"){if(!this.is_group(mul_op.prototype.name))return false;return run.call(this,"left")||run.call(this,"right")}else if(dir=="left"){fact2=this;fact1=this.ls}else if(dir=="right"){fact2=this.ls;fact1=this}else throw"direction must be left, right or both, not '"+dir+"'";if(!(fact1 instanceof mul_op))return;if(!fact2)return false;var sum=fact2.children[1];if(sum.is_group("brackets"))sum=sum.children[1];if(!sum.is_group(add_op.prototype.group_name))return false;Tree.remove(fact1);Tree.for_each(function(n){n.no_anim=true},fact1);for(var i=0;i<sum.children.length;i++){var add_block=sum.children[i];var addend=add_block.children[1];var clone=Tree.clone(fact1);if(addend instanceof Group&&addend.children[0]instanceof mul_op){if(dir=="left")Tree.insert(addend,0,clone);else Tree.append(addend,clone)}else{var i_prod=mul_op.prototype.createGroup();Tree.remove(addend);var m1=new mul_op(addend);Tree.replace(m1.children[0],Tree.clone(this.children[0]));Tree.append(i_prod,dir=="left"?clone:m1);Tree.append(i_prod,dir=="left"?m1:clone);Tree.append(add_block,i_prod);Brackets.handle(i_prod)}}fact2.clean_up();return true};mul_op.prototype.add_action_handler({name:name,run:function(){return run.call(this,dir)}})};gmath.rules=gmath.rules||{};gmath.rules.inverse_operation=function(op1,op2){op1.prototype.inverse=op2.prototype.value;op2.prototype.inverse=op1.prototype.value;var perform=function(){if(!this.ls)return false;if(this.ls instanceof this.getInverse()&&this.children[1].to_ascii()==this.ls.children[1].to_ascii()){Tree.remove(this.ls);var idx=Tree.remove(this);Tree.insert(this.parent,idx,new op1(Tree.clone(this.identity_element)));this.parent.clean_up();return true}return false};op1.prototype.add_action_handler({name:"inverse elements cancel out each other",run:perform});op2.prototype.add_action_handler({name:"inverse elements cancel out each other",run:perform})};gmath.rules=gmath.rules||{};gmath.rules.identity_element=function(op,ie){op.prototype.identity_element=ie;var name=ie.to_ascii()+" is the identity element of "+op.prototype.value;var ie_str=ie.to_ascii();var IdAction=function(settings){Action.call(this,name);if(settings)this.actor=settings.actor};gmath.inherit(Action,IdAction);
function matches(node){return node&&node.is_group(op.value)&&node.children.length==2&&node.children[1].to_ascii()==ie_str}IdAction.prototype.match=function(node){return matches(node)||matches(node.ls)};IdAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);if(matches(node)){this.addTouchedNodes(this.actor);node.remove()}else{this.addTouchedNodes(this.actor.ls);node.ls.remove()}this.cleanup(node.parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};op.prototype.add_action_handler(new IdAction)};gmath.rules=gmath.rules||{};gmath.rules.zero_element=function(op,zero_element){op.prototype.zero_element=zero_element;var ze=zero_element.to_ascii();var name=ze+" is the zero element of "+op.prototype.value;var ZeroAction=function(settings){Action.call(this,name);if(settings)this.actor=settings.actor};gmath.inherit(Action,ZeroAction);function matches(node){return node&&node.is_group(op.value)&&node.children.length==2&&node.children[1].to_ascii()==ze}ZeroAction.prototype.match=function(node){if(!node.ls)return false;return matches(node)||matches(node.ls)};ZeroAction.prototype.doInPlace=function(callback){this.initNodeMap();var node=this.getNewTreeNode(this.actor);if(matches(node)){this.addTouchedNodes(this.actor.ls);node.ls.remove()}else{this.addTouchedNodes(this.actor);node.remove()}this.cleanup(node.parent);this.removeDeletedNodesFromNodeMap();if(typeof callback==="function")callback(this);else return true};op.prototype.add_action_handler(new ZeroAction)};gmath.rules=gmath.rules||{};gmath.rules.init_all=function(){gmath.rules.identity_element(AddSub,new Num(0));gmath.rules.identity_element(MulDiv,new Num(1));gmath.rules.zero_element(MulDiv,new Num(0));gmath.rules.identity_element(And,new Bool("T"));gmath.rules.zero_element(And,new Bool("F"));gmath.rules.identity_element(Or,new Bool("F"));gmath.rules.zero_element(Or,new Bool("T"))};gmath.rules.init_all();mtouch_events=function(){var event=d3_eventDispatch(mtouch,"tap","dbltap","hold","drag","mdrag","touch","release"),target_el=null,fingers=[],id2finger={},last_taps=[],mouse_id="mouse",frame="client",connected=false,tap_max_time=250,tap_max_dist2=10*10,hold_time=500,hold_max_dist=10,hold_max_dist2=hold_max_dist*hold_max_dist,dbltap_max_delay=400,dbltap_max_dist=20;function mtouch(){target_el=this;connected(true)}var connected=mtouch.connected=function(arg){if(arguments.length==0)return connected;target_el.on("touchstart.mtouch",arg?touchstarted:null).on("mousedown.mtouch",arg?mousedown:null).on("touchmove.mtouch",arg?touchmoved:null).on("touchend.mtouch",arg?touchended:null).on("touchcancel.mtouch",arg?touchended:null);connected=arg;return this};mtouch.call=function(f){f.apply(mtouch,arguments);return this};mtouch.frame=function(arg){if(arguments.length==0)return frame;frame=arg;return this};mtouch.hold_time=function(arg){if(arguments.length==0)return hold_time;hold_time=arg;return this};mtouch.hold_max_dist=function(arg){if(arguments.length==0)return hold_max_dist;hold_max_dist=arg;hold_max_dist2=hold_max_dist*hold_max_dist;return this};mtouch.dbltap_max_dist=function(arg){if(arguments.length==0)return dbltap_max_dist;dbltap_max_dist=arg;return this};function mousedown(){if(!detectLeftButton(d3.event))return;var w=d3.select(window);var thiz=this,argumentz=arguments;w.on("mousemove.mtouch",function(){touchmoved.apply(thiz,argumentz)});w.on("mouseup.mtouch",function(){w.on("mousemove.mtouch",null);w.on("mouseup.mtouch",null);touchended.apply(thiz,argumentz)});touchstarted.apply(this,arguments)}function touchstarted(){d3.event.preventDefault();var target=this,event_=event.of(target,arguments),touches=get_changed_touches();for(var i=0,N=touches.length;i<N;i++){var finger=new Finger(touches[i].identifier,event_,target);fingers.push(finger);id2finger[touches[i].identifier]=finger;event_({type:"touch",finger:finger,fingers:fingers})}}function touchmoved(){d3.event.preventDefault();var target=this,event_=event.of(target,arguments),touches=get_changed_touches();for(var i=0,N=fingers.length;i<N;i++)fingers[i].changed=false;var df=[];for(var i=0,N=touches.length;i<N;i++){var finger=id2finger[touches[i].identifier];if(!finger)continue;finger.move(event_);df.push(finger)}event_({type:"mdrag",dragged_fingers:df,fingers:fingers})}function touchended(){d3.event.preventDefault();var target=this,event_=event.of(target,arguments),touches=get_changed_touches();for(var i=0,N=touches.length;i<N;i++){var finger=id2finger[touches[i].identifier];if(!finger)continue;finger.end(event_);delete id2finger[touches[i].identifier];fingers=d3.values(id2finger);event_({type:"release",finger:finger,fingers:fingers})}}function Finger(id,event,target){this.id=id;this.target=target;this.event=event;this.parent=target.parentNode;this.timeStamp0=d3.event.timeStamp;this.timeStamp=this.timeStamp0;this.hold_timer=setTimeout(this.held.bind(this),hold_time);this.pos=get_position(this.id,frame);this.pos0=[this.pos[0],this.pos[1]];this.pos_client=get_position(this.id,"client");this.dist_x=0;this.dist_y=0;this.dx=0;this.dy=0;this.dt=0;this.changed=true;this.gesture=null}Finger.prototype.cancel_hold=function(){if(this.hold_timer)clearTimeout(this.hold_timer);this.hold_timer=null};Finger.prototype.held=function(){this.event({type:"hold",finger:this,fingers:fingers});this.hold_timer=null};Finger.prototype.move=function(event){this.changed=true;this.event=event;var p=get_position(this.id,"client"),t=d3.event.timeStamp;this.dx=p[0]-this.pos_client[0];this.dy=p[1]-this.pos_client[1];this.pos[0]+=this.dx;this.pos[1]+=this.dy;this.dist_x=this.pos[0]-this.pos0[0];this.dist_y=this.pos[1]-this.pos0[1];this.pos_client=p;this.dt=t-this.timeStamp;this.timeStamp=t;if(this.dist_x*this.dist_x+this.dist_y*this.dist_y>hold_max_dist2){this.cancel_hold()}if(this.gesture)return;event({type:"drag",finger:this,x:this.pos[0],y:this.pos[1],dx:this.dx,dy:this.dy,fingers:fingers})};Finger.prototype.end=function(event){var dt=d3.event.timeStamp-this.timeStamp0;if(dt<=tap_max_time&&this.dist_x*this.dist_x+this.dist_y*this.dist_y<=tap_max_dist2){if(match_tap(d3.event.timeStamp,this.pos[0],this.pos[1])){event({type:"dbltap",finger:this,fingers:fingers})}else{event({type:"tap",finger:this,fingers:fingers})}}this.cancel_hold()};function get_changed_touches(){return d3.event.changedTouches||[{identifier:mouse_id}]}function detectLeftButton(event){if("buttons"in event)return event.buttons===1;else if("which"in event)return event.which===1;else return event.button===1}function match_tap(timeStamp,x,y){var idx=-1,pos=[x,y];last_taps=last_taps.filter(function(tap,i){if(timeStamp-tap.timeStamp<=dbltap_max_delay&&get_distance(tap.pos,pos)<=dbltap_max_dist)idx=i;return tap.timeStamp-timeStamp<=dbltap_max_delay&&idx!==i});if(idx===-1)last_taps.push({timeStamp:timeStamp,pos:pos});return idx!==-1}function get_real_position(container,id){if(id===mouse_id)return d3.mouse(container);else return d3.touches(container).filter(function(p){return p.identifier===id})[0]}function get_position(id,frame){if(frame==="client"){if(id===mouse_id)return[d3.event.clientX,d3.event.clientY];for(var i=0;i<d3.event.touches.length;i++){var t=d3.event.touches[i];if(t.identifier===id)return[t.clientX,t.clientY]}}else{if(id===mouse_id)return d3_relativePosition(frame,d3.event);for(var i=0;i<d3.event.touches.length;i++){var t=d3.event.touches[i];if(t.identifier===id)return d3_relativePosition(frame,t)}}}function get_distance(p1,p2){return Math.sqrt((p1[0]-p2[0])*(p1[0]-p2[0])+(p1[1]-p2[1])*(p1[1]-p2[1]))}return d3.rebind(mtouch,event,"on")};function d3_eventDispatch(target){var dispatch=d3.dispatch.apply(this,Array.apply(null,arguments).slice(1));dispatch.of=function(thiz,argumentz){return function(e1){try{var e0=e1.sourceEvent=d3.event;e1.target=target;d3.event=e1;dispatch[e1.type].apply(thiz,argumentz)}finally{d3.event=e0}}};return dispatch}gmath.d3_eventDispatch=d3_eventDispatch;var d3_mouse_bug44083=0;if(typeof window!=="undefined")d3_mouse_bug44083=/WebKit/.test(window.navigator.userAgent)?-1:0;function d3_relativePosition(container,touch){var svg=container.ownerSVGElement||container;if(svg.createSVGPoint){var point=svg.createSVGPoint();if(d3_mouse_bug44083<0&&(window.scrollX||window.scrollY)){svg=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var ctm=svg[0][0].getScreenCTM();d3_mouse_bug44083=!(ctm.f||ctm.e);svg.remove()}if(d3_mouse_bug44083)point.x=touch.pageX,point.y=touch.pageY;else point.x=touch.clientX,point.y=touch.clientY;point=point.matrixTransform(container.getScreenCTM().inverse());return[point.x,point.y]}var rect=container.getBoundingClientRect();return[touch.clientX-rect.left-container.clientLeft,touch.clientY-rect.top-container.clientTop]}drag_behavior=function(){var event=d3_eventDispatch(drag,"drag","drag-start","drag-end"),fingers=[],active=false,pos0,pos,dist0,dist,min_1f_dist=10,min_2f_dist=5;var drag=function(){this.on("touch.drag",touched).on("mdrag.drag",dragged).on("release.drag",released)};var touched=function(){if(fingers.length==2)return;fingers.push(d3.event.finger);if(fingers.length==2){pos0=[(fingers[0].pos[0]+fingers[1].pos[0])/2,(fingers[0].pos[1]+fingers[1].pos[1])/2];pos=[pos0[0],pos0[1]];dist=dist0=get_distance(fingers[0].pos,fingers[1].pos)}else{pos0=[fingers[0].pos[0],fingers[0].pos[1]];pos=[pos0[0],pos0[1]];dist0=dist=0}};var dragged=function(){if(fingers.length==0)return;var newpos,evt=event.of(this,arguments);if(fingers.length==1){if(!fingers[0].changed)return;newpos=[fingers[0].pos[0],fingers[0].pos[1]];if(!active&&get_distance(pos0,pos)>=min_1f_dist){active=true;evt({type:"drag-start",fingers:fingers,pos0:pos0,pos:pos,dist0:dist0,dist:dist})}}else{if(!fingers[0].changed&&!fingers[1].changed)return;newpos=[(fingers[0].pos[0]+fingers[1].pos[0])/2,(fingers[0].pos[1]+fingers[1].pos[1])/2];dist=get_distance(fingers[0].pos,fingers[1].pos);if(!active&&get_distance(pos0,pos)>=min_2f_dist){active=true;evt({type:"drag-start",fingers:fingers,pos0:pos0,pos:pos,dist0:dist0,dist:dist})}}if(active)evt({type:"drag",fingers:fingers,pos0:pos0,pos:pos,dist0:dist0,dist:dist,dx:newpos[0]-pos[0],dy:newpos[1]-pos[1]});pos=newpos};var released=function(){if(fingers.length==0)return;var f=d3.event.finger;var idx=fingers.indexOf(f);if(idx==-1)return;fingers.splice(idx,1);if(!active)return;if(fingers.length==1){pos0=[fingers[0].pos[0],fingers[0].pos[1]];pos=[pos0[0],pos0[1]]}if(fingers.length==0){active=false;event.of(this,arguments)({type:"drag-end"})}};function get_distance(p1,p2){return Math.sqrt((p1[0]-p2[0])*(p1[0]-p2[0])+(p1[1]-p2[1])*(p1[1]-p2[1]))}return d3.rebind(drag,event,"on")};var CancelFractionHandler=function(view,interaction_handler){this.view=view;this.eqtree=view.eqtree;this.nodes=[];this.line={A:{},B:{}};this.line_el=null;this.interaction_handler=interaction_handler};CancelFractionHandler.prototype.check=function(evt,nodes){return evt.fingers.length==1&&nodes.length==0};CancelFractionHandler.prototype.start=function(center,nodes){this.line_el=this.view.main.append("line").classed("cancel-fraction",true).style("stroke",this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");this.nodes=[];this.line.A.x=this.line.B.x=center[0];this.line.A.y=this.line.B.y=center[1];return[]};CancelFractionHandler.prototype.update=function(evt){this.line.B.x+=evt.dx;this.line.B.y+=evt.dy;var nnodes=this.process_selection(this.get_crossed_nodes());var same=true;if(this.nodes.length!=nnodes.length)same=false;else for(var i=0;i<this.nodes.length;i++)same=same&&this.nodes[i]==nnodes[i];if(!same)this.interaction_handler.highlight_nodes(nnodes);this.nodes=nnodes;this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};CancelFractionHandler.prototype.end=function(){this.line_el.remove();console.log(this.nodes);if(this.nodes.length===3&&this.nodes[1].value=="//"){if(this.eqtree.NumDenomCancelAction.match(this.eqtree,this.nodes[0],this.nodes[2])){this.eqtree.performAction(this.eqtree.NumDenomCancelAction,{actor:[this.nodes[0],this.nodes[2]]},null,"cancel fraction")}}else if(this.nodes.length==2){if(this.eqtree.NumDenomCancelAction.match(this.eqtree,this.nodes[0],this.nodes[1])){this.eqtree.performAction(this.eqtree.NumDenomCancelAction,{actor:[this.nodes[0],this.nodes[1]]},null,"cancel fraction")}}this.nodes=[]};CancelFractionHandler.prototype.process_selection=function(nodes){var N=nodes.length;if(N===0)return[];if(N===1)return[nodes[0].parent];var cca=Tree.get_cca(nodes);if(cca.is_group("fraction")){var res=[];for(var i=0;i<nodes.length;i++){var n=nodes[i];while(n.parent!=cca)n=n.parent;if(n.value=="//"&&cca.get_bottom().length!=1)continue;if(res.indexOf(n)==-1)res.push(n)}return res}else return[cca]};CancelFractionHandler.prototype.get_crossed_nodes=function(){var res=[];var nodes=Tree.get_leaf_nodes(this.eqtree);for(var i=0;i<nodes.length;i++){var n=nodes[i];if(!n.hidden&&this.intersects(n))res.push(n)}return res};CancelFractionHandler.prototype.intersects=function(node){var A=this.line.A,B=this.line.B;var rx1=node.sel_box.x+node.x,rx2=node.sel_box.x+node.sel_box.width+node.x;var ry1=node.sel_box.y+node.y,ry2=node.sel_box.y+node.sel_box.height+node.y;if(A.x<rx1&&B.x<rx1)return false;if(A.x>rx2&&B.x>rx2)return false;if(A.y<ry1&&B.y<ry1)return false;if(A.y>ry2&&B.y>ry2)return false;var left_of=function(x,y){return(A.x-B.x)*(A.y-y)-(A.y-B.y)*(A.x-x)<0};if(left_of(rx1,ry1)!=left_of(rx2,ry1))return true;if(left_of(rx2,ry1)!=left_of(rx1,ry2))return true;if(left_of(rx1,ry2)!=left_of(rx2,ry2))return true;return false};var ChangeNumberHandler=function(view,interaction_handler){this.default_precision=0;this.interaction_handler=interaction_handler;this.precision=null;this.view=view;this.dy=0;this.pixels_per_unit=50;this.node=null;this.value=null;this.value0=null};ChangeNumberHandler.prototype.check=function(evt){var dy=evt.pos0[1]-evt.pos[1];return Math.abs(dy)>=10};ChangeNumberHandler.prototype.start=function(center,nodes){this.node=this.process_selection(nodes);if(!this.node)return[];if(this.node&&this.node.precision)this.precision=this.node.precision;else this.precision=this.default_precision;this.dy=0;this.value=this.value0=this.view.eqtree.numeric_value(this.node);return[this.node]};ChangeNumberHandler.prototype.update=function(evt){if(!this.node||!evt.dy)return;this.dy+=evt.dy;var dval=-this.dy/this.pixels_per_unit;this.set_value(this.value0+dval)};ChangeNumberHandler.prototype.set_value=function(val){val=+val.toFixed(this.precision);if(val===this.value)return;this.value=val;this.node=this.view.eqtree.numeric_value(this.node,val);Tree.get_root(this.node).reportIntervention({type:"changeNumber",object:this.node,value:val,id:gmath.uid()});this.interaction_handler.highlight_nodes(this.start(null,[this.node]))};ChangeNumberHandler.prototype.end=function(){this.node=null};ChangeNumberHandler.prototype.process_selection=function(nodes){var is_g=function(node){return node.is_group("sign")||node.is_group("add")||node.is_group("sub")};if(nodes.length===0||nodes.length>2)return null;if(nodes.length===2){var num=nodes[1];if(num instanceof Num&&is_g(num))return num.parent;return null}var n=nodes[0];if(n instanceof Num){if(is_g(n.parent))return n.parent;else return n}else if(is_g(n))return n;return null};var AlgebraView=function(eqtree,svg,options){this.eqtree=eqtree;this.eqtree.addEventListener("change",this.update_all.bind(this));this.svg=svg;this.id=gmath.uid();this.initializeOptions(options)};asEventListener.call(AlgebraView.prototype);AlgebraView.prototype.emitChangedEvent=function(){this.dispatchEvent({type:"change",source:this},this.id)};AlgebraView.prototype.initializeOptions=function(options){options=options||{};var padding={left:0,right:0,top:0,bottom:0};this.options=gmath.extend({font_size:80,color:"#333",selection_color:"lightblue",fraction_size_factor:.7,exp_size_factor:.7,debug_lines:false,dur:250,pos:[0,0],interaction_mode:"transform",v_align:"alphabetic",h_align:"center",background_color:"none",shadow_filter:null,border_color:"none",shadow_color:"none",border_radius:0,padding:padding,interactive:true,event_receiver:null},options);if(options.padding){var op=options.padding;if(typeof op==="number"){this.options.padding={left:op,right:op,top:op,bottom:op}}else gmath.extend(this.options.padding,op)}};AlgebraView.prototype.init=function(on_load){this.main=this.svg.append("g").attr("id",this.options.id).attr("class","main").attr("transform","translate("+this.options.pos+")");this.shadow_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill","none").attr("filter",this.options.shadow_filter).style("stroke",this.options.shadow_color).style("visibility",this.options.shadow_filter?"visible":"hidden");this.border_rect=this.main.append("rect").attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color);if(this.options.event_receiver){this.event_receiver=d3.select(this.options.event_receiver)}else{this.event_receiver=this.main}this.event_receiver.style("pointer-events","visible");if(this.options.debug_lines){this.main.append("line").attr("x1",-1e3).attr("x2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue");this.main.append("line").attr("y1",-1e3).attr("y2",1e3).attr("stroke-width","0.5").attr("stroke","lightblue")}this.renderer=new NodeRenderer(this,this.options.h_align,this.options.v_align);this.interaction_handler=new InteractionHandler(this,this.options.interactive);this.interaction_handler.mode=this.options.interaction_mode;if(!AlgebraView.fontloader){AlgebraView.fontloader=FontLoader(this.svg,["Crimson Text Italics","Crimson Text"],2e3);this.fontloader=AlgebraView.fontloader;var self=this;this.fontloader.on_load(function(){self.fontloader.loadSizes();self.update_all();if(on_load)on_load()})}else{this.fontloader=AlgebraView.fontloader;this.update_all();if(on_load)on_load()}};AlgebraView.prototype.interactive=function(val){if(arguments.length<1)return this.interaction_handler.interactive;this.interaction_handler.set_interactive(val);return this};AlgebraView.prototype.interactive=function(arg){if(arguments.length==0)return this.options.interactive;this.options.interactive=arg;this.interaction_handler.set_interactive(arg);return this};AlgebraView.prototype.update_all=function(event){this.enter_as_is();this.renderer.set_style(this.eqtree.children);this.renderer.set_position(this.eqtree.children,true);this.enter_and_exit();this.update_existing();this.emitChangedEvent()};AlgebraView.prototype.reposition=function(event){var thiz=this;thiz.renderer.set_position(thiz.eqtree.children,true);thiz.update_existing()};AlgebraView.prototype._enter=function(sel){var self=this;var te=sel.enter().append("g").classed("math",true).attr("transform",function(d){return"translate("+d.x+","+d.y+")"});te.filter(function(d){return d.value=="//"}).append("line").style("stroke-linecap","round").attr("opacity",function(d){return d.no_anim&&!d.hidden?1:1e-5}).call(style_division_bar);te.append("text").attr("stroke","none").attr("font-family",function(d){return self.get_font(d)}).attr("font-size",function(d){return d.size+"px"}).attr("fill",function(d){return d.color}).attr("opacity",function(d){return d.no_anim&&!d.hidden?1:1e-5}).attr("pointer-events","none").text(function(d){return d.to_string()});te.append("rect").attr("visibility","hidden").style("stroke","black").style("fill","none").classed("selector",true);sel.each(function(d){return d.no_anim=false})};AlgebraView.prototype.enter_as_is=function(){var self=this;var terms=self.main.selectAll("g.math").data(Tree.get_leaf_nodes(this.eqtree.children).filter(function(n){return n.enter_as_is}),function(d){return d.id}).each(function(d){d.enter_as_is=false});this._enter(terms);this.node_sel=terms};AlgebraView.prototype.enter_and_exit=function(){var self=this;var terms=self.main.selectAll("g.math").data(Tree.get_leaf_nodes(this.eqtree.children),function(d){return d.id});this._enter(terms);var ex=terms.exit().each(function(d){d.deleted=true}).transition().ease("linear").duration(function(d){return d.no_anim?0:self.options.dur}).attr("transform",function(d){return"translate("+(d.x||0)+","+(d.y||0)+")"}).remove();ex.select("*").attr("opacity",1e-5);this.node_sel=terms};AlgebraView.prototype.update_existing=function(){var thiz=this;var gs=this.svg.selectAll("g.math").filter(function(d){return!d.deleted});gs.transition().duration(this.options.dur).ease("circle-out").attr("transform",function(d){return"translate("+(d.x||0)+","+(d.y||0)+")"});gs.select("text").transition().duration(0).text(function(d){return d.to_string()}).transition().duration(this.options.dur).ease("linear").attr("font-size",function(d){return d.size+"px"}).attr("fill",function(d){return d.color}).attr("opacity",function(d){return d.hidden?1e-5:1});gs.select("line").transition().duration(this.options.dur).ease("linear").call(style_division_bar).attr("opacity",function(d){return d.hidden?1e-5:1});gs.select("rect").attr("x",function(d){return d.sel_box?d.sel_box.x:0}).attr("y",function(d){return d.sel_box?d.sel_box.y:0}).attr("width",function(d){return d.hidden||!d.sel_box?0:d.sel_box.width}).attr("height",function(d){return d.hidden||!d.sel_box?0:d.sel_box.height});this.update_background();return true};AlgebraView.prototype.update_background=function(){var main_node=this.eqtree.children[0];var bbox=this.getBBox();if(main_node&&!main_node.dragging){this.border_rect.attr({rx:this.options.border_radius,ry:this.options.border_radius}).style("fill",this.options.background_color).style("stroke",this.options.border_color).transition().duration(this.options.dur).ease("circle-out").attr(bbox);this.shadow_rect.transition().duration(this.options.dur).ease("circle-out").attr(bbox)}};AlgebraView.prototype.getBBox=function(opts){opts=opts||{};var n=this.eqtree.children[0];if(!n||!n.sel_box)return{x:0,y:0,width:0,height:0};var bbox={};var padding=this.options.padding;bbox.x=n.sel_box.x+(n.dragging?n.x0:n.x)-(opts.no_padding?0:padding.left);bbox.y=n.sel_box.y+(n.dragging?n.y0:n.y)-(opts.no_padding?0:padding.top);bbox.width=n.sel_box.width+(opts.no_padding?0:padding.left+padding.right);bbox.height=n.sel_box.height+(opts.no_padding?0:padding.top+padding.bottom);return bbox};AlgebraView.prototype.update_positions=function(){this.node_sel.transition().duration(this.options.dur).ease("circle-out").attr("transform",function(d){return"translate("+(d.x||0)+","+(d.y||0)+")"})};AlgebraView.prototype.update_style=function(){this.node_sel.select("text").transition().duration(this.options.dur).ease("linear").attr("font-size",function(d){return d.size+"px"}).attr("fill",function(d){return d.color}).attr("opacity",function(d){return d.hidden?1e-5:1});this.node_sel.select("line").transition().duration(this.options.dur).ease("linear").call(style_division_bar).attr("opacity",function(d){return d.hidden?1e-5:1})};function style_division_bar(selection){selection.attr("x1",0).attr("x2",function(d){return d.width}).style("stroke-width",function(d){return d.height}).style("stroke",function(d){return d.color})}AlgebraView.prototype.force_refresh=function(){var n=this.svg.node();n.style.display="none";n.style.display="block"};AlgebraView.prototype.get_utf8=function(d){var mappings={"-":"−","*":"·","/":""};if(d.value in mappings)return mappings[d.value];if(typeof d.value=="number"&&d.value<0)return mappings["-"]+Math.abs(d.value);return d.value};AlgebraView.prototype.get_font=function(d){return d instanceof Var?"Crimson Text Italics":"Crimson Text"};AlgebraView.prototype.get_width=function(d){return this.fontloader.width(d.to_string(),d.size,get_font(d))};DerivationList=function(svg,eq,options){this.id=gmath.uid();this.svg=d3.select(svg);if(this.svg.empty())throw"could not find element "+svg;this.svgg=this.svg.append("g").classed("derivation-list",true);this.options=gmath.extend(this.getDefaultOptions(),options);if(!("hide_handles"in options)&&options.no_history){this.options.hide_handles=true}var model=new EqTree(eq,this.options);this.dims={};this.pos=[0,0];this.rows=[];this.rows.push(this.createRow(model,null,this.options));this.v_align=this.rows[0].view.options.v_align;if(this.options.no_history){this.rows[0].view.addEventListener("change",this.updateHandlePosFromChangeEvent.bind(this));this.rows[0].model.addEventListener("change",this.onChange.bind(this))}else{this.timeTree=new TimeTree(model);this.timeTree.init();this.timeTree.addEventListener("change",this.onChange.bind(this))}this.collapsed_mode=false;this.handle_stroke_color="#eee";this.page_model=options.page_model;this.curr_drag_handler=null;this.curr_target_model=null};DerivationList.prototype.handleFactoringGesture=function(row,dx,dy){if(row.idx!==this.rows.length-1)return;if(!this.curr_drag_handler)this.curr_drag_handler=row.view.interaction_handler.handlers.transform[1];var drag_handler=this.curr_drag_handler;if(!row.abs_pos){row.abs_pos={x:row.pos[0]+this.pos[0],y:row.pos[1]+this.pos[1]};var factoringActions=this.getFactoringActions(row.model.children[0]);console.log(factoringActions);drag_handler.start(row.abs_pos,row.model.children,false,factoringActions,true)}row.abs_pos.x+=dx;row.abs_pos.y+=dy;drag_handler.update({dx:dx,dy:dy});this.pos=[this.pos[0]+dx,this.pos[1]+dy];this.svgg.attr("transform","translate("+this.pos+")")};DerivationList.prototype.getFactoringActions=function(factor){var filterBracketedSum=function(node){return node.is_group("sum")&&node.parent.is_group("brackets")};var target_infos=[],self=this;this.page_model.getDerivationLists().forEach(function(dl){if(dl===self)return;var row=dl.term.getLastRow();target_infos.push({sums:row.model.filter(filterBracketedSum),row:row,dl:dl.term})});var actions=[];for(var i=0;i<target_infos.length;i++){var tinfo=target_infos[i];for(var j=0;j<tinfo.sums.length;j++){var sum=tinfo.sums[j];if(TriggerFactoringAction.match(sum,factor)){var action=TriggerFactoringAction.createBoundAction(tinfo.row.model,{dl:tinfo.dl,view:tinfo.row.view,sum:sum,callback:this.factoringWasTriggered.bind(this)});action.offset={x:tinfo.dl.pos[0]+tinfo.row.pos[0]-this.pos[0]-this.getLastRow().pos[0],y:tinfo.dl.pos[1]+tinfo.row.pos[1]-this.pos[1]-this.getLastRow().pos[1]};actions.push(action)}}}return actions};DerivationList.prototype.factoringWasTriggered=function(viewOfSum,sum,dl){var drag_handler=viewOfSum.interaction_handler.handlers.transform[1];drag_handler.start(calcAbsoluteBBoxLocation(dl),selectFactorsInSum(sum,this.getLastModel().children[0]),true);this.curr_drag_handler=drag_handler;this.curr_target_model=dl.getLastModel();this.svgg.attr("display","none")};var selectFactorsInSum=function(sum,factors){var matchingNodes;matchingNodes=collectMatchingNodesInSum(sum,factors);matchingNodes=filterByStructure(matchingNodes,sum);var selectedNodes=[];for(var i=0;i<matchingNodes.length;i++){if(matchingNodes[i].length===0)return false}for(var i=0;i<matchingNodes.length;i++){if(matchingNodes[i])selectedNodes.push(matchingNodes[i][matchingNodes[i].length-1])}for(var i=0;i<selectedNodes.length;i++){if(!Array.isArray(selectedNodes[i])&&selectedNodes[i].parent.value!=="add"&&selectedNodes[i].parent.value!=="sub")selectedNodes[i]=selectedNodes[i].parent}if(selectedNodes.length!==sum.children.length)return false;var flattenedSelectedNodes=[];for(var i=0;i<selectedNodes.length;i++){if(Array.isArray(selectedNodes[i])){for(var j=0;j<selectedNodes[i].length;j++){flattenedSelectedNodes.push(selectedNodes[i][j])}}else{flattenedSelectedNodes.push(selectedNodes[i])}}return flattenedSelectedNodes};var selectAllRangesWithMatchingValue=function(term,val){var res=[];term.for_each(function(n){var nval=n.to_ascii();if(nval.slice(0,1)==="*")nval=nval.substr(1);if(!n.hidden&&nval===val)res.push(n);else{var ns=[n];while(nval.length<val.length&&n.commutative&&n.rs){n=n.rs;nval+=n.to_ascii();ns.push(n)}if(nval===val)res.push(ns)}});return res};var collectMatchingNodesInSum=function(sum,factors){var sumFactors=[];for(var i=0;i<sum.children.length;i++){var addend=sum.children[i],term=addend.children[1];sumFactors.push(selectAllRangesWithMatchingValue(term,factors.to_ascii()))}return sumFactors};function select_by_value(val){return function(n){return!n.hidden&&n.to_ascii()===val}}var filterByStructure=function(factorCollection,sum){var isSingleTermInAddend=function(node){return node.parent&&(node.parent.value==="add"||node.parent.value==="sub")&&node.parent.parent&&node.parent.parent==sum};var isSingleTermFromProduct=function(node){return node.parent&&node.parent.value==="mul"&&node.parent.parent&&node.parent.parent.is_group("product")&&node.parent.parent.parent&&node.parent.parent.parent.parent&&node.parent.parent.parent.parent==sum};var isOneTermOfManyFromProduct=function(node){return node.value==="mul"&&node.parent&&node.parent.is_group("product")&&node.parent.parent&&node.parent.parent.parent&&node.parent.parent.parent==sum};var isChildOfAddendOrProduct=function(node){var boolForLs=true;if(Array.isArray(node)){for(var i=0;i<node.length;i++)if(!isOneTermOfManyFromProduct(node[i]))boolForLs=false}else{return isSingleTermInAddend(node)||isSingleTermFromProduct(node)}return boolForLs};for(var i=0;i<factorCollection.length;i++){factorCollection[i]=factorCollection[i].filter(isChildOfAddendOrProduct)}return factorCollection};var calcAbsoluteBBoxLocation=function(dl){var activeRow=dl.getLastRow(),activeView=dl.getLastView(),activeBBox=activeView.getBBox();var dlPos=dl.pos,activeRowRelPos=activeRow.pos,activeBBoxRelPos=[activeBBox.x,activeBBox.y];var activeBBoxPos=[dlPos[0]+activeRowRelPos[0]+activeBBoxRelPos[0],dlPos[1]+activeRowRelPos[1]+activeBBoxRelPos[1]];return activeBBoxPos};asEventListener.call(DerivationList.prototype);DerivationList.createStandalone=function(container,options){if(container instanceof String)container=d3.select(container).node();var selection=d3.select(container);if(selection.empty())return;var text=selection.text();var id=options.id||gmath.uid();selection.text("");var svg=selection.append("svg").attr("id",id).style("width","100%").style("height","100%");var w=selection[0][0].clientWidth,h=selection[0][0].clientHeight;var opts=gmath.extend({id:id,pos:[w/2,h/2],v_align:"center",no_history:true,no_handles:true,standalone:true},options);opts.eq=opts.eq||text;return new DerivationList(svg.node(),opts.eq,opts)};DerivationList.prototype.setExpression=function(expr_string,keep_brackets){this.getLastModel().parseAndSet(expr_string,keep_brackets)};DerivationList.prototype.getDefaultOptions=function(){return{id:gmath.uid(),pos:[300,200],debug_lines:false,visualize_derivations:"none",visualize_derivations_method:"all",embedded:true,border_radius:4,v_align:"center",h_align:"center",padding:{left:40,right:5,top:5,bottom:5},font_size:50,no_history:false,hide_handles:false}};DerivationList.prototype.singleLineMode=function(val){if(arguments.length===0)return this.collapsed_mode;if(val&&!this.collapsed_mode){for(var i=0;i<this.rows.length-1;i++){if(!this.rows[i].hidden)this.hideRow(this.rows[i])}this.layoutRows()}this.collapsed_mode=val;return this};DerivationList.prototype.getLastRow=function(){return this.rows[this.rows.length-1]};DerivationList.prototype.getLastModel=function(){return this.getLastRow().model};DerivationList.prototype.getLastView=function(){return this.getLastRow().view};DerivationList.prototype.onChange=function(event){this.dispatchEvent(event);if(event.preview)this.updateHandlePos(this.getLastRow());if(this.options.no_history||event.preview)return;if(!event.action||event.action.oldTree==event.action.newTree)return;this.addRowFromAction(event.action)};DerivationList.prototype.updateHandlePos=function(row){if(this.options.no_handles)return;var circle_pos=this.getHandlePos(row.view);if(row.handle)row.handle.transition().attr("cx",function(d,i){return circle_pos.cx+4*i}).attr("cy",circle_pos.cy)};DerivationList.prototype.updateHandlePosFromChangeEvent=function(event){if(this.options.no_handles)return;
var view=event.source;var matching_rows=this.rows.filter(function(row){return row.view===view});if(matching_rows.length!==1)throw"can find the right row to update";var row=matching_rows[0];this.updateHandlePos(row)};DerivationList.prototype.addRowFromAction=function(action){var newTree=action.newTree;var oldTree=action.oldTree;if(!newTree||!oldTree)throw"each action must define newTree and oldTree";var N=this.rows.length;var last_row=this.rows[N-1];var oldView=last_row.view;if(last_row.model===oldTree){var new_opts=gmath.extend(gmath.extend({},oldView.options),{pos:last_row.pos.slice()});var new_row=this.createRow(newTree,action,new_opts);this.rows.push(new_row);new_row.idx=N;this.deactivateRow(last_row);if(this.collapsed_mode)this.hideRow(last_row);this.draw_mapping_lines(action,oldView,new_row.view)}else if(last_row.model===newTree){console.log("preview, again");var new_opts=gmath.extend(gmath.extend({},oldView.options),{interactive:false,color:"gray",pos:last_row.pos.slice()});var new_row=this.createRow(oldTree,last_row.action,new_opts);this.rows.splice(N-1,0,new_row);new_row.idx=N-1;last_row.action=action;this.deactivateRow(new_row);this.updateHandlePos(last_row);var realOldView=this.rows[N-1].view;this.draw_mapping_lines(action,realOldView,new_row.view);if(this.collapsed_mode)this.hideRow(new_row)}else throw"oldTree is not part of this derivation list, but should be"};DerivationList.prototype.draw_mapping_lines=function(action,oldView,newView){var drawSet=this.options.visualize_derivations;var drawStyle=this.options.visualize_derivations_method;if(!action.wasNodeTouched)return;Tree.get_leaf_nodes(action.oldTree.children[0]).forEach(function(node){node.selected=action.wasNodeTouched(node)});var lines=[];Tree.get_leaf_nodes(action.oldTree.children[0]).forEach(function(source_node){if(drawSet==="all"||source_node.selected&&drawSet==="active"){var target_nodes=action.mapNodes([source_node]);if(target_nodes.length===0)lines.push({source_node:source_node});else target_nodes.forEach(function(target_node){lines.push({source_node:source_node,target_node:target_node})})}});var dx=newView.options.pos[0]-oldView.options.pos[0];var dy=newView.options.pos[1]-oldView.options.pos[1]+12;oldView.main.selectAll(".bar").remove();var bars=oldView.main.selectAll(".bar").data(lines).enter().append("path");bars.attr("class","bar").call(this.mapLinesPaths.bind(this),dx,dy).call(this.mapLinesMouseEvents.bind(this),lines,bars).attr("stroke",function(d){if(drawStyle==="mouseover")return"clear";return d.target_node?"#BFDFBF":"#DFBFBF"}).style("stroke-width",5).style("stroke-linecap","round")};DerivationList.prototype.mapLinesPaths=function(sel,dx,dy){sel.attr("d",function(d){var x1=d.source_node.x+d.source_node.sel_box.x+d.source_node.sel_box.width/2,y1=d.source_node.y+d.source_node.sel_box.y+d.source_node.sel_box.height;var x2,y2;if(d.target_node){x2=d.target_node.x+d.target_node.sel_box.x+d.target_node.sel_box.width/2+dx;y2=d.target_node.y+d.target_node.sel_box.y+d.target_node.sel_box.height+dy}else{x2=x1;y2=y1+5}return"M"+x1+","+y1+"L"+x2+","+y2})};DerivationList.prototype.mapLinesMouseEvents=function(sel,line_data,line_els){if(this.options.visualize_derivations_method!=="mouseover")return;line_data.forEach(function(line){var source_node=line.source_node;var target_node=line.target_node;if(target_node&&!target_node.inLines)target_node.inLines=[];if(source_node&&!source_node.outLines)source_node.outLines=[];if(source_node){source_node.outLines.push(line)}if(target_node){target_node.inLines.push(line)}});sel.on("mouseover",function(d){var inlines=d.target_node?d.target_node.inLines:d.source_node.outLines;line_els.attr("stroke",function(d){var value="clear";inlines.forEach(function(line){if(d.target_node){if(line.source_node.id===d.source_node.id&&line.target_node.id===d.target_node.id){value="#BFDFBF"}}else if(d.source_node){if(line.source_node.id===d.source_node.id){value="#DFBFBF"}}});return value})}).on("mouseout",function(){line_els.attr("stroke","clear")})};DerivationList.prototype.createRow=function(model,action,options){model.for_each(function(node){node.dragging=false;node.selected=false});var pos=options.pos;if(this.rows.length===0){this.pos=pos.slice();this.svgg.attr("transform","translate("+pos+")");pos=[0,0]}options.pos=[0,0];var el=this.svgg.append("g").classed("dl-line",true).attr("transform","translate("+pos+")");if(this.options.standalone)options.event_receiver=this.svg.node();options.derivation_list=this;var view=new AlgebraView(model,el,options);var row={model:model,view:view,el:el,action:action,dims:null,pos:pos};el.datum(row);if(options.row_hidden)row.hidden=true;var self=this;view.init(function(){setTimeout(function(){self.createRowHandle(row);self.layoutRows()},1)});this.model=model;return row};DerivationList.prototype.getFinalVerticalPos=function(row,include_hidden,start_idx){start_idx=start_idx||0;var y=this.rows[start_idx].pos[1];for(var i=start_idx+1;i<=row.idx;i++){if(this.rows[i-1].hidden&&!include_hidden)continue;y+=this.getVerticalAdvance(this.rows[i])}return y};DerivationList.prototype.isAboveFinalVerticalPos=function(row){return row.pos[1]<this.getFinalVerticalPos(row)};DerivationList.prototype.getUpmostPullableRow=function(row){var idx;for(idx=row.idx;idx>=0;idx--){if(this.rows[idx].hidden)break;if(!this.isAboveFinalVerticalPos(this.rows[idx]))break}if(idx===row.idx)return null;return this.rows[idx+1]};DerivationList.prototype.getHiddenAbove=function(row){var idx=row.idx-1;while(idx>=0&&!this.rows[idx].hidden)idx--;return idx===-1?null:this.rows[idx]};DerivationList.prototype.getVisibleAbove=function(row){var idx=row.idx-1;while(idx>=0&&this.rows[idx].hidden)idx--;return idx===-1?null:this.rows[idx]};DerivationList.prototype.dragRow=function(row,dx,dy){if(this.rows.length===1&&this.page_model)this.handleFactoringGesture(row,dx,dy);if(dy===0)return;var bottom_row=this.rows[this.rows.length-1];var top_row;if(dy>0){if(!this.isAboveFinalVerticalPos(row)){top_row=this.getHiddenAbove(row);if(!top_row)return;this.unhideRow(top_row);top_row=this.rows[top_row.idx+1]}else{top_row=this.getUpmostPullableRow(row)}}else{top_row=this.getVisibleAbove(row);if(!top_row)return;if(row.pos[1]<=top_row.pos[1]){this.hideRow(top_row)}else top_row=this.rows[top_row.idx+1]}for(var idx=top_row.idx;idx<=bottom_row.idx;idx++){var rrow=this.rows[idx];rrow.pos[1]=Math.min(this.getFinalVerticalPos(rrow),rrow.pos[1]+dy);rrow.pos[1]=Math.max(idx>row.idx?this.getFinalVerticalPos(rrow,false,row.idx):0,rrow.pos[1]);rrow.el.attr("transform","translate("+rrow.pos+")")}};DerivationList.prototype.releaseRow=function(row){row.abs_pos=undefined;if(this.curr_drag_handler){this.curr_drag_handler.end();this.curr_drag_handler=null}if(this.curr_target_model){this.curr_target_model.finishPreviewActionSequence();this.current_target_model=null;this.page_model.removeList(this)}else{for(var i=0;i<this.rows.length;i++)this.hideBackground(this.rows[i]);if(!this.options.no_handles)row.handle.attr({fill:"white"});this.draginfo=null;if(row.idx>0){var overlap=this.getFinalVerticalPos(row)-row.pos[1];var row2=this.getVisibleAbove(row);if(row2&&overlap>0&&overlap>.5*row2.dims.height)this.hideRow(row2)}this.layoutRows()}};DerivationList.prototype.createRowHandle=function(row){if(this.options.no_handles)return;row.mtouch=mtouch_events().frame(row.view.main.node());var self=this;row.mtouch.on("drag",function(row,drag_handler){self.dragRow(row,d3.event.dx,d3.event.dy)});row.mtouch.on("touch",function(row){for(var i=0;i<self.rows.length;i++)self.showBackground(self.rows[i],i===row.idx);row.handle.attr({fill:"whitesmoke"})});row.mtouch.on("tap",function(row){var i=row.idx;if(i>0&&self.rows[i-1].hidden){var idx=i-1;while(idx>=0&&self.rows[idx].hidden){self.unhideRow(self.rows[idx]);idx--}}else if(i<self.rows.length-1&&self.rows.length>1)self.hideRow(row)});row.mtouch.on("hold",function(row){if(!gmath.actions.editLineAction.match(row.model))return;row.model.performAction(gmath.actions.editLineAction,{actor:row.model,do_in_place:true})});row.mtouch.on("release",this.releaseRow.bind(this));var circle_pos=this.getHandlePos(row.view);var circles=row.el.selectAll("circle").data([row,row]).enter().append("circle").attr({fill:"white",stroke:this.handle_stroke_color,"stroke-width":2,r:10}).attr({"pointer-events":"all"}).attr("cx",function(d,i){return circle_pos.cx+4*i}).attr("cy",circle_pos.cy).call(row.mtouch);row.handle=circles;this.updateHandleType(row)};DerivationList.prototype.showBackground=function(row,show_border){row.view.options.border_color=show_border?"silver":"none";row.view.options.background_color="white";var l,r,w=row.dims.width;if(row.view.options.h_align==="center"){l=40+(this.dims.width-w)/2;r=5+(this.dims.width-w)/2}else if(row.view.options.h_align==="left"){l=40;r=5+(this.dims.width-w)}else if(row.view.options.h_align==="right"){l=40+(this.dims.width-w);r=5}row.view.options.padding={left:l,right:r,top:5,bottom:5};row.view.update_background()};DerivationList.prototype.hideBackground=function(row){row.view.options.border_color="none";row.view.options.background_color="none";row.view.update_background()};DerivationList.prototype.getHandlePos=function(view){var bbox=view.getBBox({no_padding:true});return{cx:0*view.options.pos[0]+bbox.x-20,cy:0*view.options.pos[1]+bbox.y+bbox.height/2}};DerivationList.prototype.updateHandleType=function(row){if(this.options.no_handles)return;var hide_handles=this.options.hide_handles;if(!row.handle)return;if(row.idx>0&&this.rows[row.idx-1].hidden){row.handle.attr("visibility",hide_handles?"hidden":"visible")}else{row.handle.attr("visibility",function(d,i){return i===1||hide_handles?"hidden":"visible"})}};DerivationList.prototype.hideRow=function(row){row.hidden=true;row.el.attr("display","none");if(this.rows.filter(function(row){return!row.hidden}).length===1)this.singleLineMode(true);this.updateHandleType(this.rows[row.idx+1])};DerivationList.prototype.unhideRow=function(row){if(row.hidden)this.singleLineMode(false);row.hidden=false;row.el.attr("display",null);this.updateHandleType(this.rows[row.idx+1])};DerivationList.prototype.deactivateRow=function(row){row.view.interactive(false);row.view.options.color="gray";row.model.for_each(function(node){node.dragging=false;node.selected=false});row.model.hide_nodes();row.view.update_all()};DerivationList.prototype.updateRowDimensions=function(){var x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;this.rows.forEach(function(row){row.dims=row.view.getBBox({no_padding:true});row.dims.y-=row.view.options.padding.top;row.dims.height+=row.view.options.padding.top+row.view.options.padding.bottom;x1=Math.min(x1,row.dims.x);y1=Math.min(y1,row.dims.y);x2=Math.max(x2,row.dims.x+row.dims.width);y2=Math.max(y2,row.dims.y+row.dims.height)});this.dims={x:x1,y:y1,width:x2-x1,height:y2-y1}};DerivationList.prototype.getVerticalAdvance=function(row){if(row.idx===0)return 0;if(this.v_align==="center"){return this.rows[row.idx-1].dims.height/2+row.dims.height/2}else if(this.v_align==="top"){return this.rows[row.idx-1].dims.height}else if(this.v_align==="bottom"||this.v_align==="alphabetic"){return row.dims.height}};DerivationList.prototype.layoutRows=function(){this.updateRowDimensions();var pos0=this.rows[0].pos,x=pos0[0],y=pos0[1];this.rows[0].idx=0;if(!this.options.no_handles&&!this.rows[0].handle)this.createRowHandle(this.rows[0]);for(var i=1;i<this.rows.length;i++){var row=this.rows[i];row.idx=i;if(!this.options.no_handles&&!row.handle)this.createRowHandle(row);this.updateHandleType(row);if(!this.rows[i-1].hidden)y+=this.getVerticalAdvance(row);if(row.dragging)continue;var pos=row.pos;if(pos[0]!==x||pos[1]!==y){pos[0]=x;pos[1]=y;pos=pos;row.el.transition().attr("transform","translate("+pos+")")}}this.svgg.selectAll(".dl-line").sort(function(a,b){return a.idx-b.idx})};var NodeRenderer=function(view,h_align,v_align){this.view=view;this.h_align=h_align||"center";this.v_align=v_align||"alphabetic"};NodeRenderer.prototype.set_style=function(nodes){var set=function(n,size,color){n.size=size;if(n.bigger)n.size*=1.5;if(n.smaller)n.size*=.67;n.color=n.selected?this.view.options.selection_color:color;if(n.has_children())for(var i=0;i<n.children.length;i++){if(n.is_group("fraction"))set.call(this,n.children[i],n.size*this.view.options.fraction_size_factor,n.color);else if(n.is_group("power")&&i==1)set.call(this,n.children[i],n.size*this.view.options.exp_size_factor,n.color);else set.call(this,n.children[i],n.size,n.color)}};for(var i=0;i<nodes.length;i++){var n=nodes[i];var size=EqTree.is_top_most(n)||!n.size?this.view.options.font_size:n.size;var color=n.parent.color||this.view.options.color;set.call(this,n,size,color)}};NodeRenderer.prototype.set_position=function(nodes,update_dims){var baseline_shift=.24,ascent=.73,descent=.18;var position_horizontally=function(ns){var width=0,ascent=0,descent=0,sel_width=0,height=0;for(var i=0;i<ns.length;i++){var child=ns[i];width+=child.hidden||child.hide_after_drop?0:child.width;sel_width+=child.hidden?0:child.width;ascent=Math.max(ascent,child.hidden?0:child.ascent-child.rel_y);descent=Math.max(descent,child.hidden?0:child.descent+child.rel_y)}height=ascent+descent;var x=-width;for(var i=0;i<ns.length;i++){var child=ns[i];child.rel_x+=x+child.width;if(child.hidden||child.hide_after_drop)child.rel_x-=child.width;x+=child.hidden||child.hide_after_drop?0:child.width}return{width:width,height:height,ascent:ascent,descent:descent,sel_box:{x:-sel_width,width:sel_width,y:-ascent,height:height}}};var rel_pos=function(n){if(!n.has_children()){n.baseline_shift=baseline_shift*n.size;if(update_dims){n.width=this.view.fontloader.width(n.to_string(),n.size,this.view.get_font(n));n.ascent=ascent*n.size;n.descent=descent*n.size;n.height=n.ascent+n.descent;n.sel_box={x:0,width:n.width,y:-n.ascent,height:n.height}}n.rel_x=-n.width;n.rel_y=0;return}if(nodes.indexOf(n)!=-1&&!EqTree.is_top_most(n)){n.rel_x=n.rel_x||0;n.rel_y=n.rel_y||0}else{n.rel_x=0;n.rel_y=0}for(var i=0;i<n.children.length;i++)rel_pos.call(this,n.children[i]);if(n.is_group("fraction")){var up=[],down=[],bar=null;var c=n.children[0];while(c){if(c.value=="mul")up.push(c);else if(c.value=="div")down.push(c);else bar=c;c=c.rs}var up_dims=position_horizontally(up);var down_dims=position_horizontally(down);var dy=-baseline_shift*n.size;bar.height=n.size/18;bar.width=Math.max(up_dims.width,down_dims.width);bar.ascent=bar.height/2;bar.descent=bar.height/2;bar.rel_y=dy;bar.rel_x=.1*n.size;bar.sel_box={x:-.1*n.size,width:bar.width+.2*n.size,y:-(ascent+descent)*n.size/4,height:(ascent+descent)*n.size/2};n.width=bar.width+.2*n.size;n.ascent=up_dims.height+bar.height/2-dy;n.descent=down_dims.height+bar.height/2+dy;n.height=n.ascent+n.descent;n.rel_y=0;n.rel_x=-n.width;n.sel_box={x:0,width:n.width,y:-n.ascent,height:n.height};for(var i=0;i<up.length;i++){up[i].rel_y+=-up_dims.descent-bar.height/2+dy;up[i].rel_x+=.5*(n.width+up_dims.width)}for(var i=0;i<down.length;i++){down[i].rel_y+=down_dims.ascent+bar.height/2+dy;down[i].rel_x+=.5*(n.width+down_dims.width)}}else{if(n.is_group("power")){var base=n.children[0],exp=n.children[1];exp.rel_y-=base.ascent*.7}gmath.extend(n,position_horizontally(n.children))}};for(var i=0;i<nodes.length;i++)rel_pos.call(this,nodes[i]);var abs_pos=function(n,x,y){if(n.dragging){n.x0=n.rel_x+x;n.y0=n.rel_y+y}else{n.x=n.rel_x+x;n.y=n.rel_y+y}if(n.has_children())for(var i=0;i<n.children.length;i++)abs_pos.call(this,n.children[i],n.x,n.y)};for(var i=0;i<nodes.length;i++){var n=nodes[i];if(EqTree.is_top_most(n)){var x,y;switch(this.v_align){case"alphabetic":y=0;break;case"top":y=n.ascent-n.rel_y;break;case"center":y=-n.descent+n.height/2;break;case"bottom":y=-n.descent-n.rel_y;break}switch(this.h_align){case"left":x=n.width;break;case"center":x=n.width/2;break;case"right":x=0;break}abs_pos.call(this,n,x,y)}else{abs_pos.call(this,n,n.parent.x||0,n.parent.y||0)}}};var InteractionHandler=function(view,interactive,recorder){this.view=view;this.recorder=recorder;this.mode="transform";this.interactive=interactive;this.init();if(!interactive)this.set_interactive(false);this.selected_nodes=[];this.handlers={transform:[new SelectionHandler(this.view,this),new SubstitutionHandler(this.view,this),new DragHandler(this.view,this),new JoinHandler(this.view,this),new SplitHandler(this.view,this),new CancelFractionHandler(this.view,this)],change:[new ChangeNumberHandler(this.view,this)]};this.active_handler=null;this.finger_vis=null};asEventListener.call(InteractionHandler.prototype);InteractionHandler.prototype.end_of_interaction=function(){this.view.eqtree.finishPreviewActionSequence()};InteractionHandler.prototype.init=function(){var frame=this.view.main.node();this.mtouch=mtouch_events().frame(frame);this.view.event_receiver.call(this.mtouch);this.mtouch.on("touch",this.on_touch.bind(this,null)).on("release",this.on_release.bind(this,null)).on("tap",this.on_tap.bind(this,null));var dragb=drag_behavior().on("drag-start",this.on_drag_start.bind(this,null)).on("drag",this.on_drag.bind(this,null)).on("drag-end",this.on_drag_end.bind(this,null));this.mtouch.call(dragb)};InteractionHandler.prototype.set_interactive=function(arg){if(arg){this.interactive=true;this.mtouch.connected(true)}else{this.interactive=false;this.mtouch.connected(false)}};InteractionHandler.prototype.select_new_handler=function(evt){var handlers=this.handlers[this.mode]||[];for(var i=0;i<handlers.length;i++){var h=handlers[i];if(h.check(evt,this.selected_nodes)){this.active_handler=h;this.selected_nodes=h.start(evt.pos,this.selected_nodes);this.highlight_nodes();return}}};InteractionHandler.prototype.on_tap=function(event){var evt=this.selectInputEvent(event,d3.event);if(!event&&this.recorder)this.recorder.record({type:"on_tap",altKey:evt.altKey,shiftKey:evt.shiftKey,finger:{pos:evt.finger.pos}});if(this.active_handler){this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();this.active_handler=null}if(evt.shiftKey)return;var n=this.get_closest_node_at(evt.finger.pos);var self=this;if(n)this.view.eqtree.process_operator(n,function(){self.selected_nodes=[];self.highlight_nodes();self.end_of_interaction()})};InteractionHandler.prototype.selectInputEvent=function(arg_evt,d3_evt){if(arg_evt)return arg_evt;var src_evt=d3_evt;while(src_evt.sourceEvent)src_evt=src_evt.sourceEvent;d3_evt.shiftKey=src_evt.shiftKey;d3_evt.altKey=src_evt.altKey;return d3_evt};InteractionHandler.prototype.on_drag_start=function(event){var evt=this.selectInputEvent(event,d3.event);if(!event&&this.recorder)this.recorder.record(new DragStartEvent(evt));if(this.active_handler)return;if(this.selected_nodes.length>1){this.selected_nodes=Tree.nodes_to_range(this.selected_nodes)}this.select_new_handler(evt)};InteractionHandler.prototype.update_fingers=function(fingers,update_only){if(!this.finger_sel){this.finger_sel=this.view.main.selectAll(".finger")}var f=this.finger_sel.data(fingers);if(!update_only)f.enter().append("circle").classed("finger",true).attr("r",20).style("fill","silver").style("fill-opacity",.5);f.attr("cx",function(d){return d.pos[0]}).attr("cy",function(d){return d.pos[1]});f.exit().remove();this.finger_sel=f};InteractionHandler.prototype.on_drag=function(event){var evt=this.selectInputEvent(event,d3.event);if(!event&&this.recorder){var fingers=evt.fingers.map(function(f){return{pos:f.pos}});this.recorder.record({type:"on_drag",dx:evt.dx,dy:evt.dy,dist:evt.dist,dist0:evt.dist0,pos:evt.pos,pos0:evt.pos0,fingers:fingers})}else if(event)this.update_fingers(event.fingers,true);if(!this.active_handler)this.select_new_handler(evt);if(this.active_handler)this.active_handler.update(evt)};InteractionHandler.prototype.on_drag_end=function(event){if(!event&&this.recorder)this.recorder.record({type:"on_drag_end"});if(!this.active_handler)return;this.selected_nodes=this.active_handler.end()||[];this.highlight_nodes();this.active_handler=null;this.end_of_interaction()};InteractionHandler.prototype.on_touch=function(event){var evt=this.selectInputEvent(event,d3.event);if(!event&&this.recorder){var fingers=evt.fingers.map(function(f){return{pos:f.pos}});this.recorder.record({type:"on_touch",fingers:fingers,shiftKey:evt.shiftKey,altKey:evt.altKey})}else if(event)this.update_fingers(event.fingers);if(this.active_handler)return;if(evt.fingers.length===1){var new_sel=this.get_user_selection(evt.fingers[0],null,evt);if(evt.shiftKey){this.selected_nodes=gmath.array.xor(this.selected_nodes,new_sel)}else{if(!gmath.array.containsAll(this.selected_nodes,new_sel)){this.selected_nodes=new_sel}}}else if(evt.fingers.length===2){this.selected_nodes=this.get_user_selection(evt.fingers[0],evt.fingers[1],evt)}this.highlight_nodes()};InteractionHandler.prototype.on_release=function(event){var evt=this.selectInputEvent(event,d3.event);if(!event&&this.recorder){var fingers=evt.fingers.map(function(f){return{pos:f.pos}});this.recorder.record({type:"on_release",fingers:fingers,shiftKey:evt.shiftKey,altKey:evt.altKey})}else if(event)this.update_fingers(event.fingers);if(evt.fingers.length===0&&!evt.shiftKey){this.selected_nodes=[];if(this.interactive)this.highlight_nodes()}};InteractionHandler.prototype.get_user_selection=function(finger1,finger2,keys){var nodes;if(finger2)nodes=this.get_nodes_between(finger1.pos,finger2.pos);else{var n=this.get_closest_node_at(finger1.pos);if(!n)return[];if(keys.altKey&&n.parent.parent){if(n.parent.commutative)nodes=[n.parent.parent];else nodes=[n.parent]}else nodes=[n]}return Tree.nodes_to_range(nodes)};InteractionHandler.prototype.highlight_nodes=function(nodes){if(!nodes)nodes=this.selected_nodes;var v=this.view;Tree.for_each(function(n){n.selected=false},v.eqtree.children);for(var i=0;i<nodes.length;i++)nodes[i].selected=true;v.renderer.set_style(v.eqtree.children,true);v.update_style()};InteractionHandler.prototype.get_hits=function(pos){var x=pos[0],y=pos[1];return Tree.get_leaf_nodes(this.view.eqtree).filter(function(n){return!n.hidden&&n.sel_box&&x<=n.x+n.sel_box.x+n.sel_box.width&&x>=n.x+n.sel_box.x&&y<=n.y+n.sel_box.y+n.sel_box.height&&y>=n.y+n.sel_box.y})};InteractionHandler.prototype.get_closest_node_at=function(pos){var closest_node=null,closest=Infinity;var x=pos[0],y=pos[1];var nodes=this.get_hits(pos);for(var i=0;i<nodes.length;i++){if(nodes[i].hidden)continue;var dx=nodes[i].x-x;var dy=nodes[i].y-nodes[i].baseline_shift-y;var dist=dx*dx+dy*dy;if(dist<closest){closest=dist;closest_node=nodes[i]}}return closest_node};InteractionHandler.prototype.get_nodes_between=function(a,b){var margin=0;return Tree.get_leaf_nodes(this.view.eqtree).filter(function(n){if(n.hidden||!n.sel_box||n.value=="//")return false;var d=[n.x+n.sel_box.x+n.sel_box.width/2,n.y+n.sel_box.y+n.sel_box.height/2];var res=segment_to_point_dist(a,b,d);var radius=n.sel_box.width/4+n.sel_box.height/4;if(res.len==0)return res.dist<=radius+margin;return res.k>=0&&res.k<=1&&res.dist<=radius+margin})};var segment_to_point_dist=function(A,B,P){var dx,dy,k=.5;var AB=[B[0]-A[0],B[1]-A[1]];var len=Math.sqrt(AB[0]*AB[0]+AB[1]*AB[1]);if(len<1e-6){dx=A[0]-P[0];dy=A[1]-P[1];len=0}else{var AP=[P[0]-A[0],P[1]-A[1]];var k=(AB[0]*AP[0]+AB[1]*AP[1])/len;var dx,dy;if(k<0){dx=A[0]-P[0];dy=A[1]-P[1]}else if(k>len){dx=B[0]-P[0];dy=B[1]-P[1]}else{dx=A[0]+k*AB[0]/len-P[0];dy=A[1]+k*AB[1]/len-P[1]}}return{dist:Math.sqrt(dx*dx+dy*dy),k:k/len,len:len}};var DragStartEvent=function(evt){this.type="on_drag_start";this.pos=evt.pos;this.pos0=evt.pos0;this.dist=evt.dist;this.dist0=evt.dist0;this.altKey=evt.altKey;this.shiftKey=evt.shiftKey;this.fingers={length:evt.fingers.length}};var JoinHandler=function(view){this.view=view;this.eqtree=this.view.eqtree;this.nodes=[];this.node_ids=[];this.joined=false;this.unjoined_state=null};JoinHandler.prototype.check=function(evt){return evt.dist-evt.dist0<-15};JoinHandler.prototype.start=function(center,nodes){this.nodes=this.proccess_selection(nodes);this.node_ids=this.nodes.map(function(node){return node.id});return this.nodes};JoinHandler.prototype.update=function(evt){if(this.joined){if(evt.dist>3*evt.dist0/4+10)this.unjoin();return}if(this.nodes.length<1||evt.dist>3*evt.dist0/4)return;var start_idx=this.nodes[0].commutative?1:0;this.unjoined_state=Tree.clone(this.eqtree.children[0],true);this.unjoined_state.parent=this.eqtree;this.joined=true;var self=this;var process_node=function(idx){self.eqtree.process_operator(self.nodes[idx],function(){if(idx+1<self.nodes.length)process_node(idx+1);else self.nodes=[]})};process_node(start_idx)};JoinHandler.prototype.unjoin=function(){var eq=this.eqtree;this.joined=false;eq.children[0]=this.unjoined_state;eq.changed();this.nodes=this.node_ids.map(function(id){return Tree.get_by_id(id,eq.children)})};JoinHandler.prototype.end=function(){this.nodes=[];this.node_ids=[];this.unjoined_state=null;this.joined=false};JoinHandler.prototype.proccess_selection=function(nodes){if(nodes.length!==2)return nodes;if(!nodes[0].parent.commutative||!nodes[1].is_group())return nodes;return nodes[1].children.slice()};var DragHandler=function(view,interaction_handler){this.view=view;this.eqtree=this.view.eqtree;this.interaction_handler=interaction_handler;this.show_target_areas=false;this.dx=0;this.dy=0;this.nodes=[];this.bbox=null;this.move_actions=[];this.target_areas=null};DragHandler.prototype.check=function(evt,nodes){var dx=evt.pos0[0]-evt.pos[0],dy=evt.pos0[1]-evt.pos[1];if(evt.fingers.length==1&&nodes.length==0)return false;return dx*dx+dy*dy>=8*8};DragHandler.prototype.start=function(center,nodes,do_not_process_nodes,moveActions,do_not_move_nodes){if(do_not_process_nodes)this.nodes=nodes;else this.nodes=this.process_selection(nodes);this.do_not_move_nodes=do_not_move_nodes;for(var i=0;i<this.nodes.length;i++)this.nodes[i].dragging=true;Tree.for_each(function(n){n.x0=n.x;n.y0=n.y},this.nodes);this.bbox=this.get_enclosing_rect(this.nodes);if(this.eqtree.hide_nodes())this.view.update_all();this.dx=0;this.dy=0;this.x0=this.x=center[0];this.y0=this.y=center[1];this.move_actions=moveActions||this.eqtree.getMoveActions(this.nodes);this.set_move_regions();this.get_hits(this.move_actions,this.bbox);if(this.show_target_areas){this.update_target_area_vis();this.bbox_vis=this.view.main.append("rect").style({fill:"none",stroke:"steelblue","stroke-width":2})}return this.nodes};DragHandler.prototype.set_move_regions=function(){this.move_actions.forEach(function(action){var n=action.target;switch(action.side){case"left-of":action.xmin=n.sel_box.x+n.x-5;action.xmax=n.sel_box.x+n.x+5;action.ymin=n.sel_box.y+n.y;action.ymax=n.sel_box.y+n.y+n.sel_box.height;break;case"right-of":action.xmin=n.sel_box.x+n.x+n.sel_box.width-5;action.xmax=n.sel_box.x+n.x+n.sel_box.width+5;action.ymin=n.sel_box.y+n.y;action.ymax=n.sel_box.y+n.y+n.sel_box.height;break;case"below":action.xmin=n.sel_box.x+n.x;action.xmax=n.sel_box.x+n.x+n.sel_box.width;action.ymin=n.sel_box.y+n.y+n.sel_box.height-5;action.ymax=n.sel_box.y+n.y+n.sel_box.height+5;break;case"above":action.xmin=n.sel_box.x+n.x;action.xmax=n.sel_box.x+n.x+n.sel_box.width;action.ymin=n.sel_box.y+n.y-5;action.ymax=n.sel_box.y+n.y+5;break;case"around":action.xmin=n.sel_box.x+n.x;action.xmax=n.sel_box.x+n.x+n.sel_box.width;action.ymin=n.sel_box.y+n.y;action.ymax=n.sel_box.y+n.y+n.sel_box.height}if(action.offset){action.xmin+=action.offset.x;action.xmax+=action.offset.x;action.ymin+=action.offset.y;action.ymax+=action.offset.y}})};DragHandler.prototype.update_target_area_vis=function(){this.target_areas=this.view.main.selectAll(".target_areas").data(this.move_actions);this.target_areas.enter().append("rect").classed("target_areas",true).style({fill:"none",stroke:"lightpink","stroke-width":2,"stroke-style":"dashed"});this.target_areas.attr("x",function(d){return d.xmin}).attr("y",function(d){return d.ymin}).attr("width",function(d){return d.xmax-d.xmin}).attr("height",function(d){return d.ymax-d.ymin});this.target_areas.exit().remove()};DragHandler.prototype.update_bbox_vis=function(){this.bbox_vis.attr("x",this.bbox.xmin).attr("y",this.bbox.ymin).attr("width",this.bbox.xmax-this.bbox.xmin).attr("height",this.bbox.ymax-this.bbox.ymin)};DragHandler.prototype.update=function(evt){var dx=evt.dx,dy=evt.dy;this.dx+=dx;this.dy+=dy;this.x+=dx;this.y+=dy;if(!this.do_not_move_nodes){Tree.for_each(function(n){n.x+=dx;n.y+=dy},this.nodes)}this.bbox.xmin+=dx;this.bbox.xmax+=dx;this.bbox.ymin+=dy;this.bbox.ymax+=dy;if(this.show_target_areas)this.update_bbox_vis();var hits=this.get_hits(this.move_actions,this.bbox);if(hits.length>0){this.move_term(hits[0])}this.view.update_positions()};DragHandler.prototype.reorderInRanges=function(nodes){if(nodes.length<2)return nodes;var tree=nodes[0].get_root();var idx=0;tree.for_each(function(n){n.order_num=idx++});return nodes.sort(function(a,b){return a.order_num-b.order_num})};DragHandler.prototype.move_term=function(action){this.eqtree.performPreviewAction(action);var nnodes=action.mapNodes(this.nodes);ns=nnodes;this.reorderInRanges(nnodes);var same=true,i;if(this.nodes.length!==nnodes.length)same=false;else for(i=0;i<this.nodes.length;i++)same=same&&this.nodes[i]===nnodes[i];if(!same){this.interaction_handler.highlight_nodes(nnodes);for(i=0;i<this.nodes.length;i++)this.nodes[i].dragging=false;for(i=0;i<nnodes.length;i++)nnodes[i].dragging=false;var nb=null,node;for(i=0;i<this.nodes.length;i++){node=this.nodes[i];if(nb=Tree.select_first(function(n){return n===node},nnodes))break}if(nb){var old={x:nb.x,y:nb.y};this.view.renderer.set_position(nnodes,true);var dx=nb.x-old.x,dy=nb.y-old.y;Tree.for_each(function(n){n.x-=dx;n.y-=dy},nnodes)}this.nodes=nnodes;for(i=0;i<this.nodes.length;i++)this.nodes[i].dragging=true}this.move_actions=this.eqtree.getMoveActions(this.nodes);this.set_move_regions();this.bbox=this.get_enclosing_rect(this.nodes);this.get_hits(this.move_actions,this.bbox);if(this.show_target_areas)this.update_target_area_vis();this.x0=this.x;this.y0=this.y;this.dx=0;this.dy=0};DragHandler.prototype.end=function(){Tree.for_each(function(n){n.selected=false;n.dragging=false},this.eqtree.children);this.eqtree.hide_nodes();this.nodes=[];this.move_actions=[];this.bbox=null;this.view.update_all();if(this.target_areas){this.target_areas.remove();this.target_areas=null}if(this.bbox_vis){this.bbox_vis.remove();this.bbox_vis=null}};DragHandler.prototype.get_enclosing_rect=function(nodes){var x0=Infinity,x1=-Infinity,y0=Infinity,y1=-Infinity;for(var i=0;i<nodes.length;i++){var n=nodes[i];if(n.hidden)continue;x0=Math.min(x0,n.sel_box.x+n.x);x1=Math.max(x1,n.sel_box.x+n.x+n.sel_box.width);y0=Math.min(y0,n.sel_box.y+n.y);y1=Math.max(y1,n.sel_box.y+n.y+n.sel_box.height)}return{xmin:x0,ymin:y0,xmax:x1,ymax:y1}};DragHandler.prototype.get_hits=function(areas,box){var res=[];for(var i=0;i<areas.length;i++){var a=areas[i];var hits_now=(a.xmin>=box.xmin&&a.xmin<=box.xmax||a.xmax>=box.xmin&&a.xmax<=box.xmax||a.xmin<=box.xmin&&a.xmax>=box.xmax)&&(a.ymin>=box.ymin&&a.ymin<=box.ymax||a.ymax>=box.ymin&&a.ymax<=box.ymax||a.ymin<=box.ymin&&a.ymax>=box.ymax);if(!a.was_hit&&hits_now)res.push(a);a.was_hit=hits_now}return res};DragHandler.prototype.process_selection=function(orig_nodes){var nodes=orig_nodes.slice();if(nodes.length===0)return[];if(nodes[0].commutative){var parent=nodes[0].parent;if(nodes.length<parent.children.length)return nodes;else nodes=[parent]}var n=nodes[0];while(!EqTree.is_top_most(n)&&!n.parent.is_group("equals")&&!n.commutative)n=n.parent;if(n.parent&&n.parent.is_group("equals")&&n.value=="=")n=n.parent;return[n]};var SelectionHandler=function(view,interaction_handler){this.view=view;this.eqtree=this.view.eqtree;this.interaction_handler=interaction_handler;this.initial_nodes=[];this.nodes=[];this.pos0=null;this.pos=null;this.box_el=null};SelectionHandler.prototype.check=function(evt){console.log("selection handler",evt,evt.shiftKey);return evt.shiftKey};SelectionHandler.prototype.start=function(center,nodes){this.pos0=center.slice();this.pos=center.slice();this.initBox();this.initial_nodes=nodes;return nodes};SelectionHandler.prototype.update=function(evt){this.pos[0]+=evt.dx;
this.pos[1]+=evt.dy;this.updateBox();var nnodes=this.getNodesInRect(this.pos0[0],this.pos0[1],this.pos[0],this.pos[1]);if(gmath.array.isPermutation(nnodes,this.nodes))return;this.nodes=nnodes;this.highlight()};SelectionHandler.prototype.initBox=function(){this.box_el=this.view.main.append("rect").attr("transform","translate("+this.pos0+")").style("stroke",this.view.options.selection_color).style("stroke-width",2).style("fill",this.view.options.selection_color).style("fill-opacity",.33)};SelectionHandler.prototype.updateBox=function(){this.box_el.attr("width",Math.abs(this.pos[0]-this.pos0[0])).attr("height",Math.abs(this.pos[1]-this.pos0[1])).attr("transform","translate("+Math.min(this.pos0[0],this.pos[0])+","+Math.min(this.pos0[1],this.pos[1])+")")};SelectionHandler.prototype.getNodesInRect=function(l,t,r,b){var x0=Math.min(l,r),x1=Math.max(l,r);var y0=Math.min(t,b),y1=Math.max(t,b);var ns=Tree.get_leaf_nodes(this.view.eqtree).filter(function(n){return!n.hidden&&n.sel_box&&x0<=n.x+n.sel_box.x+n.sel_box.width&&x1>=n.x+n.sel_box.x&&y0<=n.y+n.sel_box.y+n.sel_box.height&&y1>=n.y+n.sel_box.y});console.log("got",ns.length,"nodes");return ns};SelectionHandler.prototype.highlight=function(){this.interaction_handler.highlight_nodes(gmath.array.mergedNew(this.initial_nodes,this.nodes))};SelectionHandler.prototype.end=function(){this.box_el.remove();return gmath.array.mergedNew(this.initial_nodes,this.nodes)};var SplitHandler=function(view,interaction_handler){this.view=view;this.nodes=null;this.splitted=false;this.new_state=null;this.prevDist=null;this.interaction_handler=interaction_handler;this.actions=[SplitNumberAction,SplitProductAction,SplitPowerAction,SplitPowerSumAction,RemoveBracketsAction]};SplitHandler.prototype.check=function(evt){return evt.dist-evt.dist0>15};SplitHandler.prototype.start=function(center,nodes){this.prevDist=null;this.nodes=nodes;return this.nodes||[]};SplitHandler.prototype.end=function(){this.node=null;this.splitted=false};SplitHandler.prototype.getBestAction=function(tree,node,previousBestAction){var bestAction=previousBestAction;this.actions.forEach(function(action){if(bestAction&&action.priority<=bestAction.priority)return;if(action.match(node))bestAction=action.createBoundAction(tree,{actor:node})});for(var i=node.children.length-1;i>=0;i--){var child=node.children[i];var bestChildAction=this.getBestAction(tree,child,bestAction);if(bestChildAction)bestAction=bestChildAction}return bestAction};SplitHandler.prototype.split=function(tree,nodes){var best_action;for(var i=nodes.length-1;i>=0;i--){best_action=this.getBestAction(tree,nodes[i],best_action)}if(!best_action)return false;tree.performPreviewAction(best_action);tree.hide_nodes();tree.changed();var res_nodes=Tree.nodes_to_range(best_action.mapNodes(best_action.actor));return res_nodes};SplitHandler.prototype.update=function(evt){if(!this.nodes)return;if(this.prevDist!==null&&evt.dist-this.prevDist<=30)return;var res_nodes=this.split(this.view.eqtree,this.nodes);if(!res_nodes)return;this.prevDist=evt.dist;this.nodes=res_nodes;this.interaction_handler.highlight_nodes(this.nodes)};var FontLoader=function(svg,fontnames,max_wait){var core={};core.fonts=fontnames.slice();core.map={};core.callback_list=[];core.finished=false;core.success=false;core.svg=svg;core.on_load=function(callback){if(this.finished)callback(this.success);else{this.callback_list.push(callback)}};core.on_finished=function(){for(var i=0;i<this.callback_list.length;i++){this.callback_list[i](this.success)}};core.load=function(){this.finished=false;this.success=false;this.fonts.unshift("");var txt=this.svg.selectAll("text.temp").data(this.fonts).enter().append("text").classed("temp",true).attr("font-size","100px").attr("font-family",function(d){return d==""?"sans-serif":"'"+d+"',sans-serif"}).style("visibility","hidden").text("012abc");this.fonts.shift();var t0=Date.now();var self=this;var timer=setInterval(function(){var w=[],all_loaded=true;txt.each(function(d,i){w[i]=this.getBBox().width});for(var i=0;i<w.length-1;i++)for(var j=i+1;j<w.length;j++){if(w[i]==w[j])all_loaded=false}var loading_time=Date.now()-t0;if(!all_loaded&&loading_time<=max_wait)return;self.success=all_loaded;self.finished=true;txt.remove();clearInterval(timer);self.on_finished()},20)};core.loadSizes=function(chars,fonts){chars=chars||"xyz0123456789()=+-*^∗·•−,.";fonts=fonts||this.fonts;var c_arr=[];for(var i=0;i<fonts.length;i++){if(!this.map[fonts[i]]){this.map[fonts[i]]={};this.fonts.push(fonts[i])}for(var j=0;j<chars.length;j++){var char={font:fonts[i],"char":chars[j],width:0,heigth:0};this.map[fonts[i]][chars[j]]=char;c_arr.push(char)}}this.svg.selectAll(".hiddenChars").data(c_arr).enter().append("text").classed("hiddenChars",true).attr("font-size","100px").attr("font-family",function(d){return d.font}).text(function(d){return d.char});this.svg.selectAll(".hiddenChars").each(function(d){var bb=this.getBBox();d.width=bb.width;d.height=bb.height}).remove()};core.width=function(val,size,font){font=font||this.fonts[0];var w=0,str=val.toString();for(var i=0;i<str.length;i++){if(!this.map[font]||!this.map[font][str[i]])this.loadSizes(str[i],[font]);w+=this.map[font][str[i]].width}return w*size/100};core.height=function(val,size,font){font=font||this.fonts[0];var h=0,str=val.toString();for(var i=0;i<str.length;i++){if(!this.map[font]||!this.map[font][str[i]])this.loadSizes(str[i],[font]);h=Math.max(this.map[font][str[i]].height,h)}return h*size/100};core.load();return core};transform_behavior=function(){var event=d3_eventDispatch(tg,"transform","transformend","transformstart"),fingers=[],x=0,y=0,rotate=0,scale=1,allow={scale:true,translate:true,rotate:true},one_finger_drag=true,pos,pos0,loc0,dist,dist0,angle,angle0,scale0,rot0;var tg=function(){this.on("touch.transform",touched).on("mdrag.transform",dragged).on("release.transform",released)};tg.transform=function(val){if(!arguments.length)return{scale:scale,rotate:rotate,translate:[x,y]};if("scale"in val)scale=val.scale;if("rotate"in val)rotate=val.rotate;if("translate"in val){x=val.translate[0];y=val.translate[1]}return tg};tg.one_finger_drag=function(val){if(!arguments.length)return one_finger_drag;one_finger_drag=val;return tg};tg.allow_translate=function(val){if(!arguments.length)return allow.translate;allow.translate=val;return tg};tg.allow_scale=function(val){if(!arguments.length)return allow.scale;allow.scale=val;return tg};tg.allow_rotate=function(val){if(!arguments.length)return allow.rotate;allow.rotate=val;return tg};var touched=function(){if(fingers.length==2)return;fingers.push(d3.event.finger);if(fingers.length==1&&one_finger_drag){pos=pos0=[fingers[0].pos[0],fingers[0].pos[1]];loc0=to_location(pos0);event.of(this,arguments)({type:"transformstart"})}if(fingers.length==2){pos=pos0=get_mean(fingers[0].pos,fingers[1].pos);dist=dist0=get_distance(fingers[0].pos,fingers[1].pos);angle=angle0=get_angle(fingers[0].pos,fingers[1].pos);loc0=to_location(pos0);scale0=scale;rot0=rotate}};var dragged=function(){if(fingers.length==0)return;if(!d3.event.dragged_fingers.some(function(f){return f.changed}))return;if(fingers.length==1&&one_finger_drag){if(allow.translate)pos=[fingers[0].pos[0],fingers[0].pos[1]];translateTo(pos,loc0)}if(fingers.length==2){if(allow.scale)dist=get_distance(fingers[0].pos,fingers[1].pos);if(allow.translate)pos=get_mean(fingers[0].pos,fingers[1].pos);if(allow.rotate)angle=get_angle(fingers[0].pos,fingers[1].pos);update_transform()}event.of(this,arguments)({type:"transform",fingers:fingers,transform:{scale:scale,rotate:rotate,translate:[x,y]}})};var released=function(){if(fingers.length==0)return;var f=d3.event.finger;var idx=fingers.indexOf(f);if(idx==-1)return;fingers.splice(idx,1);if(fingers.length==0){event.of(this,arguments)({type:"transformend"})}if(fingers.length==1){pos=pos0=[fingers[0].pos[0],fingers[0].pos[1]];loc0=to_location(pos0)}};var update_transform=function(){if(allow.rotate)rotate=rot0+(angle-angle0);if(allow.scale)scale=scale0*dist/dist0;if(allow.translate||allow.rotate||allow.scale)translateTo(pos,loc0)};var to_screen=function(l){var cos=Math.cos(rotate),sin=Math.sin(rotate);var rx=l[0]*cos-l[1]*sin,ry=l[1]*cos+l[0]*sin;return[rx*scale+x,ry*scale+y]};var to_location=function(p){var sx=(p[0]-x)/scale,sy=(p[1]-y)/scale;var cos=Math.cos(-rotate),sin=Math.sin(-rotate);return[sx*cos-sy*sin,sy*cos+sx*sin]};var translateTo=function(p,l){l=to_screen(l);x+=p[0]-l[0];y+=p[1]-l[1]};function get_distance(p1,p2){return Math.sqrt((p1[0]-p2[0])*(p1[0]-p2[0])+(p1[1]-p2[1])*(p1[1]-p2[1]))}function get_mean(p1,p2){return[(p1[0]+p2[0])/2,(p1[1]+p2[1])/2]}function get_angle(p1,p2){return Math.atan2(p1[1]-p2[1],p1[0]-p2[0])}return d3.rebind(tg,event,"on")};gmath.transform_behavior=transform_behavior;var SubstitutionHandler=function(view,interaction_handler){this.interaction_handler=interaction_handler;this.dl=view.options.derivation_list;this.view=view;this.eqtree=view.eqtree;this.line={A:{},B:{}};this.line_el=null;this.otherLines=[];this.otherLine_els=[];this.targets=[];this.currentTarget=-1;this.processed_color="rgb(200,200,200)"};SubstitutionHandler.prototype.check=function(evt,nodes){if(evt.fingers.length===1&&nodes.length===1&&nodes[0].value==="="){return true}return false};SubstitutionHandler.prototype.start=function(){this.collectSurroundingsInfo();this.highlightAllPotentialMatches();this.initializeLine();return[]};SubstitutionHandler.prototype.collectSurroundingsInfo=function(){this.derivationLists=this.dl.page_model.getDerivationLists().map(function(dl){return dl.term});this.ignoreSourceDerivationList();this.activeRows=this.derivationLists.map(function(dl){return dl.getLastRow()});this.algebraModels=this.derivationLists.map(function(dl){return dl.getLastModel()});this.organizeDataIntoTargets()};SubstitutionHandler.prototype.ignoreSourceDerivationList=function(){this.derivationLists.splice(this.derivationLists.indexOf(this.dl),1)};SubstitutionHandler.prototype.organizeDataIntoTargets=function(){for(var i=0;i<this.derivationLists.length;i++){var target={dl:this.derivationLists[i],row:this.activeRows[i],model:this.algebraModels[i],potentialMatches:this.eqtree.SubstitutionAction.findAllMatches(this.eqtree,this.algebraModels[i]),results:[]};this.targets.push(target)}};SubstitutionHandler.prototype.highlightAllPotentialMatches=function(){for(var i=0;i<this.targets.length;i++){var ranges=this.targets[i].potentialMatches;var all_nodes=[];for(var j=0;j<ranges.length;j++)all_nodes=all_nodes.concat(ranges[j]);this.targets[i].row.view.interaction_handler.highlight_nodes(all_nodes)}};SubstitutionHandler.prototype.initializeLine=function(){this.line_el=this.makeLineElement();this.initializeLineObject(this.calculateCenterOfEqualsSymbol())};SubstitutionHandler.prototype.makeLineElement=function(){var line=d3.select("#lines").append("line").classed("substitution",true).style("stroke",this.currentTargetExists()?this.processed_color:this.view.options.selection_color).style("stroke-width",6).style("stroke-linecap","round");return line};SubstitutionHandler.prototype.currentTargetExists=function(){return this.currentTarget>=0};SubstitutionHandler.prototype.calculateCenterOfEqualsSymbol=function(){var dl=this.dl,row=dl.getLastRow(),model=dl.getLastModel(),equalsSymNode=model.get_child([0,1]);var x=dl.pos[0]+row.pos[0]+equalsSymNode.x+equalsSymNode.sel_box.x+equalsSymNode.sel_box.width/2,y=dl.pos[1]+row.pos[1]+equalsSymNode.y+equalsSymNode.sel_box.y+equalsSymNode.sel_box.height/2;return[x,y]};SubstitutionHandler.prototype.initializeLineObject=function(center){this.line.A.x=this.line.B.x=center[0];this.line.A.y=this.line.B.y=center[1]};SubstitutionHandler.prototype.update=function(evt){this.updateLineObject(evt);this.collectPassedOverNodes();this.highlightAllPotentialMatches();this.updateLineElement()};SubstitutionHandler.prototype.updateLineObject=function(evt){this.line.B.x+=evt.dx;this.line.B.y+=evt.dy};SubstitutionHandler.prototype.updateLineElement=function(){this.line_el.attr("x1",this.line.A.x).attr("y1",this.line.A.y).attr("x2",this.line.B.x).attr("y2",this.line.B.y)};SubstitutionHandler.prototype.collectPassedOverNodes=function(){for(var i=0;i<this.targets.length;i++){this.setCurrentTarget(i);this.findMatchingEndpointNodesInTarget()}};SubstitutionHandler.prototype.setCurrentTarget=function(i){this.currentTarget=i};SubstitutionHandler.prototype.findMatchingEndpointNodesInTarget=function(){var matches=this.targets[this.currentTarget].potentialMatches.slice();for(var i=0;i<matches.length;i++){this.collectNode(matches[i])}};SubstitutionHandler.prototype.collectNode=function(nodes){if(this.isUnderLineEndpoint(nodes)){this.removeNodesFromPotentialMatchesList(nodes);this.addNodeToResultsList(nodes);this.drawLineFromEqualsSignToMatchingEndpointNode(nodes);return true}return false};SubstitutionHandler.prototype.getRangeBBox=function(nodes){var x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity,n;for(var i=0;i<nodes.length;i++){n=nodes[i];x1=Math.min(n.x+n.sel_box.x,x1);x2=Math.max(n.x+n.sel_box.x+n.sel_box.width,x2);y1=Math.min(n.y+n.sel_box.y,y1);y2=Math.max(n.y+n.sel_box.y+n.sel_box.height,y2)}return{x:x1,y:y1,height:y2-y1,width:x2-x1}};SubstitutionHandler.prototype.isUnderLineEndpoint=function(nodes){var target=this.targets[this.currentTarget];var B=this.line.B;var bbox=this.getRangeBBox(nodes);var targetX1=target.dl.pos[0]+target.row.pos[0]+bbox.x,targetX2=target.dl.pos[0]+target.row.pos[0]+bbox.x+bbox.width,targetY1=target.dl.pos[1]+target.row.pos[1]+bbox.y,targetY2=target.dl.pos[1]+target.row.pos[1]+bbox.y+bbox.height;return targetX1<B.x&&B.x<targetX2&&targetY1<B.y&&B.y<targetY2};SubstitutionHandler.prototype.removeNodesFromPotentialMatchesList=function(nodes){var target=this.targets[this.currentTarget];target.potentialMatches.splice(target.potentialMatches.indexOf(nodes),1)};SubstitutionHandler.prototype.addNodeToResultsList=function(nodes){this.targets[this.currentTarget].results.push(nodes)};SubstitutionHandler.prototype.drawLineFromEqualsSignToMatchingEndpointNode=function(node){var coordinates=this.getTargetNodeCoordinatesForLine(node);this.otherLine_els.push(this.makeLineElement());this.otherLines.push(this.initializeOtherLineObject(coordinates));this.setCoordinatesOfLastOtherLineElement()};SubstitutionHandler.prototype.getTargetNodeCoordinatesForLine=function(nodes){var target=this.targets[this.currentTarget],dl=target.dl,row=target.row;var bbox=this.getRangeBBox(nodes);var x=dl.pos[0]+row.pos[0]+bbox.x+bbox.width/2,y=dl.pos[1]+row.pos[1]+bbox.y+bbox.height/2;return[x,y]};SubstitutionHandler.prototype.initializeOtherLineObject=function(targetCoordinates){var line={A:{x:this.line.A.x,y:this.line.A.y},B:{x:targetCoordinates[0],y:targetCoordinates[1]}};return line};SubstitutionHandler.prototype.setCoordinatesOfLastOtherLineElement=function(){var lastOtherLine=this.otherLines[this.otherLines.length-1],lastOtherLine_el=this.otherLine_els[this.otherLine_els.length-1];lastOtherLine_el.attr("x1",lastOtherLine.A.x).attr("y1",lastOtherLine.A.y).attr("x2",lastOtherLine.B.x).attr("y2",lastOtherLine.B.y)};SubstitutionHandler.prototype.end=function(){for(var i=0;i<this.targets.length;i++){this.setCurrentTarget(i);if(this.currentTargetHasCollectedNodes()){this.performSubstitutionOnCurrentTarget()}}this.eraseInfoAndCleanBoard()};SubstitutionHandler.prototype.currentTargetHasCollectedNodes=function(){return this.targets[this.currentTarget].results.length>0};SubstitutionHandler.prototype.performSubstitutionOnCurrentTarget=function(){var target=this.targets[this.currentTarget];target.model.performAction(target.model.SubstitutionAction,{source:this.eqtree,target:target.results},null,"substitution")};SubstitutionHandler.prototype.eraseInfoAndCleanBoard=function(){this.removeAllLineElements();this.unhighlightAllNodes();this.otherLines=[];this.otherLine_els=[];this.targets=[];this.currentTarget=-1};SubstitutionHandler.prototype.removeAllLineElements=function(){this.line_el.remove();for(var i=0;i<this.otherLine_els.length;i++){this.otherLine_els[i].remove()}};SubstitutionHandler.prototype.unhighlightAllNodes=function(){for(var i=0;i<this.targets.length;i++){this.interaction_handler.highlight_nodes([],this.targets[i].row.view)}};Canvas=function(model,scheme){var dispatch=d3.dispatch("transform","erase","start_hwr","stop_hwr");var width=1280,height=720,container=null,mtouch=null,g_el=null,g_terms=null,overlay=null,g_paths=null,line=d3.svg.line(),keyboard=Keyboard(),mode="draw",marker_radius=6,eraser_radius=50,eraser_head=null,color="black",tg=null,translate=[0,0],panning=false,offset=0,f_count=0,f_timer=false,fullscreen=false,c_obj=null,c_id=null,hwr_delay=1500,pathsIndex=-1,hwr_timer=null,actionExpire=null,hwr=true;var new_pos=null;var canvas=function(_container){container=_container;tg=transform_behavior().on("transform",transform);tg.allow_rotate(false);tg.allow_scale(false);mtouch=mtouch_events().on("touch",touch).on("drag",drag).on("release",release).on("hold",createFormula).hold_max_dist(5).hold_time(750).call(tg);keyboard.width(800).position("left").on("done",enteredTerm).on("cancel",kbCancelled)();g_el=container.append("g");g_paths=g_el.append("g").attr("id","lines");overlay=g_el.append("rect").style({fill:"none","pointer-events":"all"}).attr("x",offset).attr("width",width-offset).attr("height",height).call(mtouch);mtouch.frame(overlay.node());g_terms=g_el.append("g").attr("id","terms");return this};canvas.width=function(arg){if(arguments.length===0)return width;width=arg;if(overlay)overlay.attr("width",width);return this};canvas.height=function(arg){if(arguments.length===0)return height;height=arg;if(overlay)overlay.attr("height",height);return this};canvas.offset=function(arg){if(arguments.length===0)return offset;offset=arg;return this};canvas.mode=function(arg){if(arguments.length===0)return mode;mode=arg;return this};canvas.color=function(arg){if(arguments.length===0)return color;color=arg;return this};canvas.markerRadius=function(arg){if(arguments.length===0)return marker_radius;marker_radius=arg;return this};canvas.eraserRadius=function(arg){if(arguments.length===0)return eraser_radius;eraser_radius=arg;return this};canvas.hwr_delay=function(arg){if(arguments.length===0)return hwr_delay;hwr_delay=arg;return this};canvas.undo=function(remote){if(model.paths().length===0)return;model.removePath(g_paths,-1)};canvas.clear=function(remote){};canvas.panning=function(arg){if(arguments.length===0)return panning;panning=arg;return this};canvas.getPathG=function(){return g_paths};canvas.getTermG=function(){return g_terms};canvas.getTranslate=function(){return translate};canvas.setTransform=function(t){transform(t)};canvas.fullscreen=function(){var svg=d3.select("svg"),body=d3.select("body");if(fullscreen===false){if(container.node().requestFullscreen){container.node().requestFullscreen();fullscreen=true}else if(container.node().msRequestFullscreen){container.node().msRequestFullscreen();fullscreen=true}else if(container.node().mozRequestFullScreen){container.node().mozRequestFullScreen();fullscreen=true}else if(container.node().webkitRequestFullscreen){container.node().webkitRequestFullscreen();fullscreen=true}if(fullscreen){svg.style("margin-left",-1);svg.style("margin-top",-1);body.style("margin","0px 0px 0px 0px")}}else{if(document.exitFullscreen){document.exitFullscreen();fullscreen=false}else if(document.msExitFullscreen){document.msExitFullscreen();fullscreen=false}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();fullscreen=false}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();fullscreen=false}if(!fullscreen){svg.style("margin-left","auto");svg.style("margin-top","auto");body.style("margin","8px 8px 8px 8px")}}};canvas.tg=function(){return tg};canvas.HWRecognition=function(arg){if(!arguments.length)return hwr;if(hwr===arg)return;pathsIndex=model.paths().length;hwr=arg;if(!hwr)canvas.cancelHWR();return canvas};canvas.scheduleHWR=function(){if(pathsIndex<0)pathsIndex=model.paths().length-1;if(!hwr_timer){hwr_timer=setTimeout(canvas.performHWR,hwr_delay);dispatch.start_hwr()}};canvas.cancelHWR=function(){if(hwr_timer){clearTimeout(hwr_timer);hwr_timer=null;dispatch.stop_hwr()}};canvas.performHWR=function(){hwr_timer=null;dispatch.stop_hwr();var strokes=[],pathsRange=[pathsIndex,model.paths().length];model.paths().slice(pathsIndex).forEach(function(d){strokes.push(convertPath(d.path))});recognize(strokes,function(d){var result=d.result.results[0];if(result){var pos=[strokes[0].x[0],strokes[0].y[0]];c_obj={position:pos,expression:result.value};var parse_error=model.drawTerm("terms",c_obj);if(parse_error)return;var paths=model.paths(),removed=paths.splice(pathsRange[0],pathsRange[1]);model.removeAllPaths();model.paths(paths);model.drawAllPaths();var aX=pos[0]-10,aY=pos[1]-85,g_action=g_terms.append("g").attr("transform","translate("+aX+", "+aY+")");g_action.append("circle").attr("r",10).attr("fill","red").on("click",function(){model.removeAllPaths();model.paths(paths.concat(removed));model.drawAllPaths();var terms=model.terms(),termID=terms.pop().id;model.terms(terms);d3.select("#"+termID).remove();g_action.remove();clearTimeout(actionExpire)});g_action.append("circle").attr("cy",20).attr("r",10).attr("fill","blue").on("click",function(){model.removeAllPaths();model.paths(paths.concat(removed));model.drawAllPaths();var terms=model.terms(),termID=terms.pop().id;model.terms(terms);d3.select("#"+termID).remove();g_action.remove();clearTimeout(actionExpire);pathsIndex=pathsRange[0]});actionExpire=setTimeout(function(){g_action.remove()},2e3)}});pathsIndex=-1};var touch=function(event){panning=false;var evt=event||d3.event,pos=evt.finger.pos0.slice();if(!f_timer){f_count++;f_timer=true;setTimeout(function(){touch(evt)},30);return}else{if(!event){f_count++;return}else{if(f_count>1){panning=true}else{pos[0]-=translate[0];pos[1]-=translate[1];c_obj={};c_obj.path=[pos];if(mode==="draw"){c_obj.color=color;c_obj.width=2*marker_radius}if(mode==="erase"){c_obj.color="white";c_obj.width=2*eraser_radius}canvas.cancelHWR();c_id=model.drawPath("lines",c_obj);if(mode==="erase"){eraser_head=g_paths.append("circle").attr({cx:pos[0],cy:pos[1],r:eraser_radius}).style({stroke:scheme.p,fill:"white"})}}f_count=0;f_timer=false}}};var drag=function(event){var evt=event||d3.event,pos=evt.finger.pos.slice();if(evt.fingers.length>1||panning||f_timer)return;pos[0]-=translate[0];pos[1]-=translate[1];c_obj.path.push(pos);model.updatePath(c_obj,c_id);if(mode==="erase")eraser_head.attr({cx:pos[0],cy:pos[1]})};var release=function(event){if(mode==="erase"){eraser_head.remove();var old_paths=model.paths(),eraser_path=old_paths.pop().path,new_paths=[];old_paths.forEach(function(d){var split_path=erase([d],eraser_path,eraser_radius);split_path.forEach(function(e){new_paths.push({path:e,color:d.color,width:d.width,id:gmath.uid()})})});var rfunc=model.removeAllPaths();model.paths(new_paths);var dfunc=model.drawAllPaths();dispatch.erase(rfunc,dfunc)}else if(!keyboard.visible()&&hwr)canvas.scheduleHWR()};var convertPath=function(path){var stroke={type:"stroke",x:[],y:[]};path.forEach(function(d){stroke.x.push(d[0]);stroke.y.push(d[1])});return stroke};var recognize=function(strokes,handler){url="https://myscript-webservices.visionobjects.com/api/myscript/v2.0/equation/doSimpleRecognition.json";var jsonPost={components:strokes,resultTypes:["LATEX"]};var data={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(jsonPost)};$.post(url,data,handler,"json").error(function(XMLHttpRequest,textStatus){console.log(textStatus+" : "+XMLHttpRequest.responseText)})};var createFormula=function(event){var evt=event||d3.event;canvas.cancelHWR();model.removePath(g_paths,-1);var pos=evt.finger.pos.slice();pos[0]+=-translate[0];pos[1]+=-translate[1];c_obj={};c_obj.position=pos;keyboard.latex("").visible(true)};var enteredTerm=function(latex,remote){c_obj.expression=latex;model.drawTerm("terms",c_obj);keyboard.visible(false)};var kbCancelled=function(latex,remote){keyboard.visible(false)};var transform=function(d){var t=d||d3.event;if(!d){if(t.fingers.length!==2&&!panning)return;t=t.transform;t.translate[0]=0;t.translate[1]=Math.min(0,t.translate[1]);dispatch.transform(t)}translate=t.translate;tg.transform(t);g_paths.transition().duration(0).attr("transform",transform_string(t));g_terms.transition().duration(0).attr("transform",transform_string(t))};var transform_string=function(t){var res=[];if(t.translate&&(t.translate[0]||t.translate[1])){res.push("translate("+t.translate+")")}if(t.scale&&(t.scale[0]!==1||t.scale[1]!==1)){res.push("scale("+t.scale+")")}if(t.rotate){res.push("rotate("+t.rotate*180/Math.PI+")")}return res.join("")};return d3.rebind(canvas,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Canvas=Canvas;erase=function(){function erase(paths,erasePath,eraseRadius){eraseRadius=eraseRadius||20;var newPaths=[];var pointErase=function(path){if(path.path){eraseRadius=eraseRadius+path.width/2;var path=path.path}var eX=erasePath[0][0];var eY=erasePath[0][1];var i=0;var last=0;if(path.length===1){if(!withinCircle(path[0][0],path[0][1],eX,eY,eraseRadius)){newPaths.push(path);return}}var newPath;while(i<path.length-1){var p0=path[i];var p1=path[i+1];var p0_withinCircle=withinCircle(p0[0],p0[1],eX,eY,eraseRadius);var p1_withinCircle=withinCircle(p1[0],p1[1],eX,eY,eraseRadius);if(p0_withinCircle&&p1_withinCircle){i++;last=i}else if(p0_withinCircle&&!p1_withinCircle){var x=getCircleIntersection(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);if(x){path[i]=x;last=i}else{i++}}else if(!p0_withinCircle&&p1_withinCircle){var x=getCircleIntersection(p1[0],p1[1],p0[0],p0[1],eX,eY,eraseRadius);if(x){newPath=path.slice(last,i+1);newPath.push(x);newPaths.push(newPath)}i++;last=i}else{var possIntersects=getCircleIntersections(p0[0],p0[1],p1[0],p1[1],eX,eY,eraseRadius);if(possIntersects){newPath=path.slice(last,i+1);if(newPath[newPath.length-1][0]!==possIntersects[0][0]||newPath[newPath.length-1][1]!==possIntersects[0][1]){newPath.push(possIntersects[0])}if(newPath.length>1)newPaths.push(newPath);path[i]=possIntersects[1];if(path[i+1]&&path[i+1][0]==possIntersects[1][0]&&path[i+1][1]==possIntersects[1][1])i++;last=i}else{i++}}}if(last!==i){newPath=path.slice(last,path.length);if(newPath){newPaths.push(newPath)}}};var capsuleErase=function(path,i){if(path.path){eraseRadius=eraseRadius+path.width/2;var path=path.path}var e0=erasePath[i];var e1=erasePath[i+1];var i=0;var last=0;if(path.length===1){var p0_locationIndex=withinCapsule(path[0][0],path[0][1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(p0_locationIndex.indexOf(1)===-1){newPaths.push(path);return}}var newPath;while(i<path.length-1){var p0=path[i];var p1=path[i+1];var p0_locationIndex=withinCapsule(p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);var p1_locationIndex=withinCapsule(p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(p0_locationIndex.indexOf(1)!==-1&&p1_locationIndex.indexOf(1)!==-1){i++;last=i}else if(p0_locationIndex.indexOf(1)!==-1&&p1_locationIndex.indexOf(1)===-1){var x=getCapsuleIntersection(p0[0],p0[1],p0_locationIndex,p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(x){path[i]=x;last=i}else{i++}}else if(p0_locationIndex.indexOf(1)===-1&&p1_locationIndex.indexOf(1)!==-1){var x=getCapsuleIntersection(p1[0],p1[1],p1_locationIndex,p0[0],p0[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(x){newPath=path.slice(last,i+1);newPath.push(x);newPaths.push(newPath);i++;last=i}else{i++}}else{var possIntersects=getCapsuleIntersections(p0[0],p0[1],p1[0],p1[1],e0[0],e0[1],e1[0],e1[1],eraseRadius);if(possIntersects){newPath=path.slice(last,i+1);if(newPath[newPath.length-1][0]!==possIntersects[0][0]||newPath[newPath.length-1][1]!==possIntersects[0][1]){newPath.push(possIntersects[0])}if(newPath.length>1)newPaths.push(newPath);path[i]=possIntersects[1];if(path[i+1]&&path[i+1][0]==possIntersects[1][0]&&path[i+1][1]==possIntersects[1][1])i++;last=i}else{i++}}}if(last!==i){newPath=path.slice(last,path.length);if(newPath){newPaths.push(newPath)}}};erasePath=cleanPath({path:erasePath});if(erasePath.length===1){for(var p=0;p<paths.length;p++){pointErase(paths[p])}paths=newPaths}else{for(var e=0;e<erasePath.length-1;e++){for(var p=0;p<paths.length;p++){capsuleErase(paths[p],e)}paths=newPaths;newPaths=[]}}for(var r=0;r<paths.length;r++){for(var rr=0;rr<paths[r].length;rr++){paths[r][rr][0]=Math.round(paths[r][rr][0]);paths[r][rr][1]=Math.round(paths[r][rr][1])}}return paths}function displayPath(path){if(path.path){var path=path.path}document.write("[");for(var i=0;i<path.length-1;i++){document.write("["+path[i][0]+","+path[i][1]+"],")}document.write("["+path[i][0]+","+path[i][1]+"]");document.write("]")}function displayPaths(paths){document.write("[");for(var i=0;i<paths.length-1;i++){displayPath(paths[i]);document.write(",<br />")}displayPath(paths[i]);document.write("]")}function logPath(path,displaySwitch){if(path.path){var path=path.path}var log="";log+="[";for(var i=0;i<path.length-1;i++){log+="["+path[i][0]+","+path[i][1]+"],"}log+="["+path[i][0]+","+path[i][1]+"]";log+="]";if(displaySwitch){console.log(log)}else{return log}}function logPaths(paths){log="";log+="[";for(var i=0;i<paths.length-1;i++){log+=logPath(paths[i],0);log+=","}log+=logPath(paths[i],0);log+="]";console.log(log)}function cleanPath(path){if(path.path){var path=path.path}var cleaned=[];if(path.length===1){cleaned=path}else{pClean=0;while(pClean<path.length-1){if(path[pClean][0]!==path[pClean+1][0]||path[pClean][1]!==path[pClean+1][1]){cleaned.push(path[pClean])}pClean++}if(path.length!==0&&cleaned.length===0){cleaned.push(path[0])}if(path[path.length-1][0]!==path[cleaned.length-1][0]||path[path.length-1][1]!==path[cleaned.length-1][1]){cleaned.push(path[pClean])}}return cleaned}function getDistance(aX,aY,bX,bY){return Math.sqrt(Math.pow(bX-aX,2)+Math.pow(bY-aY,2))}function withinCircle(x,y,cX,cY,r){var dist=getDistance(x,y,cX,cY);if(dist<r)return 1;else return 0}function withinBox(pX,pY,aX,aY,bX,bY,r){var vec_ab=[bX-aX,bY-aY];var vec_ap=[pX-aX,pY-aY];var vec_n=[-vec_ab[1],vec_ab[0]];var mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2));var u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n];var mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2));var u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab];var ap_proj_ab=vec_ap[0]*u_vec_ab[0]+vec_ap[1]*u_vec_ab[1];if(ap_proj_ab<=0||ap_proj_ab>=mag_ab)return 0;var ap_proj_n=vec_ap[0]*u_vec_n[0]+vec_ap[1]*u_vec_n[1];if(ap_proj_n>=r||ap_proj_n<=-r)return 0;return 1}function withinCapsule(pX,pY,aX,aY,bX,bY,r){var locationIndex=[];locationIndex.push(withinCircle(pX,pY,aX,aY,r));locationIndex.push(withinCircle(pX,pY,bX,bY,r));locationIndex.push(withinBox(pX,pY,aX,aY,bX,bY,r));return locationIndex}function getParallelSegments(aX,aY,bX,bY,r){var vec_v=[bX-aX,bY-aY];var vec_n=[-vec_v[1],vec_v[0]];var mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2));var u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n];var b0=[aX+r*u_vec_n[0],aY+r*u_vec_n[1]];var b1=[aX-r*u_vec_n[0],aY-r*u_vec_n[1]];var b2=[bX-r*u_vec_n[0],bY-r*u_vec_n[1]];var b3=[bX+r*u_vec_n[0],bY+r*u_vec_n[1]];return[b0,b1,b2,b3]}function getCircleIntersection(aX,aY,bX,bY,cX,cY,r){var vec_ac=[cX-aX,cY-aY];var vec_ab=[bX-aX,bY-aY];var mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2));var u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab];var ac_proj_ab=vec_ac[0]*u_vec_ab[0]+vec_ac[1]*u_vec_ab[1];var rightPoint=[aX+ac_proj_ab*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]];var distCToRightPoint=Math.sqrt(Math.pow(cX-rightPoint[0],2)+Math.pow(cY-rightPoint[1],2));var b;if(distCToRightPoint===0){b=r}else{var b=Math.sqrt(Math.pow(r,2)-Math.pow(distCToRightPoint,2))}var intersection=[aX+ac_proj_ab*u_vec_ab[0]+b*u_vec_ab[0],aY+ac_proj_ab*u_vec_ab[1]+b*u_vec_ab[1]];if(intersection[0]===aX&&intersection[1]===aY)return null;return intersection}function getCircleIntersections(aX,aY,bX,bY,cX,cY,r){var vec_ac=[cX-aX,cY-aY];var vec_ab=[bX-aX,bY-aY];var vec_n=[-vec_ab[1],vec_ab[0]];var mag_n=Math.sqrt(Math.pow(vec_n[0],2)+Math.pow(vec_n[1],2));var u_vec_n=[vec_n[0]/mag_n,vec_n[1]/mag_n];
var mag_d=vec_ac[0]*u_vec_n[0]+vec_ac[1]*u_vec_n[1];var closest=getClosestPointOnSegment([aX,aY],[bX,bY],[cX,cY]);var dist=getLength([closest[0]-cX,closest[1]-cY]);if(dist>=r)return null;var x=Math.sqrt(Math.pow(r,2)-Math.pow(mag_d,2));var vec_cd=[cX-mag_d*u_vec_n[0],cY-mag_d*u_vec_n[1]];var mag_ab=Math.sqrt(Math.pow(vec_ab[0],2)+Math.pow(vec_ab[1],2));var u_vec_ab=[vec_ab[0]/mag_ab,vec_ab[1]/mag_ab];var intersections=[[vec_cd[0]-u_vec_ab[0]*x,vec_cd[1]-u_vec_ab[1]*x],[vec_cd[0]+u_vec_ab[0]*x,vec_cd[1]+u_vec_ab[1]*x]];if(intersections[0][0]===aX&&intersections[0][1]===aY)return null;return intersections}function getLineIntersection(aX,aY,bX,bY,cX,cY,dX,dY){var s1_x,s1_y,s2_x,s2_y;s1_x=bX-aX;s1_y=bY-aY;s2_x=dX-cX;s2_y=dY-cY;var s,t;if(-s2_x*s1_y+s1_x*s2_y===0)return null;s=(-s1_y*(aX-cX)+s1_x*(aY-cY))/(-s2_x*s1_y+s1_x*s2_y);t=(s2_x*(aY-cY)-s2_y*(aX-cX))/(-s2_x*s1_y+s1_x*s2_y);if(s>=0&&s<=1&&t>=0&&t<=1){var intX=aX+t*s1_x;var intY=aY+t*s1_y;return[intX,intY]}return null}function getCapsuleIntersection(aX,aY,locationIndex,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r);var intersections=[];if(locationIndex[0]&&!locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r));intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1]));intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r);if(i)intersections.push(i[0],i[1])}else if(!locationIndex[0]&&locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r));intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1]));intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var i=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);if(i)intersections.push(i[0],i[1])}else if(locationIndex[0]&&locationIndex[1]){intersections.push(getCircleIntersection(aX,aY,bX,bY,c0_x,c0_y,r));intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1]));intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));intersections.push(getCircleIntersection(aX,aY,bX,bY,c1_x,c1_y,r))}else{var i=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r);var j=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);if(i)intersections.push(i[0],i[1]);if(j)intersections.push(j[0],j[1]);intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1]));intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]))}var intersection=[aX,aY];for(var n=0;n<intersections.length;n++){if(intersections[n]){if(getDistance(intersections[n][0],intersections[n][1],bX,bY)<getDistance(intersection[0],intersection[1],bX,bY)){intersection=intersections[n]}}}if(intersection[0]===aX&&intersection[1]===aY)return null;return intersection}function getCapsuleIntersections(aX,aY,bX,bY,c0_x,c0_y,c1_x,c1_y,r){var box=getParallelSegments(c0_x,c0_y,c1_x,c1_y,r);var intersections=[];var tmp=getCircleIntersections(aX,aY,bX,bY,c0_x,c0_y,r);if(tmp)intersections.push(tmp[0],tmp[1]);tmp=getCircleIntersections(aX,aY,bX,bY,c1_x,c1_y,r);if(tmp)intersections.push(tmp[0],tmp[1]);intersections.push(getLineIntersection(aX,aY,bX,bY,box[0][0],box[0][1],box[3][0],box[3][1]));intersections.push(getLineIntersection(aX,aY,bX,bY,box[1][0],box[1][1],box[2][0],box[2][1]));var intersection0=[bX,bY];var intersection1=[aX,aY];for(var n=0;n<intersections.length;n++){if(intersections[n]){if(getDistance(intersections[n][0],intersections[n][1],aX,aY)<getDistance(intersection0[0],intersection0[1],aX,aY)){intersection0=intersections[n]}}}for(var m=0;m<intersections.length;m++){if(intersections[m]){if(getDistance(intersections[m][0],intersections[m][1],bX,bY)<getDistance(intersection1[0],intersection1[1],bX,bY)){intersection1=intersections[m]}}}if(intersection0[0]===bX&&intersection0[1]===bY||intersection1[0]===aX&&intersection1[1]===aY)return null;else return[intersection0,intersection1]}var getLength=function(P){return Math.sqrt(P[0]*P[0]+P[1]*P[1])};var EPS=1e-6;var getClosestPointOnSegment=function(A,B,P){var AB=[B[0]-A[0],B[1]-A[1]],len=getLength(AB);if(len<EPS)return A;var PA=[P[0]-A[0],P[1]-A[1]];var k=(AB[0]*PA[0]+AB[1]*PA[1])/len;if(k<0)return A;if(k>len)return B;return[A[0]+AB[0]*k/len,A[1]+AB[1]*k/len]};return erase}();if(typeof exports!="undefined"){exports.erase=erase}Markers=function(scheme){var dispatch=d3.dispatch("marker","eraser","focus");var svg=null,x=0,y=0,scale=1,fn_marker=null,fn_eraser=null,markers=["black","red","green","blue",scheme.s,scheme.s,scheme.s],curr_idx=0,p_colors=["red","chocolate","orange","gold","yellow","lime","yellowgreen","green","turquoise","blue","navy","purple","fuchsia"],pd=200*scale,ph=pd/2,pr=70*scale,cr=15*scale,mr=6,er=50,sm=50,c_head="M 10 30 L 30 30 L 30 10 L 70 10 L 70 30 L 90 30 L 80 90 L 20 90 L 10 30 Z",c_body="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 30 90 Z",u_head="M 35 33 L 35 55 L 65 55 L 65 17 L 35 33 Z",u_body="M 30 90 Q 10 90 10 110 L 10 180 L 90 180 L 90 110 Q 90 90 70 90 L 67 90 L 67 55 L 33 55 L 33 90 L 30 90 Z",e_paths=["M 16 40 Q 14 42 15 45 L 52 78 Q 54 80 58 78 L 88 65 Q 89 62 86 59 L 86 57 Z","M 13 19 L 43 11 L 88 37 L 54 48 L 13 19 Z","M 13 19 L 16 41 L 55 74 L 87 61 L 88 37 L 54 48 L 13 19 Z"],m_held=-1,marker_els=null,scale_el=null,eraser_el=null,pallete_el=null,s_center=null,abs_sr=null,m_scale=1,e_scale=1;var markers_instance=function(container){svg=container;init();return this};markers_instance.pos=function(arg){if(arguments.length==0)return[x,y];x=arg[0];y=arg[1];if(svg)position_elements();return this};markers_instance.marker=function(arg){if(arguments.length==0)return curr_idx;selectMarker(arg);return this};markers_instance.color=function(){return markers[curr_idx]};markers_instance.scale=function(arg){if(arguments.length==0)return scale;scale=arg;return this};function init(){var m_mtouch=mtouch_events().frame(svg.node()).on("tap",function(d,i){dispatch.focus();selectMarker(i)}).on("hold",function(d,i){dispatch.focus();m_hold(d,i)});var p_mtouch=mtouch_events().frame(svg.node()).on("tap",function(d){dispatch.focus();p_tap(d)});var s_mtouch=mtouch_events().frame(svg.node()).on("drag",function(d){dispatch.focus();s_drag(d)});var e_mtouch=mtouch_events().frame(svg.node()).on("tap",function(d){dispatch.focus();e_tap(d)});marker_els=svg.selectAll(".marker_els").data(markers);marker_els.enter().append("svg").classed("marker_els",true).call(m_mtouch);marker_els.append("path").classed("pathhead",true).attr("d",c_head).attr("transform","scale("+scale*.5+")").style("fill",function(d){return d===scheme.s?scheme.q:d}).style("stroke",function(d){return d===scheme.s?d:"none"}).style("stroke-width","6").style("stroke-linejoin","round");marker_els.append("path").classed("pathBody",true).attr("d",c_body).attr("transform","scale("+scale*.5+")").style("fill",scheme.q).style("stroke",function(d){return d}).style("stroke-width","6").style("stroke-linejoin","round");pallete_el=svg.append("svg").classed("pallete",true).style("display","none");var pallete_bg=pallete_el.append("g");pallete_bg.append("path").attr("d","M 0 "+ph+" L "+pd+" "+ph+" L "+ph+" "+(pd+10)+" L 0 "+ph+" Z").style("fill",scheme.s);pallete_bg.append("circle").attr("cx",ph).attr("cy",ph).attr("r",ph).style("fill",scheme.s);var pallete_els=pallete_el.selectAll(".pallete_els").data(p_colors);pallete_els.enter().append("circle").classed("pallete_els",true).attr("cx",function(d,i){return ph+Math.cos(2*(i+1)*Math.PI/p_colors.length)*pr}).attr("cy",function(d,i){return ph+Math.sin(2*(i+1)*Math.PI/p_colors.length)*pr}).attr("r",cr).style("fill",function(d){return d}).call(p_mtouch);scale_el=svg.append("svg").call(s_mtouch);scale_bg=scale_el.append("circle").attr("cx",sm+3.75+1.25).attr("cy",sm+3.75+1.25).attr("r",sm+1.875+1.25).attr("transform","scale("+scale*.8+")").attr("stroke",scheme.s).attr("stroke-width",3.75).attr("fill",scheme.q);scaler=scale_el.append("circle").attr("cx",sm+3.75+1.25).attr("cy",sm+3.75+1.25).attr("r",mr).attr("transform","scale("+scale*.8+")").attr("fill",scheme.s);eraser_el=svg.append("svg").call(e_mtouch);eraser_el.append("path").attr("d",e_paths[0]).attr("fill",scheme.t);eraser_el.append("path").attr("d",e_paths[1]).attr("fill",scheme.s);eraser_el.append("path").attr("d",e_paths[2]).attr("fill",scheme.p);position_elements();abs_sr=sm*scale*.8;s_center=[scale_el.attr("x")*1+abs_sr+4,scale_el.attr("y")*1+abs_sr+4];selectMarker(0)}function position_elements(){marker_els.attr("x",function(d,i){return x+i*scale*60}).attr("y",y);scale_el.attr("x",x+markers.length*scale*60).attr("y",y+scale*8-4);eraser_el.attr("x",x+markers.length*scale*60+90).attr("y",y+scale*5);pallete_el.attr("y",y-pd-15)}function uncapMarker(u){marker_els.select(".pathhead").attr("d",function(d,i){return i===u?u_head:c_head}).style("fill",function(d){return d===scheme.s?scheme.q:d}).style("stroke",function(d){return d===scheme.s?d:"none"});marker_els.select(".pathBody").attr("d",function(d,i){return i===u?u_body:c_body}).style("stroke",function(d){return d});if(u!==-1)eraser_el.select("#eraser").style("fill",markers[curr_idx]);pallete_el.style("display","none");m_held=-1}var selectMarker=function(i){if(i<-1||i>=markers.length||markers[i]==scheme.s)return;curr_idx=i;uncapMarker(i);if(i!==-1){scaler.attr("r",mr).attr("fill",scheme.s);scale_bg.attr("fill",scheme.q);dispatch.marker(markers[i],mr*.8*m_scale)}};function m_hold(d,i){if(i!==0){var el=marker_els.filter(function(e,j){return j===i}),dx=el.attr("x")*1,dw=el.node().getBBox().width/2;pallete_el.attr("x",dx+dw-ph+scale*5).style("display","block");m_held=i}}function p_tap(d){markers[m_held]=d;marker_els=svg.selectAll(".marker_els").data(markers);selectMarker(m_held)}function s_drag(d){var pos=d3.event.finger.pos,dist=Math.sqrt(Math.pow(s_center[0]-pos[0],2)+Math.pow(s_center[1]-pos[1],2)),size=dist/abs_sr;if(size>1)size=1;if(size<.12)size=.12;if(curr_idx>-1){mr=abs_sr*size/scale/.8;dispatch.marker(markers[curr_idx],mr*.8*m_scale)}else{er=abs_sr*size/scale/.8;dispatch.eraser(er*.8*e_scale)}scaler.attr("r",sm*size)}function e_tap(d){selectMarker(-1);scaler.attr("r",er).attr("fill",scheme.q);scale_bg.attr("fill",scheme.s);dispatch.eraser(er*.8*e_scale)}return d3.rebind(markers_instance,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Markers=Markers;Pages=function(model,scheme){var dispatch=d3.dispatch("transform","focus"),svg=null,add=null,res=[1280,720],pages=[],tinys=[],t_width=95,t_scale=function(arg){var scale=t_width/(res[0]-t_width);if(arguments.length===0){return scale}return arg*scale},c_page=null,c_tiny=null,dragging=false,tg=null,t_gel=null,t_sel=null,t_progress=null;var pi=function(container){init(container);return this};pi.res=function(arg){if(arguments.length===0)return res;res[0]=arg[0];res[1]=arg[1];return this};pi.tWidth=function(arg){if(arguments.length===0)return t_width;t_width=arg;return this};pi.download=function(){var pages_clone=[],cid=c_page.id;pages.forEach(function(d){var d_clone={};d_clone.height=d.height;d_clone.id=d.id;d_clone.paths=d.paths;d_clone.terms=[];d.terms.forEach(function(e){d_clone.terms.push({containerID:d3.select(e.term.view.svg[0][0]).attr("id"),expression:e.expression,position:e.position})});d_clone.transform=d.transform;pages_clone.push(d_clone)});var blob=new Blob([JSON.stringify({pages:pages_clone,tinys:tinys,cid:c_page.id})],{type:"application/json"});saveAs(blob,"gmath-session.json");pages.forEach(function(d){if(d.id===cid){switch_page(d)}})};pi.upload=function(upload){pages=upload.pages;tinys=upload.tinys;t_sel=t_gel.selectAll(".t_el").data(tinys);t_sel.exit().remove();t_sel.enter().append("svg").classed("t_el",true).call(t_touch());t_sel.append("rect").attr("fill",scheme.q);t_sel.append("g").attr("transform"," translate ("+t_scale(-t_width)+", 0) scale("+t_scale()+")");t_sel.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",t_width-2).attr("stroke",scheme.p).attr("stroke-width",2).attr("fill","none").attr("display","none");t_progress=t_gel.selectAll(".t_progress").data(tinys);t_progress.enter().append("svg").classed("t_progress",true).attr("x",t_width+1);t_progress.append("rect").classed("bg",true).attr("width",4).attr("fill",scheme.t);t_progress.append("rect").classed("bar",true).attr("width",4).attr("height",t_scale(res[1])+4).attr("fill",scheme.p);for(var i=pages.length-1;i>-1;i--){c_page=pages[i];c_tiny=tinys[i];model.removeAllPaths();model.paths(c_page.paths);var drawFunction=model.drawAllPaths();drawFunction(this.selectTiny());model.hideAllTerms();c_page.terms.forEach(function(d){model.drawTerm(d.containerID,d)});dispatch.transform(c_page.transform)}pages.forEach(function(d){if(d.id===upload.cid){switch_page(d)}});size_tinys()};pi.selectTiny=function(arg){if(arguments.length===0){arg=c_tiny}return t_sel.filter(function(d){return d.id===arg.id}).select("g")};pi.selectPage=function(arg){if(arguments.length===0){return c_page}pages.forEach(function(p){if(p.id===arg.id){return p}})};pi.sizeTinys=function(){size_tinys()};pi.t_sel=function(){return t_sel};function init(container){svg=container;svg.append("rect").attr("x",0).attr("y",0).attr("width",t_width+7).attr("height",res[1]).attr("fill",scheme.s);svg.append("rect").attr("x",t_width+7).attr("y",0).attr("width",1).attr("height",res[1]).attr("fill",scheme.t);t_gel=svg.append("g").attr("transform","translate(1, 0)");var a_mtouch=mtouch_events().frame(svg.node()).on("tap",function(){dispatch.focus();a_tap()});add=svg.append("g").attr("transform","translate(1, "+(res[1]-51)+")").call(a_mtouch);add.append("rect").attr("rx",5).attr("ry",5).attr("width",t_width+5).attr("height",50).attr("fill",scheme.q);var c=(t_width+5)/2;add.append("path").attr("d","M "+c+" 13 L "+c+" 37 M "+(c-12)+" 25 L "+(c+12)+" 25").style("stroke-width",6).style("stroke-linecap","round").style("stroke",scheme.s);new_page();if(model.sync()){}}function default_page(id){return{id:id?id:gmath.uid(),transform:{scale:1,rotate:0,translate:[0,0]},height:res[1],paths:[],terms:[]}}function default_tiny(id,i){return{id:id,index:i,y:0,height:t_scale(res[1])}}function t_touch(){return mtouch_events().frame(svg.node()).on("tap",function(d){dispatch.focus();t_tap(d)}).on("drag",function(d){dispatch.focus();t_drag(d)}).on("release",function(d){dispatch.focus();t_release(d)})}function new_page(){c_page=default_page();c_tiny=default_tiny(c_page.id,pages.length);pages.push(c_page);tinys.push(c_tiny);model.removeAllPaths();model.paths(c_page.paths);model.drawAllPaths();model.hideAllTerms();model.terms(c_page.terms);model.showAllTerms();dispatch.transform(c_page.transform);t_sel=t_gel.selectAll(".t_el").data(tinys);t_sel.enter().append("svg").classed("t_el",true).call(t_touch());t_sel.append("rect").attr("fill",scheme.q);t_sel.append("g").attr("transform"," translate ("+t_scale(-t_width)+", 0) scale("+t_scale()+")");t_sel.append("rect").classed("focus",true).attr("x",1).attr("y",1).attr("width",t_width-2).attr("stroke",scheme.p).attr("stroke-width",2).attr("fill","none").attr("display","none");t_progress=t_gel.selectAll(".t_progress").data(tinys);t_progress.enter().append("svg").classed("t_progress",true).attr("x",t_width+1);t_progress.append("rect").classed("bg",true).attr("width",4).attr("fill",scheme.t);t_progress.append("rect").classed("bar",true).attr("width",4).attr("height",t_scale(res[1])+4).attr("fill",scheme.p);size_tinys()}function switch_page(p){c_page.paths=model.paths();c_page.terms=model.terms();c_page=p;model.removeAllPaths();model.paths(c_page.paths);model.drawAllPaths();model.hideAllTerms();model.terms(c_page.terms);model.showAllTerms();dispatch.transform(c_page.transform);tinys.forEach(function(d){if(d.id===p.id){c_tiny=d}})}function a_tap(){new_page()}function t_tap(d){var pos=d3.event.finger.pos;pages.forEach(function(p){if(p.id===d.id){pos[1]=(pos[1]-d.y)/t_scale()-res[1]/2;var max=p.height-res[1];if(pos[1]>max)pos[1]=max;if(pos[1]<0)pos[1]=0;p.transform.translate=[0,pos[1]*-1];switch_page(p);size_tinys()}})}function t_drag(d){if(!dragging){dragging=true;focus_tiny(d);t_sel.sort(function(a,b){return a.id===d.id?1:-1});t_progress.sort(function(a,b){return a.id===d.id?1:-1});pages.forEach(function(p){if(p.id===d.id){switch_page(p)}})}d.y+=d3.event.finger.dy;d.y=d.y<-10?-10:d.y;t_sel.filter(function(e){return e.id===d.id}).attr("y",d.y);t_progress.filter(function(e){return e.id===d.id}).attr("y",d.y)}function t_release(d){if(dragging){var dIn=d.index;tinys.forEach(function(e){var eIn=e.index;if(d.id!==e.id){var y=e.y+e.height/2;if(eIn>dIn&&d.y>=y){e.index=eIn-1;d.index=eIn}if(eIn<dIn&&d.y<=y){e.index=eIn+1;d.index=d.index===dIn?eIn:d.index}}});tinys.sort(function(a,b){return a.index-b.index});size_tinys();dragging=false}}function focus_tiny(m){t_sel.selectAll(".focus").attr("display","none");t_sel.filter(function(d){return d.id===m.id}).select(".focus").attr("height",function(d){return d.height-2}).attr("display","block");t_progress.selectAll(".bar").attr("display","none");t_progress.filter(function(d){return d.id===m.id}).select(".bar").attr("display","block")}function size_tinys(){var ante=null,h=c_page.height,y=res[1]-c_page.transform.translate[1];c_tiny.height=t_scale(Math.max(y,h))+t_scale(50);tinys.forEach(function(d){d.y=ante?ante.y+ante.height+1:1;ante=d});t_sel.attr("y",function(d){return d.y}).attr("width",t_width).attr("height",function(d){return d.height}).select("rect").attr("x",0).attr("y",0).attr("width",t_width).attr("height",function(d){return d.height}).attr("stroke","none").attr("stroke-width",0);t_progress.attr("y",function(d){return d.y}).attr("height",function(d){return d.height}).select(".bg").attr("height",function(d){return d.height});t_progress.filter(function(d){return d.id===c_page.id}).select(".bar").attr("y",function(d){return-1*t_scale(c_page.transform.translate[1])});focus_tiny(c_tiny)}return d3.rebind(pi,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Pages=Pages;PageModel=function(){var dispatch=d3.dispatch("drawAll","draw","hideAll","removeAll","remove","showAll","update"),paths=[],terms=[],line=d3.svg.line(),current={},synced=false;var pageModel=function(){return this};pageModel.getDerivationLists=function(){return terms};pageModel.removeList=function(dl){console.log("removing DL=",DL=dl);terms.splice(terms.indexOf(dl),1);dl.svgg.remove()};pageModel.sync=function(server,room,name){if(arguments.length==0)return synced;if(!room)room="default";if(!name)name="default";synced=true;socket=io.connect(server);socket.on("connect",function(){console.log("connected!");socket.emit("join",room,name);socket.emit("get_client_list",room,function(clients){console.log(clients)})});socket.on("interaction",function(room,id,evt){if(evt.id===0){if(evt.type==="drawPath")pageModel.drawPath(evt.containerID,evt.pathModel,evt.uid);if(evt.type==="drawAllPaths")pageModel.drawAllPaths(evt.container,true);if(evt.type==="paths")paths=evt.paths;if(evt.type==="removeAllPaths")pageModel.removeAllPaths(evt.container,true);if(evt.type==="terms")terms.dls=evt.terms;if(evt.type==="updatePath")pageModel.updatePath(evt.pathModel,evt.selectionID,true)}else{info.terms[evt.id-1].view.interaction_handler[evt.type](evt)}});var Recorder=function(socket,id){this.socket=socket;this.id=id};Recorder.prototype.record=function(evt){evt.id=this.id;socket.emit("interaction",room,evt)};recorder=new Recorder(socket,0)};pageModel.paths=function(arg){if(arguments.length===0){return paths}paths=arg;if(synced){recorder.record({type:"paths",paths:paths})}return this};pageModel.terms=function(arg){if(arguments.length===0){return terms}terms=arg;if(synced){recorder.record({type:"terms",paths:terms})}return this};pageModel.drawAllPaths=function(container,remote){var drawFunction=function(_container){var els=_container.selectAll("path").data(paths,function(d){return d.id});els.enter().append("path");els.attr("d",function(d){return line(d.path)}).style("fill","none").style("stroke",function(d){return d.color}).style("stroke-width",function(d){return d.width}).style("opacity",1).style("stroke-linecap","round").style("stroke-linejoin","round");els.exit().remove()};if(container){drawFunction(container)}dispatch.drawAll(drawFunction);if(synced&&remote){recorder.record({type:"drawAllPaths",container:container})}return drawFunction};pageModel.drawPath=function(containerID,pathModel,remote){var container=d3.select("#"+containerID),id=remote?remote:gmath.uid();pathModel.id=id;paths.push(pathModel);var drawFunction=function(_container){_container.append("path").attr("id",id).attr("d",line(pathModel.path)+"Z").style("fill","none").style("stroke",pathModel.color).style("stroke-width",pathModel.width).style("opacity",1).style("stroke-linecap","round").style("stroke-linejoin","round");return id};dispatch.draw([drawFunction,pathModel]);if(synced&&!remote){recorder.record({type:"drawPath",containerID:containerID,pathModel:pathModel,uid:id})}return drawFunction(container)};pageModel.drawTerm=function(containerID,termModel,remote){var container=d3.select("#"+containerID),pos=termModel.position;try{termModel.term=new DerivationList(container.node(),termModel.expression,{pos:pos,page_model:pageModel})}catch(err){console.error(err);return err}termModel.id=termModel.term.getLastModel().options.id;var drawFunction=function(_container){var cloneFunction=function(){var id="#"+termModel.id,old=_container.selectAll(id);setTimeout(function(){var clones=container.selectAll(id);clones[0].forEach(function(d){var clone=d.cloneNode(true);_container.node().appendChild(clone)});old.remove()},1e3)};termModel.term.timeTree.addEventListener("change",cloneFunction);cloneFunction()};dispatch.draw([drawFunction]);terms.push(termModel)};pageModel.hideAllTerms=function(container){var hideFunction=function(_container){terms.forEach(function(d){var id=d.term.getLastModel().options.id;_container.selectAll("#"+id).style("display","none")})};if(container){hideFunction(container)}dispatch.hideAll(hideFunction)};pageModel.removeAllPaths=function(container,remote){var removeFunction=function(_container){_container.selectAll("path").remove()};if(container){removeFunction(container)}dispatch.removeAll(removeFunction);if(synced&&remote){recorder.record({type:"removeAllPaths",container:container})}return removeFunction};pageModel.removePath=function(container,index){if(index<0){index=paths.length+index}if(index<0){return false}paths.splice(index,1);var removeFunction=function(_container){_container.selectAll("path").filter(function(d,i){return i===index}).remove()};removeFunction(container);dispatch.remove(removeFunction)};pageModel.showAllTerms=function(container){var showFunction=function(_container){terms.forEach(function(d){var id=d.term.getLastModel().options.id;_container.selectAll("#"+id).style("display","inline")})};if(container){showFunction(container)}dispatch.showAll(showFunction)};pageModel.updatePath=function(pathModel,selectionID,remote){paths.forEach(function(d){if(d.id===selectionID){d.path=pathModel.path}});var selection=d3.select("#"+selectionID),updateFunction=function(_selection){_selection.attr("d",line(pathModel.path)).style("stroke",pathModel.color).style("stroke-wdith",pathModel.width)};updateFunction(selection);dispatch.update([updateFunction,pathModel]);if(synced&&!remote){recorder.record({type:"updatePath",pathModel:pathModel,selectionID:selectionID})}};return d3.rebind(pageModel,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.PageModel=PageModel;Download=function(scheme){var dispatch=d3.dispatch("download");var svg=null,button=null,pos=[0,0];var dl=function(container){svg=container;init();return this};dl.pos=function(_pos){pos=_pos;if(button){button.attr("x",pos[0]).attr("y",pos[1])}return this};var init=function(){button=svg.append("svg").attr("x",pos[0]).attr("y",pos[1]).on("click",function(){dispatch.download()});button.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",scheme.s);button.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5)").style("stroke",scheme.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};return d3.rebind(dl,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Download=Download;Upload=function(scheme){var dispatch=d3.dispatch("upload","focus");var svg=null,button=null,pos=[0,0];var ul=function(container){svg=container;init();return this};ul.pos=function(_pos){pos=_pos;if(button){button.attr("x",pos[0]).attr("y",pos[1])}return this};var init=function(){d3.select("html").append("input").attr("id","upload").attr("type","file").style("display","none");d3.select("#upload").node().addEventListener("change",fileSelect);button=svg.append("svg").attr("x",pos[0]).attr("y",pos[1]).on("click",function(){dispatch.focus();upload()});button.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",scheme.s);button.append("path").attr("d","M 35 10 L 35 50 L 15 50 L 50 90 L 85 50 L 65 50 L 65 10 L 35 10 Z").attr("transform","scale(0.5) rotate(180 50 50)").style("stroke",scheme.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none")};var fileSelect=function(evt){var file=evt.target.files[0];if(!file.name.match(/\.json$/)){console.log("Uploading requires a .JSON file.");return}else{var reader=new FileReader;reader.onload=function(f){return function(e){dispatch.upload(JSON.parse(e.target.result))}}(file);reader.readAsText(file)}};var upload=function(){d3.select("#upload").node().click()};return d3.rebind(ul,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Upload=Upload;Undo=function(scheme){var dispatch=d3.dispatch("undo");var svg=null,button=null,pos=[0,0];var un=function(container){svg=container;init();return this};un.pos=function(_pos){pos=_pos;if(button){button.attr("x",pos[0]).attr("y",pos[1])}return this};var init=function(){button=svg.append("svg").attr("x",pos[0]).attr("y",pos[1]).on("click",function(){dispatch.undo()});button.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",scheme.s);button.append("path").attr("d","M 15 50 Q 15 85 50 85 Q 85 85 85 50 Q 85 15 50 15").attr("transform","scale(0.5)").style("stroke",scheme.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill","none");button.append("path").attr("d","M 50 10 L 50 20 L 40 15 L 50 10 Z").attr("transform","scale(0.5)").style("stroke",scheme.q).style("stroke-width","6").style("stroke-linejoin","round").style("stroke-linecap","round").style("fill",scheme.q)};return d3.rebind(un,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Undo=Undo;Scroll=function(scheme,canvas){var dispatch=d3.dispatch("focus","scroll");var svg=null,track=null,bar=null,pos=[0,0],scrolling=false,scroll_y=42,scroll_loop=null,autorelease=false;var sb=function(container){svg=container;init();return this};sb.pos=function(_pos){pos=_pos;if(track){track.attr("x",pos[0]).attr("y",pos[1])}return this};var init=function(){var mtouch=mtouch_events().frame(svg.node()).on("drag",function(){dispatch.focus();bar_drag()}).on("release",bar_release).call(canvas.tg());track=svg.append("svg").attr("x",pos[0]).attr("y",pos[1]);track.append("rect").attr("width",50).attr("height",84).attr("fill","none");track.append("rect").attr("x",20).attr("y",2).attr("width",10).attr("height",80).attr("rx",5).attr("ry",5).attr("fill",scheme.s);bar=track.append("circle").attr("cx",25).attr("cy",42).attr("r",15).attr("fill",scheme.q).attr("stroke",scheme.s).attr("stroke-width",3).call(mtouch)};var distance=function(a,b){return Math.pow(Math.pow(b[0]-a[0],2)+Math.pow(b[1]-a[1],2),.5)};var bar_drag=function(){var f_pos=d3.event.finger.pos.slice();if(distance(f_pos,pos)>200&&autorelease){bar_release()}else{scroll_y=f_pos[1]-pos[1];if(scroll_y<17)scroll_y=17;if(scroll_y>67)scroll_y=67;bar.attr("cy",scroll_y)}if(!scrolling){scrolling=true;scroll_loop=setInterval(function(){var delta=42-scroll_y,ct=canvas.getTranslate(),cx=ct[0],cy=ct[1]+delta;if(cy>0)cy=0;canvas.setTransform({translate:[cx,cy]});dispatch.scroll([cx,cy])},20)}};var bar_release=function(){bar.attr("cy",42);scrolling=false;clearInterval(scroll_loop)};return d3.rebind(sb,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.Scroll=Scroll;HWR=function(scheme){var dispatch=d3.dispatch("hwr");var svg=null,button=null,pos=[0,0],state=true,animating=false;var hwr=function(container){svg=container;init();return this};hwr.pos=function(arg){if(!arguments.length)return pos;pos=arg.slice();if(button)button.attr("transform","translate("+pos+")");return hwr};hwr.animating=function(arg){if(!arguments.length)return animating;if(animating===arg)return hwr;animating=arg;if(animating)button.call(wobble);else button.interrupt().attr("transform","translate("+pos+")").transition();return hwr};var wobble=function(sel){var bbox=sel.node().getBBox();var dpos=" "+bbox.width/2+" "+bbox.height/2;sel.transition().duration(100).attr("transform","translate("+pos+")rotate(-5"+dpos+")").each("end",repeat);function repeat(){sel.transition().duration(200).attr("transform","translate("+pos+")rotate(5"+dpos+")").transition().duration(200).attr("transform","translate("+pos+")rotate(-5"+dpos+")").each("end",repeat)}};hwr.state=function(arg){if(!arguments.length)return state;state=arg;if(button){button.select("rect").attr("fill",state?scheme.s:scheme.t)}dispatch.hwr(state);return hwr};hwr.toggle=function(){hwr.state(!state)};var init=function(){button=svg.append("g").attr("transform","translate("+pos+")").on("click",hwr.toggle).style("cursor","pointer");button.append("rect").attr("width",50).attr("height",50).attr("rx",5).attr("ry",5).attr("fill",state?scheme.s:"silver");button.append("text").text("HWR").attr("x",25).attr("y",30).attr("font-family","arial").attr("text-anchor","middle").attr("fill",scheme.q)};return d3.rebind(hwr,dispatch,"on")};gmath.ui=gmath.ui||{};gmath.ui.HWR=HWR;Main=function(){var width=1280,height=720,c_id=null,c_sel=null,schemes=[{p:"#84BF41",s:"#D0E4B9",t:"silver",q:"white"},{p:"#84BF41",s:"gainsboro",t:"silver",q:"white"},{p:"#D0E4B9",s:"#84BF41",t:"silver",q:"white"}],scheme=0;var svg=d3.select("body").append("svg").attr("width",width).attr("height",height).style("border","1px solid "+schemes[scheme].t).style("margin-left","auto").style("margin-right","auto").style("display","block");pageModel=gmath.ui.PageModel().on("drawAll",function(d){d(canvas.getPathG())}).on("draw",function(d){var applied=d[0](pages.selectTiny());c_id=applied?applied:c_id;c_sel=applied?d3.select("#"+c_id):c_sel;var paths_bbox=canvas.getPathG().node().getBBox(),terms_bbox=canvas.getTermG().node().getBBox();pages.selectPage().height=Math.max(paths_bbox.height+paths_bbox.y,terms_bbox.height+terms_bbox.y);pages.sizeTinys()}).on("hideAll",function(d){d(canvas.getTermG())}).on("removeAll",function(d){d(canvas.getPathG())}).on("remove",function(d){d(pages.selectTiny())}).on("showAll",function(d){d(canvas.getTermG())}).on("update",function(d){d[0](c_sel);var bbox=canvas.getPathG().node().getBBox();pages.selectPage().height=bbox.height+bbox.y;pages.sizeTinys()});pages=gmath.ui.Pages(pageModel,schemes[scheme]).on("transform",function(d){canvas.setTransform(d)}).on("focus",function(){canvas.cancelHWR()});canvas=gmath.ui.Canvas(pageModel,schemes[scheme]).width(width).height(height).offset(103).on("transform",function(d){pages.selectPage().transform=d;pages.sizeTinys()}).on("erase",function(r,d){r(pages.selectTiny());d(pages.selectTiny())}).on("start_hwr",function(){hwr.animating(true)}).on("stop_hwr",function(){hwr.animating(false)});markers=gmath.ui.Markers(schemes[scheme]).pos([398,603]).on("eraser",function(r){canvas.mode("erase");canvas.eraserRadius(r)}).on("marker",function(col,r){canvas.mode("draw");canvas.markerRadius(r);canvas.color(col)}).on("focus",function(){canvas.cancelHWR()});download=gmath.ui.Download(schemes[scheme]).pos([1211,20]).on("download",function(){canvas.cancelHWR();
pages.download()});upload=gmath.ui.Upload(schemes[scheme]).pos([1211,75]).on("upload",function(d){pages.upload(d)}).on("focus",function(){canvas.cancelHWR()});undo=gmath.ui.Undo(schemes[scheme]).pos([1211,130]).on("undo",function(d){canvas.undo()});scroll=gmath.ui.Scroll(schemes[scheme],canvas).pos([1211,185]).on("scroll",function(d){pages.selectPage().transform={translate:d};pages.sizeTinys()}).on("focus",function(){canvas.cancelHWR()});hwr=gmath.ui.HWR(schemes[scheme]).pos([1211,652]).on("hwr",function(d){canvas.HWRecognition(d)});svg.append("g").call(canvas).call(markers).call(pages).call(pageModel).call(download).call(upload).call(undo).call(scroll).call(hwr)};tryGMCreate=function(location,text,width,height){var has_tfrac=text.indexOf("tfrac")!==-1;var svg=location.insert("svg",".mwe-math-fallback-png-inline").style("overflow","visible").style({width:width,height:height}),options={font_size:20,h_align:"left",v_align:"top",background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},color:"green",pos:[0,0],id:gmath.uid(),eq:text,standalone:true,no_handles:true,no_history:true,fraction_size_factor:has_tfrac?.7:1};var dl=new DerivationList(svg.node(),text,options);var adapt_size=function(event){var dl=event.target;var bbox=dl.getLastView().getBBox();dl.svg.style({width:bbox.width+"px",height:bbox.height+"px"})};dl.addEventListener("change",adapt_size);adapt_size({target:dl})};GMify=function(addBanner){if(addBanner){var bannerDiv=d3.select("html").append("div").attr("id","gmbanner").style("width","100%").style("height","99px").style("background-color","rgba(245, 245, 245, 1.0)").style("border-bottom","1px green solid").style("position","absolute").style("top",-100).style("left",0).style("z-index",9999);var center=bannerDiv.append("center");center.append("img").attr("src","http://graspingmath.com/demos/wiki/minilogo.png").style("margin-top","15px");center.append("p").text("Grasping Math").style("color","green").style("font-family","cambria").style("font-size","36px").style("vertical-align","-16px").style("text-shadow","1px 1px silver").style("display","inline");var i=0;var slideDownInterval=setInterval(function(){i+=2;bannerDiv.style("top",i-100+"px");if(i===100){clearInterval(slideDownInterval)}},1);var slideUpTimer=setTimeout(function(){i=0;var slideUpInterval=setInterval(function(){i+=1;bannerDiv.style("top",-i+"px");if(i===100){clearInterval(slideUpInterval)}},2);clearTimeout(slideUpTimer)},4e3)}var codeSnippets=d3.selectAll("code");codeSnippets.each(function(){var snippet=d3.select(this);var snippetText=snippet.html();console.log(snippetText);try{snippet.html("");tryGMCreate(snippet,snippetText,"200px","100px")}catch(err){console.log("caught error:",err);console.log("Could not convert code snippet. Tried:",snippetText);console.log(snippet.node());console.log("")}});var eq_els=d3.selectAll(".mwe-math-fallback-png-inline");eq_els.each(function(){var img=d3.select(this),exp=img.attr("alt");var convertible=exp.search(/\\begin|\\det|\\overrightarrow|\\cdots|\\cup|\\mid|\\in|_/);if(convertible!==-1){console.log("cant parse",exp);return}exp=exp.replace(/\s/g,"");exp=exp.replace(/\\,|\\$|[,.]|/g,"");var has_tfrac=exp.indexOf("tfrac")!==-1;exp=exp.replace(/\\tfrac/g,"\\frac");try{var svg=d3.select(this.parentNode).insert("svg",".mwe-math-fallback-png-inline").style("overflow","visible").style({width:img.style("width"),height:img.style("height")}),options={font_size:20,h_align:"left",v_align:"top",background_color:"none",border_color:"none",history:false,padding:{left:0,right:0,top:0,bottom:0},color:"green",pos:[0,0],id:gmath.uid(),eq:exp,standalone:true,no_handles:true,no_history:true,fraction_size_factor:has_tfrac?.7:1};var dl=new DerivationList(svg.node(),exp,options);var adapt_size=function(event){var dl=event.target;var bbox=dl.getLastView().getBBox();dl.svg.style({width:bbox.width+"px",height:bbox.height+"px"})};dl.addEventListener("change",adapt_size);adapt_size({target:dl});img.remove()}catch(err){console.log("caught error:",err);console.log("Could not convert img with alt text:",img.attr("alt"),", tried:",exp);console.log(img.node());console.log("");svg.remove()}});return true};gmath.Tree=Tree;if(typeof module==="object"&&module.exports){module.exports=gmath}else{this.gmath=gmath}})();